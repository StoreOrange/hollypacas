{% extends "base.html" %}
{% block content %}
<style>
  .stock-detail-trigger { cursor: pointer; }
  .stock-detail-trigger:hover { filter: brightness(0.96); }
</style>
<div id="layout" class="min-h-screen grid lg:grid-cols-[260px_1fr] bg-surface">
  {% include "partials/sidebar.html" %}

  <main class="p-4 p-lg-5">
    <div class="container-fluid">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
        <div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
              <li class="breadcrumb-item"><a href="/inventory">Inventarios</a></li>
              <li class="breadcrumb-item active" aria-current="page">Mi inventario en caliente</li>
            </ol>
          </nav>
          <h1 class="h5 mb-1">Mi inventario en caliente</h1>
          <p class="text-muted mb-0">Vista en vivo con existencias y precio en C$ por defecto.</p>
        </div>
        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-outline-secondary btn-sm d-inline-flex d-lg-none" href="/home">
            <i class="bi bi-house-door"></i>
            Inicio
          </a>
          <button id="toggle-currency" class="btn btn-outline-primary btn-sm" type="button">
            Ver en C$
          </button>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <form class="row g-2 align-items-center" method="get" action="/inventory/caliente">
            <div class="col-lg-6">
              <div class="input-group input-group-sm">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input
                  class="form-control"
                  name="q"
                  placeholder="Buscar por codigo o nombre"
                  value="{{ q }}"
                  hx-get="/inventory/caliente"
                  hx-target="#inventory-grid"
                  hx-push-url="true"
                  hx-trigger="keyup changed delay:300ms"
                  hx-include="[name='scope']"
                />
              </div>
            </div>
            <div class="col-lg-4 d-flex flex-wrap gap-2 align-items-center">
              {% if scope_options|length > 1 %}
              <div class="btn-group btn-group-sm" role="group" aria-label="Alcance de bodega">
                {% for opt in scope_options %}
                <input type="radio" class="btn-check" name="scope" id="scope-{{ loop.index }}" value="{{ opt.value }}" autocomplete="off" {% if scope_param == opt.value %}checked{% endif %}
                  hx-get="/inventory/caliente"
                  hx-target="#inventory-grid"
                  hx-push-url="true"
                  hx-trigger="change"
                  hx-include="[name='q']"
                />
                <label class="btn btn-outline-primary" for="scope-{{ loop.index }}">
                  {{ opt.label }}
                </label>
                {% endfor %}
              </div>
              {% else %}
              <span class="badge bg-light text-primary border border-primary-subtle">
                {{ current_scope_label }}
              </span>
              {% endif %}
            </div>
            <div class="col-auto text-muted small">
              {% if rate_today %}
              Tasa: C$ {{ "%.4f"|format(rate_today.rate or 0) }}
              {% else %}
              Tasa no configurada
              {% endif %}
            </div>
          </form>
        </div>
      </div>

      <div id="inventory-grid">
        {% include "inventory_caliente_grid.html" %}
      </div>
    </div>
  </main>
</div>

<div class="modal fade" id="stock-detail-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="stock-detail-title">Detalle de variantes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="stock-detail-meta" class="small text-muted mb-2"></div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Codigo variante</th>
                <th>Color</th>
                <th>Talla</th>
                <th class="text-end">Existencia</th>
                <th>Detalle bodega</th>
              </tr>
            </thead>
            <tbody id="stock-detail-body">
              <tr><td colspan="5" class="text-center text-muted py-2">Sin datos</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const toggle = document.getElementById("toggle-currency");
    const inventoryGrid = document.getElementById("inventory-grid");
    const modalEl = document.getElementById("stock-detail-modal");
    const modalTitle = document.getElementById("stock-detail-title");
    const modalMeta = document.getElementById("stock-detail-meta");
    const modalBody = document.getElementById("stock-detail-body");
    const modal = (window.bootstrap && modalEl) ? window.bootstrap.Modal.getOrCreateInstance(modalEl) : null;
    const defaultScope = "{{ scope_param }}";
    let showCs = {{ default_show_cs|tojson }};

    const applyToggle = () => {
      document.querySelectorAll(".price-usd").forEach((el) => {
        el.classList.toggle("d-none", showCs);
      });
      document.querySelectorAll(".price-cs").forEach((el) => {
        el.classList.toggle("d-none", !showCs);
      });
      toggle.textContent = showCs ? "Ver en USD" : "Ver en C$";
    };

    const currentScope = () => {
      const checked = document.querySelector("input[name='scope']:checked");
      return (checked && checked.value) ? checked.value : (defaultScope || "");
    };

    const openStockDetail = async (btn) => {
      const productId = btn?.dataset?.productId;
      if (!productId) return;
      const code = btn.dataset.productCode || "";
      const name = btn.dataset.productName || "";
      if (modalTitle) modalTitle.textContent = `Detalle variantes: ${code}`;
      if (modalMeta) modalMeta.textContent = name;
      if (modalBody) modalBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-2">Cargando...</td></tr>`;
      if (modal) modal.show();
      try {
        const resp = await fetch(`/inventory/caliente/${encodeURIComponent(productId)}/variantes?scope=${encodeURIComponent(currentScope())}`, {
          headers: { "X-Requested-With": "fetch" },
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const items = Array.isArray(data.items) ? data.items : [];
        if (!items.length) {
          if (modalBody) modalBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-2">Sin existencias por talla/color para el alcance seleccionado.</td></tr>`;
          return;
        }
        if (modalBody) {
          modalBody.innerHTML = "";
          items.forEach((row) => {
            const detail = Array.isArray(row.detalle_bodega) && row.detalle_bodega.length
              ? row.detalle_bodega.map((d) => `${d.bodega}: ${Number(d.qty || 0).toFixed(2)}`).join(" | ")
              : "-";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.cod_variante || ""}</td>
              <td>${row.color || ""}</td>
              <td>${row.talla || ""}</td>
              <td class="text-end">${Number(row.existencia || 0).toFixed(2)}</td>
              <td>${detail}</td>
            `;
            modalBody.appendChild(tr);
          });
        }
        if (modalMeta) {
          modalMeta.textContent = `${name} | Total en variantes: ${Number(data.total || 0).toFixed(2)}`;
        }
      } catch (err) {
        const msg = err && err.message ? err.message : "sin detalle";
        if (modalBody) modalBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-2">Error al cargar detalle (${msg})</td></tr>`;
      }
    };

    if (toggle) {
      toggle.addEventListener("click", () => {
        showCs = !showCs;
        applyToggle();
      });
    }

    const onTrigger = (event) => {
      const trigger = event.target.closest(".stock-detail-trigger");
      if (!trigger) return;
      event.preventDefault();
      openStockDetail(trigger);
    };
    inventoryGrid?.addEventListener("click", onTrigger);
    document.addEventListener("click", onTrigger);
    document.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      const trigger = event.target.closest(".stock-detail-trigger");
      if (!trigger) return;
      event.preventDefault();
      openStockDetail(trigger);
    });

    document.body.addEventListener("htmx:afterSwap", (e) => {
      if (e.target && e.target.id === "inventory-grid") {
        applyToggle();
      }
    });

    applyToggle();
  })();
</script>
{% endblock %}
