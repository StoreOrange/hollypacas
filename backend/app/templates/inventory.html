{% extends "base.html" %}
{% block content %}
<div id="layout" class="min-h-screen grid lg:grid-cols-[260px_1fr] bg-surface">
  {% include "partials/sidebar.html" %}

  <main class="p-6 lg:p-8 text-[18px]">
    <div class="odoo-page">
      <div class="odoo-header">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 position-relative">
          <div>
            <button class="toggle-sidebar sidebar-toggle-show btn btn-sm btn-outline-secondary mb-2" type="button">
              <i class="bi bi-layout-sidebar"></i>
              Mostrar menu
            </button>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item">Inventario</li>
                <li class="breadcrumb-item active" aria-current="page">Catalogo</li>
              </ol>
            </nav>
            <div class="odoo-title mt-2">Catalogo de productos</div>
            <div class="odoo-subtitle mt-1">
              Administra productos, precios, costos y existencia.
              {% if inventory_cs_only %}<span class="text-brand">Modo C$ activo.</span>{% endif %}
            </div>
          </div>
          <div class="odoo-toolbar">
            <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden bg-white">
              <span class="input-group-text bg-white border-0"><i class="bi bi-search"></i></span>
              <input id="filter-input" class="form-control border-0" type="text" placeholder="Filtrar por codigo, nombre o precio" />
            </div>
            <a class="btn btn-outline-secondary btn-sm shadow-sm" href="/inventory">
              <i class="bi bi-eraser"></i>
              Limpiar
            </a>
            {% if rate_today %}
            <span class="odoo-pill primary">
              <i class="bi bi-currency-exchange"></i>
              C$ {{ "%.4f"|format(rate_today.rate) }}
            </span>
            {% endif %}
          </div>
        </div>
        <ul class="nav nav-tabs mt-3">
          <li class="nav-item">
            <a class="nav-link active" href="/inventory">Catalogo de productos</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/inventory/ingresos">Ingresos de inventario</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/inventory/egresos">Egresos de inventario</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/inventory/traslados-rapidos">Traslados rapidos</a>
          </li>
        </ul>
      </div>

      <div class="odoo-kpis">
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-box-seam text-blue-600"></i>
            Productos
          </div>
          <strong>{{ productos|length }}</strong>
        </div>
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-diagram-3 text-emerald-600"></i>
            Lineas
          </div>
          <strong>{{ lineas|length }}</strong>
        </div>
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-collection text-violet-600"></i>
            Segmentos
          </div>
          <strong>{{ segmentos|length }}</strong>
        </div>
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-currency-exchange text-rose-600"></i>
            Tasa del dia
          </div>
          <strong>
            {% if rate_today %}
              C$ {{ "%.4f"|format(rate_today.rate) }} por $1
            {% else %}
              No configurada
            {% endif %}
          </strong>
        </div>
      </div>

      <div class="odoo-kpis">
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-building text-sky-600"></i>
            Central (items / saldo)
          </div>
          <strong>{{ central_items|default(0) }} / {{ "%.2f"|format(central_qty|default(0)) }}</strong>
        </div>
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-geo-alt text-indigo-600"></i>
            Esteli (items / saldo)
          </div>
          <strong>{{ esteli_items|default(0) }} / {{ "%.2f"|format(esteli_qty|default(0)) }}</strong>
        </div>
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-diagram-2 text-emerald-600"></i>
            Global (items / saldo)
          </div>
          <strong>{{ global_items|default(0) }} / {{ "%.2f"|format(global_qty|default(0)) }}</strong>
        </div>
      </div>

    {% if error %}
    <div class="mt-4 rounded-xl border border-red-200 bg-red-50 text-red-700 px-4 py-2" data-error-banner>
      {{ error }}
    </div>
    {% endif %}
    {% if success %}
    <div class="mt-4 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-700 px-4 py-2" data-success-banner>
      {{ success }}
    </div>
    {% endif %}

    <div class="odoo-card mt-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
        <div>
          <div class="odoo-section-title">Carga masiva (Excel)</div>
          <div class="text-sm text-slate">Importa productos y saldos por bodega usando la plantilla oficial.</div>
        </div>
        <a class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-2" href="/inventory/import/template">
          <i class="bi bi-download"></i>
          Descargar plantilla
        </a>
      </div>
      <form class="d-flex flex-wrap align-items-center gap-3" method="post" action="/inventory/import" enctype="multipart/form-data">
        <input name="file" type="file" accept=".xlsx" class="form-control form-control-sm" required />
        <button class="btn btn-primary btn-sm d-inline-flex align-items-center gap-2" type="submit">
          <i class="bi bi-upload"></i>
          Importar Excel
        </button>
      </form>
      <div class="text-xs text-slate mt-2">
        Columnas: codigo, descripcion, linea, segmento, costo_usd, precio_usd, precio_cs, saldo_central, saldo_esteli.
      </div>
    </div>

    <div class="odoo-card">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
        <div class="odoo-section-title">Productos</div>
        <div class="d-flex flex-wrap align-items-center gap-2">
          <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
            <span class="input-group-text bg-white border-0"><i class="bi bi-funnel"></i></span>
            <input id="filter-input-panel" class="form-control border-0" type="text" placeholder="Filtrar en panel" />
          </div>
          <form method="get" action="/inventory" class="d-flex align-items-center gap-2 text-sm text-slate">
            <label class="d-inline-flex align-items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                name="show_inactive"
                value="1"
                class="sr-only peer"
                onchange="this.form.submit()"
                {% if show_inactive %}checked{% endif %}
              />
              <span class="w-10 h-5 bg-slate-200 rounded-full peer-checked:bg-brand position-relative transition-colors">
                <span class="position-absolute top-50 translate-middle-y left-0.5 w-4 h-4 rounded-full bg-white shadow-sm transition-transform peer-checked:translate-x-5"></span>
              </span>
              <span class="d-inline-flex align-items-center gap-2">
                <i class="bi bi-eye text-brand"></i>
                Mostrar inactivos
              </span>
            </label>
          </form>
          <button id="open-create-modal" class="btn btn-primary btn-sm shadow-sm" type="button">
            <i class="bi bi-plus-circle-fill"></i>
            Nuevo producto
          </button>
          <span class="odoo-pill success">
            <i class="bi bi-list-ul"></i>
            {{ productos|length }} registros
          </span>
        </div>
      </div>
      <div class="table-responsive">
        <table id="products-table" class="table table-striped table-sm align-middle inventory-table odoo-table" style="font-size: 13px;">
            <thead class="text-xs uppercase tracking-[0.15em] text-slate bg-slate-50">
              <tr>
                <th class="text-left px-4 py-3">
                  <span class="inline-flex items-center gap-2">
                    <i class="bi bi-upc-scan text-brand"></i>
                    Codigo
                  </span>
                </th>
                <th class="text-left px-4 py-3">
                  <span class="inline-flex items-center gap-2">
                    <i class="bi bi-card-text text-brand"></i>
                    Descripcion
                  </span>
                </th>
                <th class="text-left px-4 py-3">
                  <span class="inline-flex items-center gap-2">
                    <i class="bi bi-diagram-3 text-emerald-600"></i>
                    Linea
                  </span>
                </th>
                <th class="text-left px-4 py-3">
                  <span class="inline-flex items-center gap-2">
                    <i class="bi bi-collection text-violet-600"></i>
                    Segmento
                  </span>
                </th>
                {% if not inventory_cs_only %}
                <th class="text-right px-4 py-3">
                  <span class="inline-flex items-center gap-2">
                    <i class="bi bi-currency-dollar text-blue-600"></i>
                    Precio USD
                  </span>
                </th>
                {% endif %}
                <th class="text-right px-4 py-3">
                  <span class="inline-flex items-center gap-2">
                    <i class="bi bi-cash-coin text-sky-600"></i>
                    Precio C$
                  </span>
                </th>
                <th class="text-right px-4 py-3">
                  <span class="inline-flex items-center gap-2">
                    <i class="bi bi-stack text-amber-600"></i>
                    Existencia
                  </span>
                </th>
                <th class="text-center px-4 py-3">
                  <span class="inline-flex items-center gap-2">
                    <i class="bi bi-shield-check text-emerald-600"></i>
                    Estado
                  </span>
                </th>
                <th class="text-center px-4 py-3">
                  <span class="inline-flex items-center gap-2">
                    <i class="bi bi-gear text-slate-500"></i>
                    Acciones
                  </span>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for p in productos %}
              <tr
                class="product-row border-b border-slate-100 hover:bg-slate-50 cursor-pointer"
                data-code="{{ p.cod_producto }}"
                data-name="{{ p.descripcion }}"
                data-price="{{ p.precio_venta1 or 0 }}"
                data-id="{{ p.id }}"
                data-cod="{{ p.cod_producto }}"
                data-desc="{{ p.descripcion }}"
                data-linea-id="{{ p.linea_id or '' }}"
                data-segmento-id="{{ p.segmento_id or '' }}"
                data-precio1-usd="{% if inventory_cs_only %}{{ "%.2f"|format(p.precio_venta1 or 0) }}{% else %}{{ "%.2f"|format(p.precio_venta1_usd or 0) }}{% endif %}"
                data-precio2-usd="{% if inventory_cs_only %}{{ "%.2f"|format(p.precio_venta2 or 0) }}{% else %}{{ "%.2f"|format(p.precio_venta2_usd or 0) }}{% endif %}"
                data-precio3-usd="{% if inventory_cs_only %}{{ "%.2f"|format(p.precio_venta3 or 0) }}{% else %}{{ "%.2f"|format(p.precio_venta3_usd or 0) }}{% endif %}"
                data-costo-usd="{% if inventory_cs_only %}{{ "%.2f"|format(p.costo_producto or 0) }}{% elif p.tasa_cambio %}{{ "%.2f"|format((p.costo_producto or 0) / p.tasa_cambio) }}{% else %}0{% endif %}"
                data-existencia="{{ p.saldo.existencia if p.saldo else 0 }}"
                data-activo="{{ 1 if p.activo else 0 }}"
              >
                <td class="px-4 py-3 font-semibold text-ink">{{ p.cod_producto }}</td>
                <td class="px-4 py-3 text-slate">{{ p.descripcion }}</td>
                <td class="px-4 py-3 text-slate">{{ p.linea.linea if p.linea else "-" }}</td>
                <td class="px-4 py-3 text-slate">{{ p.segmento.segmento if p.segmento else "-" }}</td>
                {% if not inventory_cs_only %}
                <td class="px-4 py-3 text-right text-slate">$ {{ "%.2f"|format(p.precio_venta1_usd or 0) }}</td>
                {% endif %}
                <td class="px-4 py-3 text-right text-slate">C$ {{ "%.2f"|format(p.precio_venta1 or 0) }}</td>
                <td class="px-4 py-3 text-right text-slate">{{ p.saldo.existencia if p.saldo else 0 }}</td>
                <td class="px-4 py-3 text-center">
                  {% if p.activo %}
                  <span class="odoo-badge success">Activo</span>
                  {% else %}
                  <span class="odoo-badge danger">Inactivo</span>
                  {% endif %}
                </td>
                <td class="px-4 py-3 text-center">
                  <div class="inline-flex items-center gap-2">
                    {% if p.activo %}
                      {% if p.saldo and p.saldo.existencia > 0 %}
                      <button class="rounded-lg border border-slate-200 bg-slate-100 px-3 py-1.5 text-xs font-semibold text-slate" disabled>
                        <i class="bi bi-lock"></i>
                      </button>
                      {% else %}
                      <form method="post" action="/inventory/product/{{ p.id }}/deactivate">
                        <button class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-1.5 text-xs font-semibold text-brand">
                          <i class="bi bi-pause-circle"></i>
                        </button>
                      </form>
                      {% endif %}
                    {% else %}
                    <form method="post" action="/inventory/product/{{ p.id }}/activate">
                      <button class="rounded-lg border border-slate-200 bg-green-50 px-3 py-1.5 text-xs font-semibold text-green-700">
                        <i class="bi bi-play-circle"></i>
                      </button>
                    </form>
                    {% endif %}
                    <a class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-ink hover:bg-slate-50" href="/inventory?edit={{ p.id }}">
                      <i class="bi bi-pencil-square"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% if productos|length == 0 %}
            <tr>
              <td colspan="{% if inventory_cs_only %}8{% else %}9{% endif %}" class="text-center text-slate py-4">Sin productos registrados</td>
            </tr>
            {% endif %}
            </tbody>
          </table>
        </div>

      <div class="text-end text-slate text-sm mt-4">Version {{ version }}</div>
    </div>
  </div>
  </main>
</div>
<div id="inventory-modal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4 z-50">
  <div class="odoo-modal bg-white w-full max-w-6xl shadow-xl text-lg">
    <div class="odoo-modal-header flex items-center justify-between px-8 py-4 rounded-t-3xl">
      <div>
        <div class="odoo-breadcrumb">Inventario / Productos</div>
        <div id="modal-title" class="odoo-section-title text-lg">Nuevo producto</div>
        <div id="modal-subtitle" class="text-xs text-slate mt-1">Gestion de productos y catalogos</div>
      </div>
      <button id="close-modal" class="inline-flex items-center justify-center w-9 h-9 rounded-xl border border-slate-200 text-ink hover:bg-slate-50" type="button">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="px-8 pt-4">
      <div class="d-flex flex-wrap gap-2 odoo-tabs odoo-modal-tabs">
        <button class="modal-tab btn btn-sm btn-primary d-inline-flex align-items-center gap-2" data-target="tab-producto" type="button">
          <i class="bi bi-box-seam"></i>
          Producto
        </button>
        <button class="modal-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-combos" type="button">
          <i class="bi bi-gift"></i>
          Combos
        </button>
        <button class="modal-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-linea" type="button">
          <i class="bi bi-diagram-3"></i>
          Linea
        </button>
        <button class="modal-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-segmento" type="button">
          <i class="bi bi-collection"></i>
          Segmento
        </button>
        <button class="modal-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-linea-edit" type="button">
          <i class="bi bi-pencil-square"></i>
          Editar linea
        </button>
        <button class="modal-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-segmento-edit" type="button">
          <i class="bi bi-pencil-square"></i>
          Editar segmento
        </button>
        <button class="modal-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-import" type="button">
          <i class="bi bi-upload"></i>
          Importar
        </button>
      </div>
    </div>
    <div class="px-8 pb-6 pt-4 space-y-4 odoo-modal-body">
      <div id="tab-producto" class="modal-panel">
        <form id="product-form" class="space-y-3" method="post" action="/inventory/product">
          <div class="odoo-modal-section">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="odoo-modal-title">Ficha del producto</div>
              <span class="odoo-pill">Campos obligatorios *</span>
            </div>
            <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label odoo-field-label">Codigo *</label>
              <input id="field-codigo" name="cod_producto" class="form-control odoo-input" required />
            </div>
            <div class="col-md-6">
              <label class="form-label odoo-field-label">Descripcion *</label>
              <input id="field-descripcion" name="descripcion" class="form-control odoo-input" required />
            </div>
            <div class="col-md-6">
              <label class="form-label odoo-field-label">Linea</label>
              <select id="field-linea" name="linea_id" class="form-select odoo-input select2">
                <option value="">Selecciona</option>
                {% for linea in lineas %}
                <option value="{{ linea.id }}">{{ linea.linea }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label odoo-field-label">Segmento</label>
              <select id="field-segmento" name="segmento_id" class="form-select odoo-input select2">
                <option value="">Selecciona</option>
                {% for seg in segmentos %}
                <option value="{{ seg.id }}">{{ seg.segmento }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label odoo-field-label">Costo ({% if inventory_cs_only %}C${% else %}USD{% endif %})</label>
              <input id="field-costo" name="costo_producto_usd" type="number" step="0.01" class="form-control odoo-input" />
            </div>
            <div class="col-md-6">
              <label class="form-label odoo-field-label">% ganancia (entero)</label>
              <input id="field-margin" type="number" min="0" step="1" class="form-control odoo-input" placeholder="Ej: 25" />
            </div>
            <div class="col-md-6">
              <label class="form-label odoo-field-label">Precio 1 ({% if inventory_cs_only %}C${% else %}USD{% endif %})</label>
              <input id="field-precio1" name="precio_venta1_usd" type="number" step="0.01" class="form-control odoo-input" />
            </div>
            <div class="col-md-6">
              <label class="form-label odoo-field-label">Precio 2 ({% if inventory_cs_only %}C${% else %}USD{% endif %})</label>
              <input id="field-precio2" name="precio_venta2_usd" type="number" step="0.01" class="form-control odoo-input" />
            </div>
            <div class="col-md-6">
              <label class="form-label odoo-field-label">Precio 3 ({% if inventory_cs_only %}C${% else %}USD{% endif %})</label>
              <input id="field-precio3" name="precio_venta3_usd" type="number" step="0.01" class="form-control odoo-input" />
            </div>
            <div class="col-md-6">
              <div class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate h-100 d-flex align-items-center">
                Existencia actual:
                <span id="field-existencia" class="font-semibold text-ink ms-2">0</span>
              </div>
            </div>
            <div class="col-md-6 d-flex align-items-center">
              <label class="d-inline-flex align-items-center gap-2 text-sm fw-semibold text-ink">
                <input id="field-activo" class="accent-brand" type="checkbox" name="activo" checked />
                Activo
              </label>
            </div>
          </div>
          <div class="odoo-action-bar">
            <span class="odoo-help">Campos obligatorios *</span>
            <div class="d-flex align-items-center gap-2">
              <button id="cancel-edit" class="hidden btn btn-outline-secondary btn-sm" type="button">
                Cancelar edicion
              </button>
              <button id="save-product" class="btn btn-primary btn-sm d-inline-flex align-items-center gap-2" type="submit">
                <i class="bi bi-check2-circle"></i>
                Guardar
              </button>
            </div>
          </div>
        </form>
      </div>
      <div id="tab-combos" class="modal-panel hidden">
        <div class="odoo-modal-section">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="odoo-modal-title">Combos y regalias</div>
            <span class="odoo-pill">Configurar oferta</span>
          </div>
          <div id="combo-warning" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate">
            Guarda el producto y luego configura las regalias.
          </div>
          <div id="combo-editor" class="hidden">
            <div class="row g-3">
              <div class="col-md-7">
                <label class="form-label odoo-field-label">Regalia (producto)</label>
                <select id="combo-child-select" class="form-select odoo-input select2">
                  <option value="">Selecciona producto</option>
                  {% for p in productos %}
                  <option value="{{ p.id }}">{{ p.cod_producto }} - {{ p.descripcion }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label odoo-field-label">Cantidad</label>
                <input id="combo-child-qty" type="number" min="1" step="1" class="form-control odoo-input" value="1" />
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button id="combo-add-btn" class="btn btn-outline-primary btn-sm w-100" type="button">
                  <i class="bi bi-plus-circle"></i>
                  Agregar
                </button>
              </div>
            </div>
            <div class="mt-4">
              <div class="text-xs uppercase tracking-[0.2em] text-slate font-semibold">Regalias asignadas</div>
              <div id="combo-list" class="mt-2 space-y-2 text-sm"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="tab-linea" class="modal-panel hidden">
        <form class="space-y-3" method="post" action="/inventory/linea">
          <div class="text-sm text-slate">Codigo automatico</div>
          <input name="linea" class="w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="Linea" />
          <label class="flex items-center gap-2 text-sm text-slate">
            <input class="accent-brand" type="checkbox" name="activo" checked />
            Activo
          </label>
          <button class="w-full rounded-xl border border-emerald-200 bg-emerald-50 py-2 font-semibold text-emerald-900 hover:bg-emerald-100">
            Guardar linea
          </button>
        </form>
      </div>
      <div id="tab-segmento" class="modal-panel hidden">
        <form class="space-y-3" method="post" action="/inventory/segmento">
          <input name="segmento" class="w-full rounded-xl border border-slate-200 px-3 py-2" placeholder="Segmento" />
          <button class="w-full rounded-xl border border-violet-200 bg-violet-50 py-2 font-semibold text-violet-900 hover:bg-violet-100">
            Guardar segmento
          </button>
        </form>
      </div>
      <div id="tab-linea-edit" class="modal-panel hidden">
        <form id="linea-edit-form" class="space-y-3" method="post" action="/inventory/linea/0/update">
          <label class="block text-sm font-semibold text-ink">
            Selecciona linea *
            <select id="edit-linea-select" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 select2" required>
              <option value="">Selecciona</option>
              {% for linea in lineas %}
              <option value="{{ linea.id }}" data-linea="{{ linea.linea }}" data-activo="{{ 1 if linea.activo else 0 }}">{{ linea.linea }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="block text-sm font-semibold text-ink">
            Linea *
            <input id="edit-linea-name" name="linea" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2" required />
          </label>
          <label class="flex items-center gap-2 text-sm text-slate">
            <input id="edit-linea-activo" class="accent-brand" type="checkbox" name="activo" checked />
            Activo
          </label>
          <button class="w-full rounded-xl border border-emerald-200 bg-emerald-50 py-2 font-semibold text-emerald-900 hover:bg-emerald-100">
            Guardar cambios
          </button>
        </form>
      </div>
      <div id="tab-segmento-edit" class="modal-panel hidden">
        <form id="segmento-edit-form" class="space-y-3" method="post" action="/inventory/segmento/0/update">
          <label class="block text-sm font-semibold text-ink">
            Selecciona segmento *
            <select id="edit-segmento-select" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 select2" required>
              <option value="">Selecciona</option>
              {% for seg in segmentos %}
              <option value="{{ seg.id }}" data-segmento="{{ seg.segmento }}">{{ seg.segmento }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="block text-sm font-semibold text-ink">
            Segmento *
            <input id="edit-segmento-name" name="segmento" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2" required />
          </label>
          <button class="w-full rounded-xl border border-violet-200 bg-violet-50 py-2 font-semibold text-violet-900 hover:bg-violet-100">
            Guardar cambios
          </button>
        </form>
      </div>
      <div id="tab-import" class="modal-panel hidden">
        <p class="text-xs text-slate">
          Excel con columnas: codigo, descripcion, linea, segmento, costo_usd, precio_usd, precio_cs, saldo_central, saldo_esteli.
        </p>
        <a class="mt-3 inline-flex items-center gap-2 text-sm font-semibold text-sky-800" href="/inventory/import/template">
          <i class="bi bi-download"></i>
          Descargar plantilla Excel
        </a>
        <form class="mt-3 space-y-3" method="post" action="/inventory/import" enctype="multipart/form-data">
          <input name="file" type="file" accept=".xlsx" class="w-full rounded-xl border border-slate-200 px-3 py-2 bg-white text-sm" required />
          <button class="w-full rounded-xl border border-sky-200 bg-sky-50 py-2 font-semibold text-sky-900 hover:bg-sky-100 inline-flex items-center justify-center gap-2">
            <i class="bi bi-upload"></i>
            Importar Excel
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
  const layout = document.getElementById("layout");
  const toggles = document.querySelectorAll(".toggle-sidebar");
  if (layout && toggles.length) {
    toggles.forEach((toggle) => {
      toggle.addEventListener("click", () => {
        layout.classList.toggle("sidebar-collapsed");
      });
    });
  }

  const filterInput = document.getElementById("filter-input");
  const panelFilterInput = document.getElementById("filter-input-panel");
  let tableInstance = null;
  if (window.DataTable) {
    tableInstance = new DataTable("#products-table", {
      searching: true,
      paging: true,
      info: true,
      lengthChange: false,
      order: [[1, "asc"]],
      scrollX: false,
      autoWidth: true,
      language: {
        search: "Buscar:",
        lengthMenu: "Mostrar _MENU_",
        info: "Mostrando _START_ a _END_ de _TOTAL_",
        infoEmpty: "Sin registros",
        zeroRecords: "Sin coincidencias",
        paginate: {
          next: "Siguiente",
          previous: "Anterior",
        },
      },
      dom: "Bfrtip",
      buttons: ["copy", "excel", "pdf", "print"],
    });
  }
  const applySearch = (value) => {
    const term = value.toLowerCase().trim();
    if (tableInstance) {
      tableInstance.search(term).draw();
      return;
    }
    document.querySelectorAll("#products-table tbody tr").forEach((row) => {
      const payload = [
        row.dataset.code,
        row.dataset.name,
        row.dataset.price,
      ]
        .filter(Boolean)
        .join(" ")
        .toLowerCase();
      row.style.display = payload.includes(term) ? "" : "none";
    });
  };
  if (filterInput) {
    filterInput.addEventListener("input", (event) => applySearch(event.target.value));
  }
  if (panelFilterInput) {
    panelFilterInput.addEventListener("input", (event) => applySearch(event.target.value));
  }
  if (tableInstance) {
    tableInstance.on("draw", () => {
      const term = (tableInstance.search() || "").trim();
      const rows = document.querySelectorAll("#products-table tbody tr");
      rows.forEach((row) => {
        const cells = row.querySelectorAll("td");
        cells.forEach((cell, index) => {
          if (index > 6) return;
          const original = cell.dataset.original || cell.textContent;
          cell.dataset.original = original;
          if (!term) {
            cell.textContent = original;
            return;
          }
          const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          const regex = new RegExp(safeTerm, "gi");
          cell.innerHTML = original.replace(regex, (match) => `<mark class="hl">${match}</mark>`);
        });
      });
    });
    tableInstance.draw();
  }

  if (window.$ && $.fn.select2) {
    $(".select2").select2({
      width: "100%",
      placeholder: "Selecciona",
      allowClear: true,
    });
  }

  const modal = document.getElementById("inventory-modal");
  const openCreateModal = document.getElementById("open-create-modal");
  const closeModal = document.getElementById("close-modal");
  const modalTitle = document.getElementById("modal-title");
  const modalSubtitle = document.getElementById("modal-subtitle");
  const productForm = document.getElementById("product-form");
  const cancelEdit = document.getElementById("cancel-edit");
  const fieldCodigo = document.getElementById("field-codigo");
  const fieldDescripcion = document.getElementById("field-descripcion");
  const fieldLinea = document.getElementById("field-linea");
  const fieldSegmento = document.getElementById("field-segmento");
  const fieldPrecio1 = document.getElementById("field-precio1");
  const fieldPrecio2 = document.getElementById("field-precio2");
  const fieldPrecio3 = document.getElementById("field-precio3");
  const fieldCosto = document.getElementById("field-costo");
  const fieldMargin = document.getElementById("field-margin");
  const fieldExistencia = document.getElementById("field-existencia");
  const fieldActivo = document.getElementById("field-activo");
  const modalTabs = document.querySelectorAll(".modal-tab");
  const modalPanels = document.querySelectorAll(".modal-panel");
  const editLineaSelect = document.getElementById("edit-linea-select");
  const editLineaForm = document.getElementById("linea-edit-form");
  const editLineaName = document.getElementById("edit-linea-name");
  const editLineaActivo = document.getElementById("edit-linea-activo");
  const editSegmentoSelect = document.getElementById("edit-segmento-select");
  const editSegmentoForm = document.getElementById("segmento-edit-form");
  const editSegmentoName = document.getElementById("edit-segmento-name");
  const comboWarning = document.getElementById("combo-warning");
  const comboEditor = document.getElementById("combo-editor");
  const comboChildSelect = document.getElementById("combo-child-select");
  const comboChildQty = document.getElementById("combo-child-qty");
  const comboAddBtn = document.getElementById("combo-add-btn");
  const comboList = document.getElementById("combo-list");
  let currentProductId = null;

  const calculateAutoPrice = (costValue, marginValue) => {
    const cost = parseFloat(costValue || 0);
    const margin = parseInt(marginValue || 0, 10);
    if (!Number.isFinite(margin) || margin <= 0 || !Number.isFinite(cost) || cost <= 0) {
      return null;
    }
    const price = cost * (1 + (margin / 100));
    return price.toFixed(2);
  };

  const bindAutoPriceFromCost = () => {
    if (!fieldCosto || !fieldPrecio1 || !fieldMargin) return;
    const apply = () => {
      fieldMargin.value = (fieldMargin.value || "").replace(/\D+/g, "");
      const computed = calculateAutoPrice(fieldCosto.value, fieldMargin.value);
      if (computed !== null) {
        fieldPrecio1.value = computed;
      }
    };
    fieldCosto.addEventListener("input", apply);
    fieldCosto.addEventListener("change", apply);
    fieldMargin.addEventListener("input", apply);
    fieldMargin.addEventListener("change", apply);
  };
  bindAutoPriceFromCost();

  const openModal = () => {
    if (modal) {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }
  };

  const closeModalFn = () => {
    if (modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  };

  const setActiveTab = (targetId) => {
    modalTabs.forEach((tab) => {
      const active = tab.dataset.target === targetId;
      tab.classList.toggle("btn-primary", active);
      tab.classList.toggle("btn-outline-secondary", !active);
    });
    modalPanels.forEach((panel) => {
      panel.classList.toggle("hidden", panel.id !== targetId);
    });
    if (targetId === "tab-combos") {
      refreshComboPanel();
    }
  };

  const resetProductForm = () => {
    if (!productForm) return;
    currentProductId = null;
    productForm.action = "/inventory/product";
    fieldCodigo.disabled = false;
    fieldCodigo.value = "";
    fieldDescripcion.value = "";
    fieldLinea.value = "";
    fieldSegmento.value = "";
    fieldPrecio1.value = "";
    fieldPrecio2.value = "";
    fieldPrecio3.value = "";
    fieldCosto.value = "";
    if (fieldMargin) fieldMargin.value = "";
    fieldExistencia.textContent = "0";
    fieldActivo.checked = true;
    cancelEdit.classList.add("hidden");
    modalTitle.textContent = "Nuevo producto";
    modalSubtitle.textContent = "Gestion de productos y catalogos";
    setActiveTab("tab-producto");
  };

  const fillProductForm = (row) => {
    const productId = row.dataset.id;
    currentProductId = productId;
    productForm.action = `/inventory/product/${productId}/update`;
    fieldCodigo.disabled = true;
    fieldCodigo.value = row.dataset.cod || "";
    fieldDescripcion.value = row.dataset.desc || "";
    fieldLinea.value = row.dataset.lineaId || "";
    fieldSegmento.value = row.dataset.segmentoId || "";
    fieldPrecio1.value = row.dataset.precio1Usd || "";
    fieldPrecio2.value = row.dataset.precio2Usd || "";
    fieldPrecio3.value = row.dataset.precio3Usd || "";
    fieldCosto.value = row.dataset.costoUsd || "";
    fieldExistencia.textContent = row.dataset.existencia || "0";
    fieldActivo.checked = row.dataset.activo === "1";
    cancelEdit.classList.remove("hidden");
    modalTitle.textContent = `Editar producto ${row.dataset.cod || ""}`;
    modalSubtitle.textContent = "Actualiza los datos y guarda los cambios";
    setActiveTab("tab-producto");
  };

  const refreshComboPanel = async () => {
    if (!comboWarning || !comboEditor || !comboList) return;
    if (!currentProductId) {
      comboWarning.classList.remove("hidden");
      comboEditor.classList.add("hidden");
      comboList.innerHTML = "";
      return;
    }
    comboWarning.classList.add("hidden");
    comboEditor.classList.remove("hidden");
    comboList.innerHTML = "<div class='text-slate text-sm'>Cargando...</div>";
    try {
      const response = await fetch(`/inventory/product/${currentProductId}/combo`);
      const payload = await response.json();
      if (!payload.ok) {
        comboList.innerHTML = `<div class='text-danger text-sm'>${payload.message || "No se pudo cargar"}</div>`;
        return;
      }
      if (!payload.items.length) {
        comboList.innerHTML = "<div class='text-slate text-sm'>Sin regalias asignadas.</div>";
        return;
      }
      comboList.innerHTML = payload.items
        .map((item) => {
          return `
            <div class="d-flex align-items-center justify-content-between border border-slate-200 rounded-2xl px-3 py-2 bg-white">
              <div>
                <div class="font-semibold text-ink">${item.cod_producto} - ${item.descripcion}</div>
                <div class="text-xs text-slate">Cantidad: ${Number(item.cantidad || 0).toFixed(0)}</div>
              </div>
              <button class="btn btn-outline-danger btn-sm combo-remove" data-id="${item.id}" type="button">
                <i class="bi bi-trash"></i>
                Quitar
              </button>
            </div>
          `;
        })
        .join("");
    } catch (error) {
      comboList.innerHTML = "<div class='text-danger text-sm'>Error al cargar combos.</div>";
    }
  };

  if (comboAddBtn) {
    comboAddBtn.addEventListener("click", async () => {
      if (!currentProductId) return;
      const childId = comboChildSelect?.value;
      const qtyValue = parseFloat(comboChildQty?.value || 0);
      if (!childId || qtyValue <= 0) {
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "warning", title: "Datos incompletos", text: "Selecciona regalia y cantidad." });
        }
        return;
      }
      try {
        const formData = new FormData();
        formData.append("child_id", childId);
        formData.append("cantidad", qtyValue.toFixed(2));
        const response = await fetch(`/inventory/product/${currentProductId}/combo`, {
          method: "POST",
          body: formData,
        });
        const payload = await response.json();
        if (!payload.ok) {
          if (typeof Swal !== "undefined") {
            Swal.fire({ icon: "error", title: "Error", text: payload.message || "No se pudo guardar" });
          }
          return;
        }
        if (comboChildSelect) comboChildSelect.value = "";
        if (comboChildQty) comboChildQty.value = "1";
        if (window.$ && $.fn.select2 && comboChildSelect) {
          $(comboChildSelect).val(null).trigger("change");
        }
        await refreshComboPanel();
      } catch (error) {
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "error", title: "Error", text: "No se pudo guardar" });
        }
      }
    });
  }

  if (comboList) {
    comboList.addEventListener("click", async (event) => {
      const button = event.target.closest(".combo-remove");
      if (!button || !currentProductId) return;
      const comboId = button.dataset.id;
      try {
        const response = await fetch(`/inventory/product/${currentProductId}/combo/${comboId}/delete`, {
          method: "POST",
        });
        const payload = await response.json();
        if (!payload.ok) {
          if (typeof Swal !== "undefined") {
            Swal.fire({ icon: "error", title: "Error", text: payload.message || "No se pudo quitar" });
          }
          return;
        }
        await refreshComboPanel();
      } catch (error) {
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "error", title: "Error", text: "No se pudo quitar" });
        }
      }
    });
  }

  if (openCreateModal) {
    openCreateModal.addEventListener("click", () => {
      resetProductForm();
      openModal();
    });
  }

  if (closeModal) {
    closeModal.addEventListener("click", closeModalFn);
  }

  if (cancelEdit) {
    cancelEdit.addEventListener("click", () => {
      resetProductForm();
    });
  }

  modalTabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      setActiveTab(tab.dataset.target);
    });
  });

  if (modal) {
    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        closeModalFn();
      }
    });
  }

  if (editLineaSelect) {
    editLineaSelect.addEventListener("change", (event) => {
      const option = event.target.selectedOptions[0];
      if (!option || !option.value) return;
      if (editLineaForm) {
        editLineaForm.action = `/inventory/linea/${option.value}/update`;
      }
      if (editLineaName) {
        editLineaName.value = option.dataset.linea || "";
      }
      if (editLineaActivo) {
        editLineaActivo.checked = option.dataset.activo === "1";
      }
    });
  }

  if (editSegmentoSelect) {
    editSegmentoSelect.addEventListener("change", (event) => {
      const option = event.target.selectedOptions[0];
      if (!option || !option.value) return;
      if (editSegmentoForm) {
        editSegmentoForm.action = `/inventory/segmento/${option.value}/update`;
      }
      if (editSegmentoName) {
        editSegmentoName.value = option.dataset.segmento || "";
      }
    });
  }

  document.querySelectorAll(".product-row").forEach((row) => {
    row.addEventListener("click", (event) => {
      if (event.target.closest("form") || event.target.closest("a") || event.target.closest("button")) {
        return;
      }
      fillProductForm(row);
      openModal();
    });
  });

  const errorBanner = document.querySelector("[data-error-banner]");
  if (errorBanner) {
    errorBanner.style.display = "none";
  }
  const successBanner = document.querySelector("[data-success-banner]");
  if (successBanner) {
    successBanner.style.display = "none";
  }
  {% if error %}
  if (typeof Swal !== "undefined") {
    Swal.fire({
      icon: "error",
      title: "Atencion",
      text: "{{ error }}",
      confirmButtonText: "Entendido",
    });
  }
  {% endif %}
  {% if success %}
  if (typeof Swal !== "undefined") {
    Swal.fire({
      icon: "success",
      title: "Producto creado",
      text: "{{ success }}",
      timer: 1800,
      showConfirmButton: false,
    });
  }
  {% endif %}
</script>
{% endblock %}
