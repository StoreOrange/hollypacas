{% extends "base.html" %}
{% block content %}
<div id="layout" class="min-h-screen grid lg:grid-cols-[260px_1fr] bg-surface">
  {% include "partials/sidebar.html" %}

  <main class="p-4 p-lg-5">
    <div class="container-fluid">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
        <div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
              <li class="breadcrumb-item"><a href="/finance">Finanzas</a></li>
              <li class="breadcrumb-item active" aria-current="page">Tasa de cambio</li>
            </ol>
          </nav>
          <h1 class="h5 mb-1">Tasa de cambio</h1>
          <p class="text-muted mb-0">Define la conversion USD a Cordobas por periodo.</p>
        </div>
        <div class="text-muted small">Version {{ version }}</div>
      </div>

      <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
          <a class="nav-link" href="/finance">Catalogos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/finance/rates">Tasa de cambio</a>
        </li>
      </ul>

      {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
      {% endif %}
      {% if success %}
      <div class="alert alert-success">{{ success }}</div>
      {% endif %}

      <div class="row g-4">
        <div class="col-lg-4">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h2 class="h6 mb-3">Nueva tasa</h2>
              <form class="row g-3" method="post" action="/finance/rates">
                <div class="col-12">
                  <label class="form-label">Fecha</label>
                  <input name="effective_date" type="date" class="form-control form-control-sm" required />
                </div>
                <div class="col-12">
                  <label class="form-label">Periodo</label>
                  <select name="period" class="form-select form-select-sm">
                    <option value="daily">Dia</option>
                    <option value="month">Mes</option>
                    <option value="quarter">3 meses</option>
                    <option value="semester">6 meses</option>
                    <option value="year">1 ano</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">Tasa USD -> C$</label>
                  <input name="rate" type="number" step="0.0001" class="form-control form-control-sm" required />
                </div>
                <div class="col-12">
                  <button class="btn btn-primary btn-sm w-100">Guardar tasa</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h6 mb-0">Historico</h2>
                <span class="text-muted small">{{ rates|length }} registros</span>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Fecha</th>
                      <th>Periodo</th>
                      <th>Tasa</th>
                      <th class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for rate in rates %}
                    <tr>
                      <td>
                        <input form="rate-update-{{ rate.id }}" name="effective_date" type="date" class="form-control form-control-sm" value="{{ rate.effective_date }}" required />
                      </td>
                      <td>
                        <select form="rate-update-{{ rate.id }}" name="period" class="form-select form-select-sm">
                          <option value="daily" {% if rate.period == "daily" %}selected{% endif %}>Dia</option>
                          <option value="month" {% if rate.period == "month" %}selected{% endif %}>Mes</option>
                          <option value="quarter" {% if rate.period == "quarter" %}selected{% endif %}>3 meses</option>
                          <option value="semester" {% if rate.period == "semester" %}selected{% endif %}>6 meses</option>
                          <option value="year" {% if rate.period == "year" %}selected{% endif %}>1 ano</option>
                        </select>
                      </td>
                      <td>
                        <input form="rate-update-{{ rate.id }}" name="rate" type="number" step="0.0001" class="form-control form-control-sm" value="{{ '%.4f'|format(rate.rate or 0) }}" required />
                      </td>
                      <td class="text-end">
                        <div class="d-inline-flex gap-1">
                          <form id="rate-update-{{ rate.id }}" method="post" action="/finance/rates/{{ rate.id }}/update">
                            <button type="submit" class="btn btn-sm btn-outline-primary">Actualizar</button>
                          </form>
                          <form method="post" action="/finance/rates/{{ rate.id }}/delete" onsubmit="return confirm('Eliminar tasa del {{ rate.effective_date }}?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Borrar</button>
                          </form>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                    {% if rates|length == 0 %}
                    <tr>
                      <td colspan="4" class="text-center text-muted py-4">Sin registros</td>
                    </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
{% endblock %}
