{% extends "base.html" %}
{% block content %}
<div id="layout" class="min-h-screen grid lg:grid-cols-[260px_1fr] bg-surface">
  {% include "partials/sidebar.html" %}

  <main class="p-4 p-lg-5">
    <div class="container-fluid">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
        <div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
              <li class="breadcrumb-item">Datos</li>
              <li class="breadcrumb-item active" aria-current="page">Catalogos</li>
            </ol>
          </nav>
          <h1 class="h5 mb-1">Catalogos maestros</h1>
          <p class="text-muted mb-0">Accesos organizados por secciones funcionales.</p>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-3">
          <div class="row g-2 align-items-center">
            <div class="col-lg-8">
              <label for="data-catalog-search" class="form-label mb-1 fw-semibold">Buscador inteligente</label>
              <input
                id="data-catalog-search"
                type="text"
                class="form-control"
                placeholder="Ej: usuarios, empresa, interfaz, bancos, impresora, inventario"
                autocomplete="off"
              />
            </div>
            <div class="col-lg-4 text-muted small">
              Escribe palabras clave y presiona <kbd>Enter</kbd> para abrir la mejor opcion.
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div id="data-catalog-grid" class="d-flex flex-column gap-4">
            <section class="border rounded-3 p-3" data-catalog-group>
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h2 class="h6 mb-0">Navegacion general</h2>
              </div>
              <div class="row g-3">
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/home">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Panel principal</div>
                        <span class="badge text-bg-success"><i class="bi bi-speedometer2"></i> Home</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Volver al menu principal del ERP.</p>
                    </div>
                  </a>
                </div>
              </div>
            </section>

            <section class="border rounded-3 p-3" data-catalog-group>
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h2 class="h6 mb-0">Configuracion empresarial</h2>
              </div>
              <div class="row g-3">
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/empresa">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Perfil empresarial</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-building"></i> Branding</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Nombre comercial, logo, favicon y datos corporativos.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/entornos">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Entornos empresariales</div>
                        <span class="badge text-bg-dark"><i class="bi bi-buildings"></i> Multiempresa</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Activa la base de datos de trabajo por empresa.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/interfaz-ventas">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Interfaz de ventas</div>
                        <span class="badge text-bg-primary"><i class="bi bi-display"></i> UI</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Cambia la interfaz de `/sales` por tipo de negocio.</p>
                    </div>
                  </a>
                </div>
              </div>
            </section>

            <section class="border rounded-3 p-3" data-catalog-group>
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h2 class="h6 mb-0">Seguridad y acceso</h2>
              </div>
              <div class="row g-3">
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/usuarios">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Usuarios</div>
                        <span class="badge text-bg-success"><i class="bi bi-person-badge"></i> Gestion</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Crear, editar y desactivar usuarios del sistema.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/roles">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Roles</div>
                        <span class="badge text-bg-primary"><i class="bi bi-shield-lock"></i> Seguridad</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Perfiles de acceso y permisos base.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/permisos">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Permisos</div>
                        <span class="badge text-bg-primary"><i class="bi bi-diagram-3"></i> Acceso</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Visibilidad de menus y acciones por rol.</p>
                    </div>
                  </a>
                </div>
              </div>
            </section>

            <section class="border rounded-3 p-3" data-catalog-group>
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h2 class="h6 mb-0">Operacion comercial</h2>
              </div>
              <div class="row g-3">
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/clientes">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Clientes</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-people"></i> CRM</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Registro de clientes e identificacion.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/sucursales">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Sucursales</div>
                        <span class="badge text-bg-primary"><i class="bi bi-diagram-3"></i> Operacion</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Gestiona sedes y puntos de venta.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/bodegas">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Bodegas</div>
                        <span class="badge text-bg-primary"><i class="bi bi-boxes"></i> Stock</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Bodegas asociadas a cada sucursal.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/vendedores">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Vendedores</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-person-lines-fill"></i> Ventas</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Catalogo de vendedores y estado activo.</p>
                    </div>
                  </a>
                </div>
              </div>
            </section>

            <section class="border rounded-3 p-3" data-catalog-group>
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h2 class="h6 mb-0">Finanzas y recibos</h2>
              </div>
              <div class="row g-3">
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/bancos">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Bancos</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-bank"></i> Finanzas</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Listado oficial de bancos y cuentas.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/formas-pago">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Formas de pago</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-credit-card-2-front"></i> Cobros</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Efectivo, tarjeta, banco y credito.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/recibos-rubros">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Rubros de recibo</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-bookmark-star"></i> ROC</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Clasificacion de gastos e ingresos.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/recibos-motivos">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Motivos de recibo</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-list-check"></i> ROC</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Motivos de ingreso y egreso.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/cuentas-contables">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Plan de cuentas</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-journal-bookmark"></i> PCGA</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Cuentas contables y niveles.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/notificaciones">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Notificaciones</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-envelope-at"></i> Correo</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Emisor y destinatarios para alertas.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/data/pos-print">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Impresion POS</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-printer"></i> Ticket</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Configura impresoras y copias por sucursal.</p>
                    </div>
                  </a>
                </div>
              </div>
            </section>

            <section class="border rounded-3 p-3" data-catalog-group>
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h2 class="h6 mb-0">Inventario maestro</h2>
              </div>
              <div class="row g-3">
                <div class="col-md-6 col-xl-4" data-catalog-item>
                  <a class="text-decoration-none" href="/inventory">
                    <div class="border rounded-3 p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Productos</div>
                        <span class="badge text-bg-secondary"><i class="bi bi-box-seam"></i> Catalogo</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Productos, lineas y segmentos.</p>
                    </div>
                  </a>
                </div>
                <div class="col-md-12 col-xl-8" data-catalog-item>
                  <div class="border rounded-3 p-3 h-100">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-2">
                      <div class="fw-semibold">Importar inventario (Excel)</div>
                      <a class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-2" href="/inventory/import/template">
                        <i class="bi bi-download"></i>
                        Descargar plantilla
                      </a>
                    </div>
                    <p class="text-muted mb-3">Sube columnas: codigo, descripcion, linea, segmento, costo_usd, precio_usd, precio_cs, saldo_central, saldo_esteli.</p>
                    <form id="import-form" class="d-flex flex-wrap align-items-center gap-3" method="post" action="/inventory/import" enctype="multipart/form-data">
                      <input id="import-file" name="file" type="file" accept=".xlsx" class="form-control form-control-sm" required />
                      <button class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-2" type="button"
                              hx-post="/inventory/import/preview"
                              hx-target="#import-preview"
                              hx-encoding="multipart/form-data"
                              hx-include="#import-form">
                        <i class="bi bi-eye"></i>
                        Vista previa
                      </button>
                      <button class="btn btn-primary btn-sm d-inline-flex align-items-center gap-2" type="submit">
                        <i class="bi bi-upload"></i>
                        Importar Excel
                      </button>
                    </form>
                    <div class="mt-3">
                      <button class="btn btn-outline-danger btn-sm d-inline-flex align-items-center gap-2" type="button" disabled aria-disabled="true">
                        <i class="bi bi-trash3"></i>
                        Eliminar todo el inventario
                      </button>
                    </div>
                    <div id="import-preview" class="mt-3"></div>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <div id="data-catalog-no-results" class="text-center py-4 text-muted d-none">
            No hay coincidencias para esta busqueda.
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("data-catalog-search");
    const grid = document.getElementById("data-catalog-grid");
    const noResults = document.getElementById("data-catalog-no-results");
    if (!searchInput || !grid || !noResults) return;

    const routeKeywords = {
      "/data/usuarios": ["usuario", "usuarios", "acceso", "login", "cuenta", "empleado"],
      "/data/clientes": ["cliente", "clientes", "crm", "comprador"],
      "/data/sucursales": ["sucursal", "sucursales", "tienda", "sedes"],
      "/data/bodegas": ["bodega", "bodegas", "almacen", "stock"],
      "/data/roles": ["rol", "roles", "perfil", "perfiles"],
      "/data/permisos": ["permiso", "permisos", "seguridad", "acceso"],
      "/data/vendedores": ["vendedor", "vendedores", "ventas", "comision"],
      "/data/bancos": ["banco", "bancos", "finanzas", "cuenta bancaria"],
      "/data/formas-pago": ["pago", "pagos", "efectivo", "tarjeta", "credito"],
      "/data/recibos-rubros": ["rubro", "rubros", "roc", "recibo", "gasto"],
      "/data/recibos-motivos": ["motivo", "motivos", "roc", "recibo", "ingreso", "egreso"],
      "/data/pos-print": ["impresion", "impresora", "ticket", "pos", "sumatra"],
      "/data/cuentas-contables": ["cuenta", "contable", "contabilidad", "plan de cuentas"],
      "/data/notificaciones": ["notificacion", "correo", "email", "alerta"],
      "/data/entornos": ["entorno", "entornos", "empresa", "multiempresa", "base de datos", "bd"],
      "/data/interfaz-ventas": ["interfaz", "ventas", "ui", "facturacion", "estilo"],
      "/data/empresa": ["empresa", "branding", "logo", "favicon", "identidad"],
      "/inventory": ["producto", "productos", "inventario", "catalogo", "importar"],
      "/home": ["home", "inicio", "panel", "principal"]
    };

    const aliases = {
      "caja": ["roc", "recibo", "cierre", "cobranza"],
      "factura": ["ventas", "facturacion", "ticket"],
      "admin": ["usuarios", "roles", "permisos"],
      "negocio": ["empresa", "sucursal", "entorno"],
      "correo": ["notificaciones", "email", "alerta"]
    };

    const normalize = (value) =>
      (value || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();

    const tokenize = (value) => normalize(value).split(/\s+/).filter(Boolean);

    const cards = Array.from(grid.querySelectorAll("[data-catalog-item]")).map((item) => {
      const link = item.querySelector("a[href]");
      const href = link ? link.getAttribute("href") : "";
      const text = normalize(item.innerText || "");
      const routeWords = (routeKeywords[href] || []).map(normalize);
      return { item, href, link, text, routeWords, score: 0 };
    });

    const groups = Array.from(grid.querySelectorAll("[data-catalog-group]"));

    const rank = (tokens, card) => {
      if (!tokens.length) return 1;
      let score = 0;
      for (const token of tokens) {
        if (card.text.includes(token)) score += 4;
        if (card.href && normalize(card.href).includes(token)) score += 2;
        for (const word of card.routeWords) {
          if (word.includes(token) || token.includes(word)) score += 7;
        }
      }
      return score;
    };

    const applySearch = () => {
      const rawTokens = tokenize(searchInput.value);
      const expanded = [...rawTokens];
      for (const token of rawTokens) {
        for (const alias of aliases[token] || []) {
          expanded.push(normalize(alias));
        }
      }

      let visibleCount = 0;
      cards.forEach((card) => {
        card.score = rank(expanded, card);
        const visible = !expanded.length || card.score > 0;
        card.item.style.display = visible ? "" : "none";
        if (visible) visibleCount += 1;
      });

      groups.forEach((group) => {
        const groupVisibleItems = Array.from(group.querySelectorAll("[data-catalog-item]")).some(
          (item) => item.style.display !== "none"
        );
        group.style.display = groupVisibleItems ? "" : "none";
      });

      noResults.classList.toggle("d-none", visibleCount > 0);
    };

    searchInput.addEventListener("input", applySearch);
    searchInput.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      event.preventDefault();
      applySearch();
      const best = cards
        .filter((card) => card.item.style.display !== "none" && card.link)
        .sort((a, b) => b.score - a.score)[0];
      if (best && best.link) {
        window.location.href = best.link.getAttribute("href");
      }
    });
  });
</script>
{% endblock %}
