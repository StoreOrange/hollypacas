{% extends "base.html" %}
{% block content %}
<style>
  .combo-role-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    border-radius: 999px;
    padding: 0.1rem 0.45rem;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .combo-role-badge.parent {
    background: #e0f2fe;
    color: #1d4ed8;
  }
  .combo-role-badge.gift {
    background: #dcfce7;
    color: #166534;
  }
  .combo-group-chip {
    display: inline-block;
    margin-top: 0.2rem;
    border-radius: 999px;
    padding: 0.05rem 0.45rem;
    background: #f1f5f9;
    color: #475569;
    font-size: 0.68rem;
    font-weight: 600;
  }
  .preventa-fallback-show {
    display: block !important;
    background: rgba(15, 23, 42, 0.55);
  }
</style>
<div id="layout" class="min-h-screen grid lg:grid-cols-[260px_1fr] bg-surface">
  {% include "partials/sidebar.html" %}

  <main class="p-6 lg:p-8">
    <div class="odoo-page">
      <div class="odoo-header mb-3">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <div class="odoo-title">Panel de preventas</div>
            <div class="odoo-subtitle">Revision y carga de preventas hacia facturacion virtual.</div>
          </div>
          <a class="btn btn-primary btn-sm" href="/m/preventas">
            <i class="bi bi-phone"></i>
            Realizar preventa (movil)
          </a>
        </div>
      </div>

      {% if success %}
      <div class="alert alert-success">{{ success }}</div>
      {% endif %}
      {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
      {% endif %}

      <form method="get" action="/sales/preventas" class="odoo-card mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label">Fecha</label>
            <input class="form-control" type="date" name="fecha" value="{{ fecha }}">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Sucursal</label>
            <select class="form-select" name="branch_id">
              <option value="all" {% if branch_id == 'all' %}selected{% endif %}>Todas</option>
              {% for b in branches %}
              <option value="{{ b.id }}" {% if branch_id == b.id|string %}selected{% endif %}>{{ b.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Vendedor</label>
            <select class="form-select" name="vendedor_id">
              <option value="">Todos</option>
              {% for v in vendedores %}
              <option value="{{ v.id }}" {% if vendedor_id == v.id|string %}selected{% endif %}>{{ v.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-2">
            <label class="form-label">Estado</label>
            <select class="form-select" name="estado">
              <option value="" {% if not estado %}selected{% endif %}>Todos</option>
              <option value="PENDIENTE" {% if estado == 'PENDIENTE' %}selected{% endif %}>Pendiente</option>
              <option value="REVISION" {% if estado == 'REVISION' %}selected{% endif %}>En revision</option>
              <option value="FACTURADA" {% if estado == 'FACTURADA' %}selected{% endif %}>Facturada</option>
              <option value="ANULADA" {% if estado == 'ANULADA' %}selected{% endif %}>Anulada</option>
            </select>
          </div>
          <div class="col-12 col-md-1 d-grid">
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
      </form>

      <div class="odoo-card">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Fecha</th>
                <th>Vendedor</th>
                <th>Cliente</th>
                <th>Sucursal</th>
                <th class="text-end">Total USD</th>
                <th class="text-end">Total C$</th>
                <th>Estado</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for row in rows %}
              <tr data-preventa-row data-preventa-id="{{ row.id }}">
                <td class="fw-semibold">{{ row.numero }}</td>
                <td>{{ row.fecha.strftime('%Y-%m-%d %H:%M') if row.fecha else '-' }}</td>
                <td>{{ row.vendedor }}</td>
                <td>{{ row.cliente }}</td>
                <td>{{ row.sucursal }}</td>
                <td class="text-end">${{ "{:,.2f}".format(row.total_usd or 0) }}</td>
                <td class="text-end">C${{ "{:,.2f}".format(row.total_cs or 0) }}</td>
                <td>
                  <span class="badge rounded-pill {{ row.badge.class }}">{{ row.badge.label }}</span>
                </td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary js-preview-detail" type="button" data-preventa-id="{{ row.id }}">
                      <i class="bi bi-eye"></i>
                    </button>
                    {% if row.estado in ['PENDIENTE','REVISION'] %}
                    <form method="post" action="/sales/preventas/{{ row.id }}/usar">
                      <button class="btn btn-outline-primary" type="submit" title="Cargar a factura virtual">
                        <i class="bi bi-arrow-right-circle"></i>
                      </button>
                    </form>
                    {% endif %}
                    {% if not is_vendedor_role and row.estado != 'FACTURADA' %}
                    <form method="post" action="/sales/preventas/{{ row.id }}/anular" onsubmit="return confirm('Anular preventa {{ row.numero }}?');">
                      <button class="btn btn-outline-danger" type="submit">
                        <i class="bi bi-x-circle"></i>
                      </button>
                    </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
              {% if rows|length == 0 %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">Sin preventas para los filtros seleccionados.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="modal fade" id="preventaDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle de preventa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="preventaDetailHeader" class="mb-2 small text-muted"></div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Codigo</th>
                <th>Descripcion</th>
                <th class="text-end">Cantidad</th>
                <th class="text-end">Existencia</th>
                <th class="text-end">Precio USD</th>
                <th class="text-end">Precio C$</th>
                <th class="text-end">Subtotal USD</th>
                <th class="text-end">Subtotal C$</th>
              </tr>
            </thead>
            <tbody id="preventaDetailBody"></tbody>
            <tfoot>
              <tr class="fw-semibold">
                <td colspan="7" class="text-end">Totales preventa:</td>
                <td class="text-end" id="preventaDetailTotalUsd">$0.00</td>
                <td class="text-end" id="preventaDetailTotalCs">C$0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (() => {
    const modalEl = document.getElementById("preventaDetailModal");
    if (!modalEl) return;
    const bsModal = window.bootstrap ? new bootstrap.Modal(modalEl) : null;
    const header = document.getElementById("preventaDetailHeader");
    const body = document.getElementById("preventaDetailBody");
    const totalUsdEl = document.getElementById("preventaDetailTotalUsd");
    const totalCsEl = document.getElementById("preventaDetailTotalCs");
    const fmt = (n, p = "") => `${p}${Number(n || 0).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    const esc = (v) => String(v ?? "").replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));

    function showDetailModal() {
      if (bsModal) {
        bsModal.show();
        return;
      }
      // Fallback if Bootstrap JS is not available.
      modalEl.classList.add("show", "preventa-fallback-show");
      modalEl.removeAttribute("aria-hidden");
      modalEl.setAttribute("aria-modal", "true");
    }

    async function openDetail(id) {
      try {
        const res = await fetch(`/sales/preventas/${id}/detail`, { headers: { "X-Requested-With": "fetch" } });
        if (!res.ok) {
          alert("No se pudo cargar detalle de preventa.");
          return;
        }
        const data = await res.json();
        if (!data.ok) {
          alert(data.message || "No se pudo cargar detalle");
          return;
        }
        const p = data.preventa || {};
        header.innerHTML = `Preventa <strong>${esc(p.numero)}</strong> &middot; Cliente: ${esc(p.cliente)} &middot; Vendedor: ${esc(p.vendedor)} &middot; Estado: ${esc(p.estado)}`;
        const rows = (data.items || []).map((it) => `
          <tr class="${it.ok_stock ? "" : "table-warning"}">
            <td>${esc(it.codigo)}</td>
            <td>
              <div>${esc(it.descripcion)}</div>
              ${
                it.combo_role === "parent"
                  ? '<span class="combo-role-badge parent"><i class="bi bi-boxes"></i>Oferta</span>'
                  : it.combo_role === "gift"
                    ? '<span class="combo-role-badge gift"><i class="bi bi-gift"></i>Regalia</span>'
                    : ""
              }
              ${it.combo_group ? `<div class="combo-group-chip">Grupo: ${esc(it.combo_group)}</div>` : ""}
            </td>
            <td class="text-end">${Number(it.cantidad || 0).toLocaleString("en-US", { maximumFractionDigits: 0 })}</td>
            <td class="text-end">${Number(it.existencia || 0).toLocaleString("en-US", { maximumFractionDigits: 0 })}</td>
            <td class="text-end">${fmt(it.precio_usd, "$" )}</td>
            <td class="text-end">${fmt(it.precio_cs, "C$")}</td>
            <td class="text-end">${fmt(it.subtotal_usd, "$" )}</td>
            <td class="text-end">${fmt(it.subtotal_cs, "C$")}</td>
          </tr>
        `).join("");
        body.innerHTML = rows || '<tr><td colspan="9" class="text-center text-muted py-3">Sin items</td></tr>';
        if (totalUsdEl) totalUsdEl.textContent = fmt(p.total_usd, "$");
        if (totalCsEl) totalCsEl.textContent = fmt(p.total_cs, "C$");
        showDetailModal();
      } catch (err) {
        alert("Error cargando detalle");
      }
    }

    document.addEventListener("click", (event) => {
      const btn = event.target.closest(".js-preview-detail");
      if (!btn) return;
      const id = btn.getAttribute("data-preventa-id");
        if (id) openDetail(id);
    });

    modalEl.addEventListener("click", (event) => {
      if (event.target === modalEl && !bsModal) {
        modalEl.classList.remove("show", "preventa-fallback-show");
        modalEl.setAttribute("aria-hidden", "true");
        modalEl.removeAttribute("aria-modal");
      }
    });

    document.querySelectorAll("tr[data-preventa-row]").forEach((tr) => {
      tr.addEventListener("dblclick", () => {
        const id = tr.getAttribute("data-preventa-id");
        if (id) openDetail(id);
      });
    });
  })();
</script>
{% endblock %}
