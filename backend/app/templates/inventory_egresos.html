{% extends "base.html" %}
{% block content %}
<style>
  .inventory-compact-header .odoo-title {
    font-size: 1.35rem;
    margin-top: 0.25rem;
  }
  .inventory-compact-header .odoo-subtitle {
    font-size: 0.9rem;
    margin-top: 0.1rem;
  }
  .inventory-compact-header .breadcrumb {
    margin-bottom: 0.25rem;
  }
  .inventory-tabs .nav-link {
    padding: 0.35rem 0.75rem;
    font-size: 0.9rem;
  }
  .egreso-modal .search-panel {
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    background: #ffffff;
    box-shadow: 0 10px 22px rgba(15, 23, 42, 0.06);
  }
  .egreso-modal .totals-bar {
    border-top: 1px dashed #e2e8f0;
    padding-top: 0.75rem;
  }
  .egreso-modal .totals-bar .label {
    font-size: 0.85rem;
    color: #64748b;
  }
  .egreso-modal .totals-bar .value {
    font-weight: 600;
    color: #0f172a;
  }
  .movement-meta-grid .form-label {
    display: flex;
    align-items: center;
    margin-bottom: 0.2rem;
    line-height: 1rem;
    font-size: 0.82rem;
    font-weight: 600;
  }
  .movement-meta-grid .form-control,
  .movement-meta-grid .form-select {
    min-height: 32px;
    padding-top: 0.2rem;
    padding-bottom: 0.2rem;
    font-size: 0.86rem;
  }
  .movement-meta-grid .select2-container--default .select2-selection--single {
    min-height: 32px;
    display: flex;
    align-items: center;
  }
  .movement-meta-grid .select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 30px;
    font-size: 0.86rem;
  }
  .movement-meta-grid .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 30px;
  }
  .movement-meta-grid .movement-meta-item {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }
</style>
<div id="layout" class="min-h-screen grid lg:grid-cols-[260px_1fr] bg-surface">
  {% include "partials/sidebar.html" %}

  <main class="p-6 lg:p-8 text-[18px]">
    <div class="odoo-page">
      <div class="odoo-header inventory-compact-header">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 position-relative">
          <div>
            <button class="toggle-sidebar sidebar-toggle-show btn btn-sm btn-outline-secondary mb-2" type="button">
              <i class="bi bi-layout-sidebar"></i>
              Mostrar menu
            </button>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item">Inventario</li>
                <li class="breadcrumb-item active" aria-current="page">Egresos</li>
              </ol>
            </nav>
            <div class="odoo-title mt-2">Egresos de inventario</div>
            <div class="odoo-subtitle mt-1">Registro de bajas y salidas de inventario.</div>
          </div>
          <div class="odoo-toolbar">
            <div class="odoo-pill primary">
              <i class="bi bi-currency-exchange"></i>
              {% if rate_today %}
                Tasa C$ {{ "%.4f"|format(rate_today.rate) }}
              {% else %}
                Sin tasa
              {% endif %}
            </div>
          </div>
        </div>
        <ul class="nav nav-tabs mt-2 inventory-tabs">
          <li class="nav-item">
            <a class="nav-link" href="/inventory">Catalogo de productos</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/inventory/ingresos">Ingresos de inventario</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/inventory/egresos">Egresos de inventario</a>
          </li>
        </ul>
      </div>

      <div class="odoo-kpis">
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-journal-minus text-blue-600"></i>
            Egresos
          </div>
          <strong>{{ egresos|length }}</strong>
        </div>
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-box-seam text-emerald-600"></i>
            Productos
          </div>
          <strong>{{ productos|length }}</strong>
        </div>
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-house-door text-rose-600"></i>
            Bodegas
          </div>
          <strong>{{ bodegas|length }}</strong>
        </div>
      </div>

    {% if error %}
    <div class="mt-4 rounded-xl border border-red-200 bg-red-50 text-red-700 px-4 py-2" data-error-banner>
      {{ error }}
    </div>
    {% endif %}
    {% if success %}
    <div class="mt-4 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-700 px-4 py-2" data-success-banner>
      {{ success }}
    </div>
    {% endif %}

      <div class="card shadow-sm border-0">
        <div class="card-body p-3 p-lg-4">
      <ul class="nav nav-tabs mb-2 inventory-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active py-1 px-3 small" id="egreso-form-tab" type="button">
            <i class="bi bi-box-arrow-up"></i>
            Registrar egreso
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link py-1 px-3 small" id="egreso-list-tab" type="button">
            <i class="bi bi-list-check"></i>
            Egresos registrados
          </button>
        </li>
      </ul>

      <section id="egreso-list-section" class="hidden">
      <div class="odoo-card">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
          <div class="odoo-section-title">Egresos registrados</div>
          <div class="d-flex flex-wrap align-items-center gap-3 text-sm text-slate">
            <form class="d-flex flex-wrap align-items-center gap-2" method="get" action="/inventory/egresos">
              <div class="input-group input-group-sm rounded-pill overflow-hidden border border-slate-200 bg-white">
                <span class="input-group-text bg-white border-0"><i class="bi bi-calendar-range text-brand"></i></span>
                <input name="start_date" type="date" class="form-control border-0" value="{{ start_date }}" />
                <span class="input-group-text bg-white border-0">a</span>
                <input name="end_date" type="date" class="form-control border-0" value="{{ end_date }}" />
              </div>
              <button class="btn btn-outline-secondary btn-sm" type="submit">
                <i class="bi bi-search"></i>
                Filtrar
              </button>
              <a class="btn btn-outline-secondary btn-sm" href="/inventory/egresos">
                <i class="bi bi-eraser"></i>
                Ultimos 30 dias
              </a>
            </form>
            <span class="odoo-pill success">
              <i class="bi bi-list-check"></i>
              {{ egresos|length }} registros
            </span>
          </div>
        </div>
        <div class="table-responsive">
          <table id="egresos-table" class="table table-striped table-sm align-middle text-sm odoo-table">
            <thead class="text-xs uppercase tracking-[0.15em] text-slate bg-slate-50">
              <tr>
                <th class="text-left px-4 py-3">Fecha</th>
                <th class="text-left px-4 py-3">Tipo</th>
                <th class="text-left px-4 py-3">Origen</th>
                <th class="text-left px-4 py-3">Destino</th>
                <th class="text-right px-4 py-3">Total USD</th>
                <th class="text-right px-4 py-3">Total C$</th>
                <th class="text-left px-4 py-3">Motivo</th>
                <th class="text-center px-4 py-3">Documento</th>
              </tr>
            </thead>
            <tbody>
              {% for egreso in egresos %}
              <tr class="border-b border-slate-100">
                <td class="px-4 py-3 text-slate">{{ egreso.fecha }}</td>
                <td class="px-4 py-3 font-semibold text-ink">{{ egreso.tipo.nombre if egreso.tipo else "-" }}</td>
                <td class="px-4 py-3 text-slate">{{ egreso.bodega.name if egreso.bodega else "-" }}</td>
                <td class="px-4 py-3 text-slate">{{ egreso.bodega_destino.name if egreso.bodega_destino else "-" }}</td>
                <td class="px-4 py-3 text-right text-slate">$ {{ "%.2f"|format(egreso.total_usd or 0) }}</td>
                <td class="px-4 py-3 text-right text-slate">C$ {{ "%.2f"|format(egreso.total_cs or 0) }}</td>
                <td class="px-4 py-3 text-slate">{{ egreso.observacion or "-" }}</td>
                <td class="px-4 py-3 text-center">
                  <a class="btn btn-outline-secondary btn-sm" href="/inventory/egresos/{{ egreso.id }}/pdf" target="_blank" rel="noopener">
                    <i class="bi bi-printer"></i>
                    PDF
                  </a>
                </td>
              </tr>
              {% endfor %}
              {% if egresos|length == 0 %}
              {% endif %}
            </tbody>
          </table>
        </div>
        <div class="text-end text-slate text-sm mt-4">Version {{ version }}</div>
      </div>
    </div>
      </section>

      <section id="egreso-form-section">
        <div id="ingreso-panel" class="odoo-card bg-white shadow-sm egreso-modal">
          <div class="odoo-modal-header flex items-center justify-between">
            <div>
              <div class="odoo-breadcrumb">Inventario / Egresos</div>
              <div class="odoo-section-title text-2xl tracking-tight">Nuevo egreso</div>
              <div class="text-sm text-slate mt-1">Registro de salidas de inventario</div>
            </div>
          </div>
          <div class="px-6 pt-2">
            <div class="flex flex-wrap gap-2 odoo-tabs odoo-modal-tabs">
              <button class="ingreso-tab btn btn-sm btn-primary d-inline-flex align-items-center gap-2" data-target="tab-ingreso" type="button">
                <i class="bi bi-box-arrow-up"></i>
                Egreso
              </button>
            </div>
          </div>
          <div class="px-6 pb-4 pt-2 space-y-4 overflow-y-auto max-h-[70vh] odoo-modal-body">
            <div id="tab-ingreso" class="ingreso-panel">
              <form id="ingreso-form" method="post" action="/inventory/egresos" class="space-y-4 text-sm" novalidate>
                <div id="bodega-banner" class="alert alert-warning py-2 px-3 mb-2 d-flex align-items-center gap-2" role="status">
                  <i class="bi bi-box-arrow-up"></i>
                  <span class="fw-semibold">Egreso de mercaderia en Bodega Central</span>
                </div>
                <div id="egreso-client-error" class="alert alert-warning py-2 px-3 mb-2 d-none" role="alert"></div>
                <div class="odoo-modal-section">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="odoo-modal-title">Datos del egreso</div>
                    <span class="odoo-pill">Campos obligatorios *</span>
                  </div>
                  <div class="row g-2 align-items-start movement-meta-grid">
                    <div class="col-12 col-md-6 col-xl-3 movement-meta-item">
                      <label class="form-label text-sm font-semibold text-ink">
                        <i class="bi bi-journal-minus text-brand me-1"></i>
                        Tipo de egreso *
                      </label>
                      <select id="field-tipo" name="tipo_id" class="odoo-input form-select form-select-sm select2 odoo-select2 w-100">
                        <option value="">Selecciona</option>
                        {% for tipo in tipos %}
                        <option value="{{ tipo.id }}" data-is-traslado="{{ 1 if 'traslado' in (tipo.nombre or '')|lower else 0 }}">{{ tipo.nombre }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-12 col-md-6 col-xl-3 movement-meta-item">
                      <label class="form-label text-sm font-semibold text-ink">
                        <i class="bi bi-calendar-event text-brand me-1"></i>
                        Fecha *
                      </label>
                      <input id="field-fecha" name="fecha" type="text" class="odoo-input form-control form-control-sm datepicker w-100" placeholder="Selecciona fecha" required />
                    </div>
                    <div class="col-12 col-md-6 col-xl-3 movement-meta-item">
                      <label class="form-label text-sm font-semibold text-ink">
                        <i class="bi bi-box-seam text-brand me-1"></i>
                        Bodega origen *
                      </label>
                      <select id="field-bodega-origen" name="bodega_id" class="odoo-input form-select form-select-sm select2 odoo-select2 w-100">
                        <option value="">Selecciona</option>
                        {% for bodega in bodegas %}
                        <option value="{{ bodega.id }}" {% if user.default_bodega_id == bodega.id or (not user.default_bodega_id and bodega.code == "central") %}selected{% endif %}>{{ bodega.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-12 col-md-6 col-xl-3 d-none movement-meta-item" id="bodega-destino-wrap">
                      <label class="form-label text-sm font-semibold text-ink">
                        <i class="bi bi-arrow-left-right text-brand me-1"></i>
                        Bodega destino *
                      </label>
                      <select id="field-bodega-destino" name="bodega_destino_id" class="odoo-input form-select form-select-sm select2 odoo-select2 w-100">
                        <option value="">Selecciona destino</option>
                        {% for bodega in bodegas %}
                        <option value="{{ bodega.id }}">{{ bodega.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-12 col-md-6 col-xl-3 movement-meta-item">
                      <label class="form-label text-sm font-semibold text-ink">
                        <i class="bi bi-currency-exchange text-brand me-1"></i>
                        Moneda *
                      </label>
                      <select id="field-moneda" name="moneda" class="odoo-input form-select form-select-sm select2 odoo-select2 w-100">
                        <option value="USD">USD</option>
                        <option value="CS">C$</option>
                      </select>
                    </div>
                    <div class="col-12 col-xl-9 movement-meta-item">
                      <label class="form-label text-sm font-semibold text-ink">
                        <i class="bi bi-chat-square-text text-brand me-1"></i>
                        Motivo
                      </label>
                      <input name="observacion" class="odoo-input form-control form-control-sm" placeholder="Motivo de la baja" />
                    </div>
                  </div>
                  <div class="flex flex-wrap items-center gap-3 text-base mt-3">
                    <label class="inline-flex items-center gap-2 cursor-pointer text-slate">
                      <input id="allow-decimals" type="checkbox" class="sr-only peer" />
                      <span class="w-10 h-5 bg-slate-200 rounded-full peer-checked:bg-brand relative transition-colors">
                        <span class="absolute left-0.5 top-0.5 w-4 h-4 rounded-full bg-white shadow-sm transition-transform peer-checked:translate-x-5"></span>
                      </span>
                      Permitir decimales en cantidad
                    </label>
                    <span class="text-sm text-slate">Por defecto solo enteros.</span>
                  </div>
                </div>
                <div class="row g-4">
                  <div class="col-12">
                    <div class="search-panel p-3 border rounded-3 bg-light">
                      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                        <div>
                          <div class="odoo-modal-title odoo-accent">Productos a egresar</div>
                          <div class="odoo-help odoo-accent">Buscador de productos - filtro principal.</div>
                        </div>
                        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden bg-white w-100 max-w-[520px]">
                          <span class="input-group-text bg-white border-0"><i class="bi bi-search text-brand"></i></span>
                        <input id="product-search" class="form-control border-0 text-uppercase" type="text" placeholder="BUSCAR PRODUCTO" />
                        </div>
                      </div>
                      <div class="odoo-table-wrap max-h-52 overflow-y-auto">
                        <table class="table table-sm align-middle mb-0 odoo-table text-sm w-100">
                          <thead class="odoo-table-head text-xs uppercase tracking-[0.2em]">
                            <tr>
                              <th class="text-left px-3 py-2">Codigo</th>
                              <th class="text-left px-3 py-2">Descripcion</th>
                              <th class="text-right px-3 py-2">Costo USD</th>
                              <th class="text-right px-3 py-2">Precio USD</th>
                              <th class="text-right px-3 py-2">Saldo</th>
                              <th class="text-right px-3 py-2">Cantidad</th>
                              <th class="text-center px-3 py-2">Agregar</th>
                            </tr>
                          </thead>
                          <tbody id="product-list" class="odoo-muted">
                            {% for p in productos %}
                            <tr class="product-pick-row border-b border-slate-50" style="display:none;" data-name="{{ p.descripcion }}" data-code="{{ p.cod_producto }}" data-saldos='{{ saldos_por_bodega[p.id]|tojson }}'>
                              <td class="px-3 py-2 font-semibold text-ink">{{ p.cod_producto }}</td>
                              <td class="px-3 py-2 text-slate">{{ p.descripcion }}</td>
                              <td class="px-3 py-2 text-right text-slate">
                                $ {% if p.tasa_cambio %}{{ "%.2f"|format((p.costo_producto or 0) / p.tasa_cambio) }}{% else %}0.00{% endif %}
                              </td>
                              <td class="px-3 py-2 text-right text-slate">$ {{ "%.2f"|format(p.precio_venta1_usd or 0) }}</td>
                              <td class="px-3 py-2 text-right text-slate saldo-cell">0</td>
                              <td class="px-3 py-2 text-right">
                                <input class="qty-input w-16 rounded-lg border border-slate-200 px-2 py-1 text-right bg-white" type="number" step="1" min="1" max="0" value="1" />
                              </td>
                              <td class="px-3 py-2 text-center">
                                <button
                                  class="add-item inline-flex items-center justify-center w-8 h-8 rounded-lg border border-slate-200 bg-white text-ink hover:bg-slate-50 shadow-sm"
                                  type="button"
                                  data-product-id="{{ p.id }}"
                                  data-code="{{ p.cod_producto }}"
                                  data-name="{{ p.descripcion }}"
                                  data-existencia="0"
                                  data-cost-usd="{% if p.tasa_cambio %}{{ "%.2f"|format((p.costo_producto or 0) / p.tasa_cambio) }}{% else %}0{% endif %}"
                                  data-cost-cs="{{ "%.2f"|format(p.costo_producto or 0) }}"
                                  data-price-usd="{{ "%.2f"|format(p.precio_venta1_usd or 0) }}"
                                  data-price-cs="{{ "%.2f"|format(p.precio_venta1 or 0) }}"
                                >
                                  <i class="bi bi-plus"></i>
                                </button>
                              </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                      <div class="mt-3 mb-2 d-flex align-items-center justify-content-between">
                        <div class="odoo-modal-title odoo-accent">Productos cargados a la vista de egreso</div>
                        <span class="odoo-pill">Items en lista</span>
                      </div>
                      <div class="odoo-table-wrap overflow-x-auto max-h-44 overflow-y-auto">
                        <table class="table table-sm align-middle mb-0 odoo-table text-base w-100">
                          <thead class="odoo-table-head text-xs uppercase tracking-[0.15em]">
                            <tr>
                              <th class="text-left px-3 py-2">Producto</th>
                              <th class="text-right px-3 py-2">Cantidad</th>
                              <th class="text-right px-3 py-2">Costo</th>
                              <th class="text-right px-3 py-2">Precio</th>
                              <th class="text-right px-3 py-2">Subtotal</th>
                              <th class="text-center px-3 py-2">Quitar</th>
                            </tr>
                          </thead>
                          <tbody id="items-table" class="odoo-muted">
                            <tr id="empty-items">
                              <td colspan="6" class="text-center py-3 text-slate">Sin items agregados</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <div class="mt-2 d-flex flex-wrap gap-3 justify-content-end fw-bold text-dark">
                        <span>Bultos cargados: <span id="items-bultos-live">0.00</span></span>
                        <span>Items cargados: <span id="items-count-live">0</span></span>
                      </div>
                    </div>
                </div>
                <div class="totals-bar d-flex flex-wrap gap-4 align-items-center justify-content-end border-top pt-3">
                  <div>
                    <div class="label">Total bultos</div>
                    <div id="total-bultos" class="value">0.00</div>
                  </div>
                  <div>
                    <div class="label">Total items</div>
                    <div id="total-items" class="value">0</div>
                  </div>
                  <div>
                    <div class="label">Total USD</div>
                    <div id="total-usd" class="value">$ 0.00</div>
                  </div>
                  <div>
                    <div class="label">Total C$</div>
                    <div id="total-cs" class="value">C$ 0.00</div>
                  </div>
                  <div class="label">
                    {% if rate_today %}
                      Tasa: C$ {{ "%.4f"|format(rate_today.rate) }}
                    {% else %}
                      Sin tasa configurada
                    {% endif %}
                  </div>
                </div>
                <div class="mt-2 mb-1 d-flex flex-wrap gap-4 justify-content-end fw-bold text-dark">
                  <span>Total bultos: <span id="summary-bultos">0.00</span></span>
                  <span>Total items: <span id="summary-items">0</span></span>
                </div>

                <div class="flex items-center justify-between pt-2">
                  <div class="text-sm text-slate">Campos obligatorios *</div>
                  <div class="d-flex align-items-center gap-2">
                    <button id="clear-draft" class="btn btn-outline-secondary btn-md d-inline-flex align-items-center gap-2" type="button">
                      <i class="bi bi-trash3"></i>
                      Limpiar borrador
                    </button>
                    <button id="submit-egreso" class="btn btn-primary btn-md d-inline-flex align-items-center gap-2" type="submit">
                      <i class="bi bi-check2-circle"></i>
                      Registrar egreso
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>
        </div>
      </div>
  </main>
</div>

<script>
  const layout = document.getElementById("layout");
  const toggles = document.querySelectorAll(".toggle-sidebar");
  if (layout && toggles.length) {
    toggles.forEach((toggle) => {
      toggle.addEventListener("click", () => {
        layout.classList.toggle("sidebar-collapsed");
      });
    });
  }

  const ingresoTabs = document.querySelectorAll(".ingreso-tab");
  const ingresoPanels = document.querySelectorAll(".ingreso-panel");
  const productList = document.getElementById("product-list");
  const productSearch = document.getElementById("product-search");
  const itemsTable = document.getElementById("items-table");
  const emptyItems = document.getElementById("empty-items");
  const itemsBultosLive = document.getElementById("items-bultos-live");
  const itemsCountLive = document.getElementById("items-count-live");
  const summaryBultos = document.getElementById("summary-bultos");
  const summaryItems = document.getElementById("summary-items");
  const totalBultos = document.getElementById("total-bultos");
  const totalItems = document.getElementById("total-items");
  const totalUsd = document.getElementById("total-usd");
  const totalCs = document.getElementById("total-cs");
  const monedaField = document.getElementById("field-moneda");
  const tipoField = document.getElementById("field-tipo");
  const bodegaDestinoWrap = document.getElementById("bodega-destino-wrap");
  const bodegaDestinoField = document.getElementById("field-bodega-destino");
  const egresoFormTab = document.getElementById("egreso-form-tab");
  const egresoListTab = document.getElementById("egreso-list-tab");
  const egresoFormSection = document.getElementById("egreso-form-section");
  const egresoListSection = document.getElementById("egreso-list-section");
  const allowDecimals = document.getElementById("allow-decimals");
  const fechaField = document.getElementById("field-fecha");
  const rateToday = {{ rate_today.rate if rate_today else 0 }};
  let handleAddItem = null;
  const ingresoForm = document.getElementById("ingreso-form");
  const STORAGE_KEY = "hp_egreso_draft_v1";

  const setEgresoView = (view) => {
    const showForm = view === "form";
    if (egresoFormSection) egresoFormSection.classList.toggle("hidden", !showForm);
    if (egresoListSection) egresoListSection.classList.toggle("hidden", showForm);
    if (egresoFormTab) egresoFormTab.classList.toggle("active", showForm);
    if (egresoListTab) egresoListTab.classList.toggle("active", !showForm);
  };
  if (egresoFormTab) {
    egresoFormTab.addEventListener("click", () => setEgresoView("form"));
  }
  if (egresoListTab) {
    egresoListTab.addEventListener("click", () => setEgresoView("list"));
  }

  const setIngresoTab = (targetId) => {
    ingresoTabs.forEach((tab) => {
      const active = tab.dataset.target === targetId;
      tab.classList.toggle("btn-primary", active);
      tab.classList.toggle("btn-outline-secondary", !active);
    });
    ingresoPanels.forEach((panel) => {
      panel.classList.toggle("hidden", panel.id !== targetId);
    });
  };
  ingresoTabs.forEach((tab) => {
    tab.addEventListener("click", () => setIngresoTab(tab.dataset.target));
  });

  const updateTotals = () => {
    let sumBultos = 0;
    let countItems = 0;
    let sumUsd = 0;
    let sumCs = 0;
    itemsTable.querySelectorAll("tr[data-item-row]").forEach((row) => {
      countItems += 1;
      const qtyInput = row.querySelector(".row-qty");
      const qtyHidden = row.querySelector("input[name='item_cantidad']");
      const qtyValue = parseFloat(qtyInput?.value || qtyHidden?.value || 0);
      sumBultos += Number.isFinite(qtyValue) ? qtyValue : 0;
      sumUsd += parseFloat(row.dataset.subtotalUsd || 0);
      sumCs += parseFloat(row.dataset.subtotalCs || 0);
    });
    if (totalBultos) totalBultos.textContent = sumBultos.toFixed(2);
    if (totalItems) totalItems.textContent = `${countItems}`;
    if (itemsBultosLive) itemsBultosLive.textContent = sumBultos.toFixed(2);
    if (itemsCountLive) itemsCountLive.textContent = `${countItems}`;
    if (summaryBultos) summaryBultos.textContent = sumBultos.toFixed(2);
    if (summaryItems) summaryItems.textContent = `${countItems}`;
    totalUsd.textContent = `$ ${sumUsd.toFixed(2)}`;
    totalCs.textContent = `C$ ${sumCs.toFixed(2)}`;
  };

  const filterProductRows = (value) => {
    const normalized = value.toLowerCase().trim();
    productList.querySelectorAll(".product-pick-row").forEach((row) => {
      if (!normalized) {
        row.style.display = "none";
        return;
      }
      const payload = `${row.dataset.code} ${row.dataset.name}`.toLowerCase();
      row.style.display = payload.includes(normalized) ? "" : "none";
    });
  };

  const isTrasladoSelected = () => {
    const option = tipoField?.selectedOptions?.[0];
    if (!option) return false;
    return option.dataset.isTraslado === "1" || (option.text || "").toLowerCase().includes("traslado");
  };

  const updateBodegaBanner = () => {
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    const banner = document.getElementById("bodega-banner");
    if (!bodegaField || !banner) return;
    const selectedName = bodegaField.options[bodegaField.selectedIndex]?.text || "Central";
    const isTraslado = isTrasladoSelected();
    const destinoName = bodegaDestinoField?.selectedOptions?.[0]?.text || "";
    banner.innerHTML = isTraslado && destinoName
      ? `<i class="bi bi-arrow-left-right"></i><span class="fw-semibold">Traslado de ${selectedName} hacia ${destinoName}</span>`
      : `<i class="bi bi-box-arrow-up"></i><span class="fw-semibold">Egreso de mercaderia en Bodega ${selectedName}</span>`;
  };

  const syncTrasladoMode = () => {
    const isTraslado = isTrasladoSelected();
    if (bodegaDestinoWrap) {
      bodegaDestinoWrap.classList.toggle("d-none", !isTraslado);
    }
    if (bodegaDestinoField) {
      bodegaDestinoField.required = !!isTraslado;
      if (!isTraslado) {
        bodegaDestinoField.value = "";
      }
    }
    updateBodegaBanner();
  };

  const syncBodegaGate = () => {
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    if (!productSearch || !bodegaField) return;
    const hasBodega = !!bodegaField.value;
    productSearch.disabled = !hasBodega;
    if (!hasBodega) {
      productSearch.value = "";
      filterProductRows("");
      updateBodegaBanner();
      return;
    }
    updateSaldoCells();
    updateBodegaBanner();
  };

  const formatSaldoValue = (value) => {
    const numeric = Number(value);
    if (!Number.isFinite(numeric)) return "0";
    if (Number.isInteger(numeric)) {
      return String(numeric);
    }
    return numeric.toFixed(2);
  };

  const updateSaldoCells = () => {
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    if (!bodegaField) return;
    const bodegaId = bodegaField.value;
    if (!bodegaId) return;
    document.querySelectorAll(".product-pick-row").forEach((row) => {
      let saldo = 0;
      const raw = row.dataset.saldos;
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          saldo = parsed?.[bodegaId] ?? 0;
        } catch {}
      }
      const cell = row.querySelector(".saldo-cell");
      if (cell) {
        cell.textContent = formatSaldoValue(saldo);
      }
      const qtyInput = row.querySelector(".qty-input");
      if (qtyInput) {
        qtyInput.max = String(saldo || 0);
      }
      const addButton = row.querySelector(".add-item");
      if (addButton) {
        addButton.dataset.existencia = String(saldo || 0);
      }
    });
  };

  const wireSaldoRefresh = () => {
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    if (!bodegaField) return;
    bodegaField.addEventListener("change", updateSaldoCells);
    bodegaField.addEventListener("change", syncBodegaGate);
    if (window.$ && $.fn.select2) {
      $(bodegaField).on("select2:select", updateSaldoCells);
      $(bodegaField).on("select2:select", syncBodegaGate);
      $(bodegaField).on("select2:clear", updateSaldoCells);
      $(bodegaField).on("select2:clear", syncBodegaGate);
      $(bodegaField).on("change.select2", updateSaldoCells);
      $(bodegaField).on("change.select2", syncBodegaGate);
    }
    updateBodegaBanner();
  };

  const focusSelect = (selectEl) => {
    if (!selectEl) return;
    if (window.$ && $.fn.select2) {
      $(selectEl).select2("open");
      return;
    }
    selectEl.focus();
  };

  const wireProductRow = (row) => {
    if (!handleAddItem) return;
    const addButton = row.querySelector(".add-item");
    if (addButton) {
      addButton.addEventListener("click", () => handleAddItem(addButton, "search"));
    }
    const qtyInput = row.querySelector(".qty-input");
    if (qtyInput) {
      qtyInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          if (addButton) {
            handleAddItem(addButton, "cost");
          }
        }
      });
    }
  };

  const appendProductToList = (payload, lineaId, segmentoId) => {
    if (!productList) return;
    const row = document.createElement("tr");
    row.className = "product-pick-row border-b border-slate-50";
    row.dataset.name = payload.descripcion || "";
    row.dataset.code = payload.cod_producto || "";
    row.dataset.saldos = "{}";
    row.innerHTML = `
      <td class="px-3 py-2 font-semibold text-ink">${payload.cod_producto || ""}</td>
      <td class="px-3 py-2 text-slate">${payload.descripcion || ""}</td>
      <td class="px-3 py-2 text-right text-slate">$ ${parseFloat(payload.costo_usd || 0).toFixed(2)}</td>
      <td class="px-3 py-2 text-right text-slate">$ ${parseFloat(payload.precio_venta1_usd || 0).toFixed(2)}</td>
      <td class="px-3 py-2 text-right text-slate saldo-cell">0</td>
      <td class="px-3 py-2 text-right">
        <input class="qty-input w-16 rounded-lg border border-slate-200 px-2 py-1 text-right bg-white" type="number" step="1" min="1" max="0" value="1" />
      </td>
      <td class="px-3 py-2 text-center">
        <button
          class="add-item inline-flex items-center justify-center w-8 h-8 rounded-lg border border-slate-200 bg-white text-ink hover:bg-slate-50 shadow-sm"
          type="button"
          data-product-id="${payload.id}"
          data-code="${payload.cod_producto || ""}"
          data-name="${payload.descripcion || ""}"
          data-existencia="0"
          data-cost-usd="${parseFloat(payload.costo_usd || 0).toFixed(2)}"
          data-cost-cs="${parseFloat(payload.costo_cs || 0).toFixed(2)}"
          data-price-usd="${parseFloat(payload.precio_venta1_usd || 0).toFixed(2)}"
          data-price-cs="${parseFloat(payload.precio_venta1 || 0).toFixed(2)}"
        >
          <i class="bi bi-plus"></i>
        </button>
      </td>
    `;
    productList.prepend(row);
    wireProductRow(row);
    if (typeof updateSaldoCells === "function") {
      updateSaldoCells();
    }
    if (typeof updateBodegaBanner === "function") {
      updateBodegaBanner();
    }
  };

  const serializeItems = () => {
    return Array.from(itemsTable.querySelectorAll("tr[data-item-row]")).map((row) => {
      const qtyInput = row.querySelector(".row-qty");
      const costInput = row.querySelector(".row-cost");
      const priceInput = row.querySelector(".row-price");
      const productId = row.querySelector("input[name='item_producto_id']")?.value || "";
      const qtyHidden = row.querySelector("input[name='item_cantidad']")?.value || "";
      const nameCell = row.querySelectorAll("td")[0]?.textContent || "";
      return {
        productId,
        name: nameCell,
        qty: qtyInput ? qtyInput.value : qtyHidden,
        cost: costInput ? costInput.value : "0",
        price: priceInput ? priceInput.value : "0",
      };
    });
  };

  const saveDraft = () => {
    if (!ingresoForm) return;
    const bodegaField = ingresoForm.querySelector("select[name='bodega_id']");
    const obs = ingresoForm.querySelector("input[name='observacion']");
    const draft = {
      tipo: tipoField?.value || "",
      fecha: fechaField?.value || "",
      bodega: bodegaField?.value || "",
      bodegaDestino: bodegaDestinoField?.value || "",
      moneda: monedaField?.value || "USD",
      observacion: obs?.value || "",
      allowDecimals: !!allowDecimals?.checked,
      items: serializeItems(),
    };
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(draft));
    } catch {}
  };

  const restoreDraft = () => {
    let raw = null;
    try {
      raw = localStorage.getItem(STORAGE_KEY);
    } catch {}
    if (!raw) return;
    let draft = null;
    try {
      draft = JSON.parse(raw);
    } catch {
      return;
    }
    if (!draft) return;
    if (tipoField) tipoField.value = draft.tipo || "";
    if (fechaField) fechaField.value = draft.fecha || "";
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    if (bodegaField) bodegaField.value = draft.bodega || "";
    if (bodegaDestinoField) bodegaDestinoField.value = draft.bodegaDestino || "";
    if (monedaField) monedaField.value = draft.moneda || "USD";
    const obs = ingresoForm?.querySelector("input[name='observacion']");
    if (obs) obs.value = draft.observacion || "";
    if (allowDecimals) allowDecimals.checked = !!draft.allowDecimals;
    if (window.$ && $.fn.select2) {
      $(".select2").trigger("change");
    }
    syncTrasladoMode();
    if (itemsTable) {
      itemsTable.innerHTML = `<tr id="empty-items"><td colspan="6" class="text-center py-3 text-slate">Sin items agregados</td></tr>`;
    }
    if (Array.isArray(draft.items)) {
      draft.items.forEach((item) => {
        if (!item.productId) return;
        const qty = parseFloat(item.qty || 0) || 1;
        const cost = parseFloat(item.cost || 0) || 0;
        const price = parseFloat(item.price || 0) || 0;
        const subtotal = cost * qty;
        const subtotalUsd = monedaField?.value === "USD" ? subtotal : (rateToday ? subtotal / rateToday : 0);
        const subtotalCs = monedaField?.value === "USD" ? subtotal * rateToday : subtotal;
        addItemRow({
          productId: item.productId,
          code: "",
          name: item.name || "",
          qtyLabel: formatQtyLabel(qty),
          qtyValue: allowDecimals && allowDecimals.checked ? qty.toFixed(2) : Math.trunc(qty).toFixed(2),
          qtyValueDisplay: allowDecimals && allowDecimals.checked ? qty.toFixed(2) : Math.trunc(qty).toString(),
          qtyStep: allowDecimals && allowDecimals.checked ? "0.01" : "1",
          costValue: cost.toFixed(2),
          priceValue: price.toFixed(2),
          subtotalLabel: monedaField?.value === "USD" ? `$ ${subtotal.toFixed(2)}` : `C$ ${subtotal.toFixed(2)}`,
          subtotalUsd,
          subtotalCs,
          focusTarget: "search",
        });
      });
      updateTotals();
    }
    if (typeof updateSaldoCells === "function") {
      updateSaldoCells();
    }
  };



  window.addEventListener("load", () => {
  if (tipoField) {
    tipoField.addEventListener("change", syncTrasladoMode);
    if (window.$ && $.fn.select2) {
      $(tipoField).on("select2:select", syncTrasladoMode);
      $(tipoField).on("change.select2", syncTrasladoMode);
    }
  }
  if (bodegaDestinoField) {
    bodegaDestinoField.addEventListener("change", updateBodegaBanner);
    if (window.$ && $.fn.select2) {
      $(bodegaDestinoField).on("select2:select", updateBodegaBanner);
      $(bodegaDestinoField).on("change.select2", updateBodegaBanner);
    }
  }
  if (fechaField && window.$ && $.fn.datepicker) {
    $(fechaField).datepicker({
      format: "yyyy-mm-dd",
      autoclose: true,
      todayHighlight: true,
      language: "es",
    });
    if (!fechaField.value) {
      const now = new Date();
      const formatted = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
      fechaField.value = formatted;
      $(fechaField).datepicker("update", formatted);
    }
  } else if (fechaField && !fechaField.value) {
    const now = new Date();
    fechaField.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
  }

  if (window.$ && $.fn.select2) {
    $(".select2").select2({
      width: "style",
      placeholder: "Selecciona",
      allowClear: true,
    });
  }
  restoreDraft();
  wireSaldoRefresh();
  updateSaldoCells();
  syncBodegaGate();
  if (productSearch) {
    filterProductRows(productSearch.value || "");
  }
  setEgresoView("form");

  if (window.DataTable) {
    const egresosTable = new DataTable("#egresos-table", {
      searching: true,
      paging: true,
      info: true,
      lengthChange: false,
      order: [[0, "desc"]],
      language: {
        search: "Buscar:",
        lengthMenu: "Mostrar _MENU_",
        info: "Mostrando _START_ a _END_ de _TOTAL_",
        infoEmpty: "Sin registros",
        zeroRecords: "Sin coincidencias",
        emptyTable: "Sin egresos registrados",
        paginate: {
          next: "Siguiente",
          previous: "Anterior",
        },
      },
      dom: "Brtip",
      buttons: ["copy", "excel", "pdf", "print"],
    });
  }

  const errorBanner = document.querySelector("[data-error-banner]");
  if (errorBanner) {
    errorBanner.style.display = "none";
  }
  const successBanner = document.querySelector("[data-success-banner]");
  if (successBanner) {
    successBanner.style.display = "none";
  }
  {% if error %}
  if (typeof Swal !== "undefined") {
    Swal.fire({
      icon: "error",
      title: "Atencion",
      text: "{{ error }}",
      confirmButtonText: "Entendido",
    });
  }
  {% endif %}
  {% if success %}
  if (typeof Swal !== "undefined") {
    Swal.fire({
      icon: "success",
      title: "Egreso registrado",
      text: "{{ success }}",
      timer: 1800,
      showConfirmButton: false,
    });
  }
  {% endif %}
  {% if print_id %}
  window.open("/inventory/egresos/{{ print_id }}/pdf", "_blank");
  {% endif %}
  });

  if (productSearch) {
    productSearch.addEventListener("input", (event) => {
      const value = event.target.value.toLowerCase().trim();
      updateSaldoCells();
      filterProductRows(value);
    });
    productSearch.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      event.preventDefault();
      const firstVisible = Array.from(productList.querySelectorAll(".product-pick-row"))
        .find((row) => row.style.display !== "none");
      if (!firstVisible) return;
      const qtyInput = firstVisible.querySelector(".qty-input");
      if (qtyInput) {
        qtyInput.focus();
        qtyInput.select();
      }
    });
  }

  const addItemRow = (payload) => {
    if (emptyItems) {
      emptyItems.remove();
    }
    const row = document.createElement("tr");
    row.dataset.itemRow = "1";
    row.dataset.subtotalUsd = payload.subtotalUsd.toFixed(2);
    row.dataset.subtotalCs = payload.subtotalCs.toFixed(2);
    row.dataset.maxQty = payload.maxQty.toFixed(2);
    row.innerHTML = `
      <td class="px-3 py-2">${payload.code} - ${payload.name}</td>
      <td class="px-3 py-2 text-right">
        <input class="row-qty w-20 rounded-lg border border-slate-200 px-2 py-1 text-right bg-white" type="number" step="${payload.qtyStep}" min="1" max="${payload.maxQty}" value="${payload.qtyValueDisplay}" />
      </td>
      <td class="px-3 py-2 text-right">
        <input class="row-cost w-24 rounded-lg border border-slate-200 px-2 py-1 text-right" type="number" step="0.01" min="0" value="${payload.costValue}" name="item_costo" />
      </td>
      <td class="px-3 py-2 text-right">
        <input class="row-price w-24 rounded-lg border border-slate-200 px-2 py-1 text-right" type="number" step="0.01" min="0" value="${payload.priceValue}" name="item_precio" />
      </td>
      <td class="px-3 py-2 text-right">${payload.subtotalLabel}</td>
      <td class="px-3 py-2 text-center">
        <button class="remove-item text-red-600" type="button"><i class="bi bi-x-circle"></i></button>
      </td>
      <input type="hidden" name="item_producto_id" value="${payload.productId}" />
      <input type="hidden" name="item_cantidad" value="${payload.qtyValue}" />
    `;
    itemsTable.appendChild(row);
    updateTotals();
    const focusTarget = payload.focusTarget || "qty";
    itemsTable.querySelectorAll(".row-active").forEach((el) => el.classList.remove("row-active"));
    row.classList.add("row-active");
    if (focusTarget === "search") {
      return;
    }
    if (focusTarget === "cost") {
      const costInput = row.querySelector(".row-cost");
      if (costInput) {
        costInput.focus();
        costInput.select();
      }
      return;
    }
    const qtyInput = row.querySelector(".row-qty");
    if (qtyInput) {
      qtyInput.focus();
      qtyInput.select();
    }
  };

  const parseQty = (value) => {
    const raw = parseFloat(value || 0);
    if (!allowDecimals || !allowDecimals.checked) {
      return Math.max(1, Math.round(raw));
    }
    return raw;
  };

  const formatQtyLabel = (qty) => {
    if (!allowDecimals || !allowDecimals.checked) {
      return Math.trunc(qty).toString();
    }
    return qty.toFixed(2);
  };

  if (allowDecimals) {
    allowDecimals.addEventListener("change", () => {
      productList.querySelectorAll(".qty-input").forEach((input) => {
        if (allowDecimals.checked) {
          input.step = "0.01";
        } else {
          input.step = "1";
          input.value = Math.max(1, Math.round(parseFloat(input.value || 1)));
        }
      });
      itemsTable.querySelectorAll(".row-qty").forEach((input) => {
        if (allowDecimals.checked) {
          input.step = "0.01";
        } else {
          input.step = "1";
          input.value = Math.max(1, Math.round(parseFloat(input.value || 1)));
        }
      });
    });
  }

  if (productList) {
    handleAddItem = (button, focusTarget) => {
      const row = button.closest("tr");
      const qtyInput = row.querySelector(".qty-input");
      const qty = parseQty(qtyInput.value);
      const maxQty = parseFloat(button.dataset.existencia || 0);
      if (qty <= 0) return;
      if (!maxQty || maxQty <= 0) {
        if (typeof Swal !== "undefined") {
          Swal.fire({
            icon: "warning",
            title: "Sin existencia",
            text: "No hay saldo disponible para este producto.",
          });
        }
        return;
      }
      if (qty > maxQty) {
        if (typeof Swal !== "undefined") {
          Swal.fire({
            icon: "warning",
            title: "Cantidad mayor al saldo",
            text: `Disponible: ${maxQty}`,
          });
        }
        return;
      }

      const moneda = monedaField.value || "USD";
      const costUsd = parseFloat(button.dataset.costUsd || 0);
      const costCs = parseFloat(button.dataset.costCs || 0);
      const priceUsd = parseFloat(button.dataset.priceUsd || 0);
      const priceCs = parseFloat(button.dataset.priceCs || 0);
      const cost = moneda === "USD" ? costUsd : costCs;
      const price = moneda === "USD" ? priceUsd : priceCs;
      const subtotal = cost * qty;
      const subtotalUsd = moneda === "USD" ? subtotal : (rateToday ? subtotal / rateToday : 0);
      const subtotalCs = moneda === "USD" ? subtotal * rateToday : subtotal;

      addItemRow({
        productId: button.dataset.productId,
        code: button.dataset.code,
        name: button.dataset.name,
        qtyLabel: formatQtyLabel(qty),
        qtyValue: allowDecimals && allowDecimals.checked ? qty.toFixed(2) : Math.trunc(qty).toFixed(2),
        qtyValueDisplay: allowDecimals && allowDecimals.checked ? qty.toFixed(2) : Math.trunc(qty).toString(),
        qtyStep: allowDecimals && allowDecimals.checked ? "0.01" : "1",
        maxQty: maxQty,
        costValue: cost.toFixed(2),
        priceValue: price.toFixed(2),
        subtotalLabel: moneda === "USD" ? `$ ${subtotal.toFixed(2)}` : `C$ ${subtotal.toFixed(2)}`,
        subtotalUsd,
        subtotalCs,
        focusTarget: focusTarget || "qty",
      });
      if (productSearch && focusTarget === "search") {
        productSearch.value = "";
        productSearch.focus();
      }
      saveDraft();
    };

    productList.querySelectorAll(".add-item").forEach((button) => {
      button.addEventListener("click", (event) => {
        handleAddItem(event.currentTarget, "search");
      });
    });

    productList.querySelectorAll(".qty-input").forEach((input) => {
      input.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          const row = input.closest("tr");
          const button = row.querySelector(".add-item");
          if (button) {
            handleAddItem(button, "cost");
          }
        }
      });
    });
  }

  if (itemsTable) {
    itemsTable.addEventListener("click", (event) => {
      const button = event.target.closest(".remove-item");
      if (!button) return;
      const row = button.closest("tr");
      row.remove();
      if (itemsTable.querySelectorAll("tr[data-item-row]").length === 0) {
        itemsTable.innerHTML = `<tr id="empty-items"><td colspan="6" class="text-center py-3 text-slate">Sin items agregados</td></tr>`;
      }
      updateTotals();
      saveDraft();
    });
    itemsTable.addEventListener("focusin", (event) => {
      const row = event.target.closest("tr");
      if (!row || !row.dataset.itemRow) return;
      itemsTable.querySelectorAll(".row-active").forEach((el) => el.classList.remove("row-active"));
      row.classList.add("row-active");
    });
    itemsTable.addEventListener("input", (event) => {
      const row = event.target.closest("tr");
      if (!row) return;
      const qtyInput = row.querySelector(".row-qty");
      const costInput = row.querySelector(".row-cost");
      if (!qtyInput && !costInput) return;
      const qtyHidden = row.querySelector("input[name='item_cantidad']");
      let qty = parseFloat(qtyInput ? qtyInput.value : (qtyHidden ? qtyHidden.value : 0));
      const maxQty = parseFloat(row.dataset.maxQty || 0);
      if (maxQty && qty > maxQty && qtyInput) {
        qty = allowDecimals && allowDecimals.checked ? maxQty : Math.trunc(maxQty);
        qtyInput.value = allowDecimals && allowDecimals.checked ? maxQty.toFixed(2) : Math.trunc(maxQty).toString();
        if (qtyHidden) {
          qtyHidden.value = allowDecimals && allowDecimals.checked ? maxQty.toFixed(2) : Math.trunc(maxQty).toFixed(2);
        }
        if (typeof Swal !== "undefined") {
          Swal.fire({
            icon: "warning",
            title: "Cantidad mayor al saldo",
            text: `Disponible: ${maxQty}`,
          });
        }
      }
      const cost = parseFloat(costInput ? costInput.value : 0);
      if (qtyHidden && qtyInput) {
        qtyHidden.value = allowDecimals && allowDecimals.checked ? qty.toFixed(2) : Math.trunc(qty).toFixed(2);
      }
      const subtotal = cost * qty;
      const moneda = monedaField.value || "USD";
      row.dataset.subtotalUsd = moneda === "USD" ? subtotal.toFixed(2) : (rateToday ? (subtotal / rateToday).toFixed(2) : "0.00");
      row.dataset.subtotalCs = moneda === "USD" ? (subtotal * rateToday).toFixed(2) : subtotal.toFixed(2);
      const subtotalCell = row.querySelectorAll("td")[4];
      subtotalCell.textContent = moneda === "USD" ? `$ ${subtotal.toFixed(2)}` : `C$ ${subtotal.toFixed(2)}`;
      updateTotals();
      saveDraft();
    });
    itemsTable.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      const qtyInput = event.target.closest(".row-qty");
      const costInput = event.target.closest(".row-cost");
      const priceInput = event.target.closest(".row-price");
      if (qtyInput) {
        event.preventDefault();
        const row = qtyInput.closest("tr");
        const nextCost = row.querySelector(".row-cost");
        if (nextCost) {
          nextCost.focus();
          nextCost.select();
        }
        return;
      }
      if (costInput) {
        event.preventDefault();
        const row = costInput.closest("tr");
        const nextPrice = row.querySelector(".row-price");
        if (nextPrice) {
          nextPrice.focus();
          nextPrice.select();
        }
        return;
      }
      if (priceInput) {
        event.preventDefault();
        if (productSearch) {
          productSearch.value = "";
          productSearch.focus();
        }
      }
    });
  }

  if (ingresoForm) {
    ingresoForm.addEventListener("input", saveDraft);
    ingresoForm.addEventListener("change", saveDraft);
    ingresoForm.addEventListener("submit", () => {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch {}
    });
  }

  const validateIngresoRequired = () => {
    const missing = [];
    if (!tipoField?.value) missing.push("Tipo de egreso");
    if (!fechaField?.value) missing.push("Fecha");
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    if (!bodegaField?.value) missing.push("Bodega");
    const isTraslado = isTrasladoSelected();
    if (isTraslado && !bodegaDestinoField?.value) missing.push("Bodega destino");
    if (isTraslado && bodegaField?.value && bodegaDestinoField?.value && bodegaField.value === bodegaDestinoField.value) {
      missing.push("Destino distinto al origen");
    }
    if (missing.length) {
      const errorBanner = document.getElementById("egreso-client-error");
      if (errorBanner) {
        errorBanner.textContent = `Faltan: ${missing.join(", ")}`;
        errorBanner.classList.remove("d-none");
      }
      if (typeof Swal !== "undefined") {
        Swal.fire({
          icon: "warning",
          title: "Campos obligatorios",
          text: `Faltan: ${missing.join(", ")}`,
        });
      } else {
        alert(`Faltan: ${missing.join(", ")}`);
      }
      return false;
    }
    const errorBanner = document.getElementById("egreso-client-error");
    if (errorBanner) {
      errorBanner.classList.add("d-none");
      errorBanner.textContent = "";
    }
    return true;
  };

  if (ingresoForm) {
    ingresoForm.addEventListener("submit", (event) => {
      const itemsCount = itemsTable?.querySelectorAll("tr[data-item-row]").length || 0;
      if (!itemsCount) {
        event.preventDefault();
        const errorBanner = document.getElementById("egreso-client-error");
        if (errorBanner) {
          errorBanner.textContent = "Agrega productos al egreso antes de registrar.";
          errorBanner.classList.remove("d-none");
        }
        if (typeof Swal !== "undefined") {
          Swal.fire({
            icon: "warning",
            title: "Egreso vacio",
            text: "Agrega productos al egreso antes de registrar.",
          });
        } else {
          alert("Agrega productos al egreso antes de registrar.");
        }
        return;
      }
      if (!validateIngresoRequired()) {
        event.preventDefault();
        return;
      }
    });
  }

  const submitEgresoButton = document.getElementById("submit-egreso");
  if (submitEgresoButton && ingresoForm) {
    submitEgresoButton.addEventListener("click", (event) => {
      event.preventDefault();
      ingresoForm.requestSubmit();
    });
  }

  const clearDraftButton = document.getElementById("clear-draft");
  if (clearDraftButton) {
    clearDraftButton.addEventListener("click", () => {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch {}
      if (ingresoForm) {
        ingresoForm.reset();
        if (window.$ && $.fn.select2) {
          $(".select2").val(null).trigger("change");
        }
      }
      if (itemsTable) {
        itemsTable.innerHTML = `<tr id="empty-items"><td colspan="6" class="text-center py-3 text-slate">Sin items agregados</td></tr>`;
      }
      if (bodegaDestinoField) {
        bodegaDestinoField.value = "";
      }
      updateTotals();
      syncTrasladoMode();
      if (productSearch) {
        productSearch.value = "";
        productSearch.focus();
      }
    });
  }

  window.addEventListener("beforeunload", saveDraft);
</script>
{% endblock %}
