{% extends "base.html" %}
{% block content %}
<style>
  .ingreso-modal {
    font-family: "Inter", "Segoe UI", Tahoma, sans-serif;
    color: #0f172a;
  }
  .ingreso-modal .odoo-modal-header {
    background: #ffffff;
    border-bottom: 1px solid #e2e8f0;
  }
  .ingreso-modal .ingreso-panel-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
  }
  .ingreso-modal .odoo-accent {
    color: #1d4ed8;
  }
  .ingreso-modal .ingreso-muted {
    color: #64748b;
  }
  .ingreso-modal .odoo-table-head {
    background: #f8fafc;
    color: #1e293b;
  }
  .ingreso-modal .odoo-pill {
    background: #eef2ff;
    color: #3730a3;
  }
  .ingreso-modal .row-active {
    background: #eff6ff;
    border-left: 3px solid #3b82f6;
  }
  .ingreso-modal .search-panel {
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    background: #ffffff;
    box-shadow: 0 10px 22px rgba(15, 23, 42, 0.06);
  }
  .ingreso-modal .totals-bar {
    border-top: 1px dashed #e2e8f0;
    padding-top: 0.75rem;
  }
  .ingreso-modal .totals-bar .label {
    font-size: 0.85rem;
    color: #64748b;
  }
  .ingreso-modal .totals-bar .value {
    font-weight: 600;
    color: #0f172a;
  }
  .inventory-compact-header .odoo-title {
    font-size: 1.35rem;
    margin-top: 0.25rem;
  }
  .inventory-compact-header .odoo-subtitle {
    font-size: 0.9rem;
    margin-top: 0.1rem;
  }
  .inventory-compact-header .breadcrumb {
    margin-bottom: 0.25rem;
  }
  .inventory-tabs .nav-link {
    padding: 0.35rem 0.75rem;
    font-size: 0.9rem;
  }
  .movement-meta-grid .form-label {
    display: flex;
    align-items: center;
    margin-bottom: 0.2rem;
    line-height: 1rem;
    font-size: 0.82rem;
    font-weight: 600;
  }
  .movement-meta-grid .form-control,
  .movement-meta-grid .form-select {
    min-height: 32px;
    padding-top: 0.2rem;
    padding-bottom: 0.2rem;
    font-size: 0.86rem;
  }
  .movement-meta-grid .select2-container--default .select2-selection--single {
    min-height: 32px;
    display: flex;
    align-items: center;
  }
  .movement-meta-grid .select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 30px;
    font-size: 0.86rem;
  }
  .movement-meta-grid .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 30px;
  }
  .movement-meta-grid .movement-meta-item {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }
</style>
<div id="layout" class="min-h-screen grid lg:grid-cols-[260px_1fr] bg-surface">
  {% include "partials/sidebar.html" %}

  <main class="p-6 lg:p-8 text-[18px]">
    <div class="odoo-page">
      <div class="odoo-header inventory-compact-header">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 position-relative">
          <div>
            <button class="toggle-sidebar sidebar-toggle-show btn btn-sm btn-outline-secondary mb-2" type="button">
              <i class="bi bi-layout-sidebar"></i>
              Mostrar menu
            </button>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item">Inventario</li>
                <li class="breadcrumb-item active" aria-current="page">Ingresos</li>
              </ol>
            </nav>
            <div class="odoo-title mt-2">Ingresos de inventario</div>
            <div class="odoo-subtitle mt-1">Registro de compras, importaciones y ajustes.</div>
          </div>
          <div class="odoo-toolbar">
            <div class="odoo-pill primary">
              <i class="bi bi-currency-exchange"></i>
              {% if rate_today %}
                Tasa C$ {{ "%.4f"|format(rate_today.rate) }}
              {% else %}
                Sin tasa
              {% endif %}
            </div>
          </div>
        </div>
        <ul class="nav nav-tabs mt-2 inventory-tabs">
          <li class="nav-item">
            <a class="nav-link" href="/inventory">Catalogo de productos</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/inventory/ingresos">Ingresos de inventario</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/inventory/egresos">Egresos de inventario</a>
          </li>
        </ul>
      </div>

      <div class="odoo-kpis">
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-journal-check text-blue-600"></i>
            Ingresos
          </div>
          <strong>{{ ingresos|length }}</strong>
        </div>
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-box-seam text-emerald-600"></i>
            Productos
          </div>
          <strong>{{ productos|length }}</strong>
        </div>
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-building text-violet-600"></i>
            Proveedores
          </div>
          <strong>{{ proveedores|length }}</strong>
        </div>
        <div class="odoo-kpi">
          <div class="text-[11px] uppercase tracking-[0.2em] text-slate inline-flex items-center gap-2">
            <i class="bi bi-house-door text-rose-600"></i>
            Bodegas
          </div>
          <strong>{{ bodegas|length }}</strong>
        </div>
      </div>

    {% if error %}
    <div class="mt-4 rounded-xl border border-red-200 bg-red-50 text-red-700 px-4 py-2" data-error-banner>
      {{ error }}
    </div>
    {% endif %}
    {% if success %}
    <div class="mt-4 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-700 px-4 py-2" data-success-banner>
      {{ success }}
    </div>
    {% endif %}

      <div class="card shadow-sm border-0">
        <div class="card-body p-3 p-lg-4">
        <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-3">
          <div>
            <div class="text-uppercase text-muted small">Inventario / Ingresos</div>
            <h5 class="mb-1 fw-semibold">Movimientos de inventario</h5>
            <div class="text-muted small">Registra ingresos y controla existencias por bodega.</div>
          </div>
          <span class="badge bg-light text-dark border">ERP Inventarios</span>
        </div>
        <ul class="nav nav-tabs mb-2 inventory-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active py-1 px-3 small" id="ingreso-form-tab" type="button">
              <i class="bi bi-box-arrow-in-down"></i>
              Registrar ingreso
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link py-1 px-3 small" id="ingreso-list-tab" type="button">
              <i class="bi bi-list-check"></i>
              Ingresos registrados
            </button>
          </li>
        </ul>
        <section id="ingreso-form-section">
            <div id="ingreso-panel" class="odoo-card ingreso-modal bg-white shadow-sm">
    <div class="odoo-modal-header flex items-center justify-between">
      <div>
        <div class="odoo-breadcrumb">Inventario / Ingresos</div>
        <div class="odoo-section-title text-2xl tracking-tight">Nuevo ingreso</div>
        <div class="text-sm text-slate mt-1">Registro de entradas de inventario</div>
      </div>
          </div>
    <div class="px-6 pt-2">
      <div class="flex flex-wrap gap-2 odoo-tabs odoo-modal-tabs">
        <button class="ingreso-tab btn btn-sm btn-primary d-inline-flex align-items-center gap-2" data-target="tab-ingreso" type="button">
          <i class="bi bi-box-arrow-in-down"></i>
          Ingreso
        </button>
        <button class="ingreso-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-proveedor" type="button">
          <i class="bi bi-truck"></i>
          Proveedor
        </button>
        <button class="ingreso-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-proveedor-edit" type="button">
          <i class="bi bi-pencil"></i>
          Editar proveedor
        </button>
        <button class="ingreso-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-producto" type="button">
          <i class="bi bi-boxes"></i>
          Nuevo producto
        </button>
        <button class="ingreso-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-producto-edit" type="button">
          <i class="bi bi-pencil"></i>
          Editar producto
        </button>
        <button class="ingreso-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-linea" type="button">
          <i class="bi bi-tags"></i>
          Linea
        </button>
        <button class="ingreso-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-segmento" type="button">
          <i class="bi bi-grid-3x3-gap"></i>
          Segmento
        </button>
        <button class="ingreso-tab btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-2" data-target="tab-import" type="button">
          <i class="bi bi-file-earmark-arrow-up"></i>
          Importar
        </button>
      </div>
    </div>
    <div class="px-6 pb-4 pt-2 space-y-4 overflow-y-auto max-h-[70vh] odoo-modal-body">
      <div id="tab-ingreso" class="ingreso-panel">
        <form id="ingreso-form" method="post" action="/inventory/ingresos" class="space-y-4 text-sm" novalidate>
          <div id="bodega-banner" class="alert alert-info py-2 px-3 mb-2 d-flex align-items-center gap-2" role="status">
            <i class="bi bi-house-door"></i>
            <span class="fw-semibold">Ingreso de mercaderia en Bodega Central</span>
          </div>
          <div id="ingreso-client-error" class="alert alert-warning py-2 px-3 mb-2 d-none" role="alert"></div>
          <div class="odoo-modal-section">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="odoo-modal-title">Datos del ingreso</div>
              <span class="odoo-pill">Campos obligatorios *</span>
            </div>
            <div class="row g-2 align-items-start movement-meta-grid">
              <div class="col-12 col-md-6 col-xl-3 movement-meta-item">
                <label class="form-label text-sm font-semibold text-ink">
                  <i class="bi bi-journal-plus text-brand me-1"></i>
                  Tipo de ingreso *
                </label>
                <select id="field-tipo" name="tipo_id" class="odoo-input form-select form-select-sm select2 odoo-select2 w-100">
                  <option value="">Selecciona</option>
                  {% for tipo in tipos %}
                  <option value="{{ tipo.id }}" data-requiere-proveedor="{{ 1 if tipo.requiere_proveedor else 0 }}">{{ tipo.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-6 col-xl-3 movement-meta-item">
                <label class="form-label text-sm font-semibold text-ink">
                  <i class="bi bi-calendar-event text-brand me-1"></i>
                  Fecha *
                </label>
                <input id="field-fecha" name="fecha" type="text" class="odoo-input form-control form-control-sm datepicker w-100" placeholder="Selecciona fecha" />
              </div>
              <div class="col-12 col-md-6 col-xl-3 movement-meta-item">
                <label class="form-label text-sm font-semibold text-ink">
                  <i class="bi bi-box-seam text-brand me-1"></i>
                  Bodega *
                </label>
                <select name="bodega_id" class="odoo-input form-select form-select-sm select2 odoo-select2 w-100">
                  <option value="">Selecciona</option>
                  {% for bodega in bodegas %}
                  <option value="{{ bodega.id }}" {% if user.default_bodega_id == bodega.id or (not user.default_bodega_id and bodega.code == "central") %}selected{% endif %}>{{ bodega.name }}</option>
              {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-6 col-xl-3 movement-meta-item">
                <label class="form-label text-sm font-semibold text-ink">
                  <i class="bi bi-building text-brand me-1"></i>
                  Proveedor
                </label>
                <select id="field-proveedor" name="proveedor_id" class="odoo-input form-select form-select-sm select2 odoo-select2 w-100">
                  <option value="">Selecciona</option>
                  {% for proveedor in proveedores %}
                  <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                  {% endfor %}
                </select>
                <div class="d-flex gap-2 mt-2">
                  <button id="quick-toggle-proveedor" type="button" class="btn btn-sm btn-outline-secondary" aria-expanded="false">
                    + Nuevo proveedor
                  </button>
                </div>
                <div id="quick-new-proveedor-wrap" class="mt-2 d-none border rounded-3 p-2 bg-light">
                  <div class="row g-2">
                    <div class="col-12">
                      <input id="quick-proveedor-name" class="form-control form-control-sm" placeholder="Nombre del proveedor" />
                    </div>
                    <div class="col-12">
                      <input id="quick-proveedor-tipo" class="form-control form-control-sm" placeholder="Tipo (Local/Importacion)" />
                    </div>
                    <div class="col-12">
                      <label class="d-inline-flex align-items-center gap-2 text-sm text-slate">
                        <input id="quick-proveedor-activo" type="checkbox" class="accent-brand" checked />
                        Activo
                      </label>
                    </div>
                  </div>
                  <div class="mt-2 text-end">
                    <button id="quick-proveedor-create-btn" class="btn btn-sm btn-primary" type="button">Guardar proveedor</button>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-6 col-xl-3 movement-meta-item">
                <label class="form-label text-sm font-semibold text-ink">
                  <i class="bi bi-currency-exchange text-brand me-1"></i>
                  Moneda *
                </label>
                <select id="field-moneda" name="moneda" class="odoo-input form-select form-select-sm select2 odoo-select2 w-100" {% if inventory_cs_only %}data-cs-only="1"{% endif %}>
                  {% if inventory_cs_only %}
                  <option value="CS" selected>C$</option>
                  {% else %}
                  <option value="USD">USD</option>
                  <option value="CS">C$</option>
                  {% endif %}
                </select>
              </div>
              <div class="col-12 col-xl-9 movement-meta-item">
                <label class="form-label text-sm font-semibold text-ink">
                  <i class="bi bi-chat-square-text text-brand me-1"></i>
                  Observacion
                </label>
                <input name="observacion" class="odoo-input form-control form-control-sm" placeholder="Motivo u observacion" />
              </div>
            </div>
            <div class="flex flex-wrap items-center gap-3 text-base mt-3">
              <label class="inline-flex items-center gap-2 cursor-pointer text-slate">
                <input id="allow-decimals" type="checkbox" class="sr-only peer" />
                <span class="w-10 h-5 bg-slate-200 rounded-full peer-checked:bg-brand relative transition-colors">
                  <span class="absolute left-0.5 top-0.5 w-4 h-4 rounded-full bg-white shadow-sm transition-transform peer-checked:translate-x-5"></span>
                </span>
                Permitir decimales en cantidad
              </label>
              <span class="text-sm text-slate">Por defecto solo enteros.</span>
            </div>
          </div>
          <div class="row g-4">
            <div class="col-12">
              <div class="search-panel p-3 border rounded-3 bg-light">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                  <div>
                  <div class="odoo-modal-title odoo-accent">Productos a ingresar</div>
                  <div class="odoo-help ingreso-muted">Buscador de productos - filtro principal.</div>
                  </div>
                  <div class="d-flex flex-wrap align-items-center gap-2 w-100 justify-content-end">
                    <button id="open-new-product-quick" type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#quick-product-modal">
                      <i class="bi bi-plus-circle me-1"></i>
                      Nuevo producto rapido
                    </button>
                    <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden bg-white w-100 max-w-[520px]">
                      <span class="input-group-text bg-white border-0"><i class="bi bi-search text-brand"></i></span>
                      <input id="product-search" class="form-control border-0 text-uppercase" type="text" placeholder="BUSCAR PRODUCTO" />
                    </div>
                  </div>
                </div>
              <div class="odoo-table-wrap max-h-52 overflow-y-auto">
                <table class="table table-sm align-middle mb-0 odoo-table text-sm w-100">
                  <thead class="odoo-table-head text-xs uppercase tracking-[0.2em]">
                    <tr>
                      <th class="text-left px-3 py-2">Codigo</th>
                      <th class="text-left px-3 py-2">Descripcion</th>
                      <th class="text-right px-3 py-2">Costo {% if inventory_cs_only %}C${% else %}USD{% endif %}</th>
                      <th class="text-right px-3 py-2">Precio {% if inventory_cs_only %}C${% else %}USD{% endif %}</th>
                      <th class="text-right px-3 py-2">Saldo</th>
                      <th class="text-right px-3 py-2">Cantidad</th>
                      <th class="text-center px-3 py-2">Agregar</th>
                    </tr>
                  </thead>
                  <tbody id="product-list" class="ingreso-muted">
                    {% for p in productos %}
                    <tr class="product-pick-row border-b border-slate-50" style="display:none;" data-name="{{ p.descripcion }}" data-code="{{ p.cod_producto }}" data-saldos='{{ saldos_por_bodega[p.id]|tojson }}'>
                      <td class="px-3 py-2 font-semibold text-ink">{{ p.cod_producto }}</td>
                      <td class="px-3 py-2 text-slate">{{ p.descripcion }}</td>
                      <td class="px-3 py-2 text-right text-slate">
                        {% if inventory_cs_only %}
                        C$ {{ "%.2f"|format(p.costo_producto or 0) }}
                        {% else %}
                        $ {% if p.tasa_cambio %}{{ "%.2f"|format((p.costo_producto or 0) / p.tasa_cambio) }}{% else %}0.00{% endif %}
                        {% endif %}
                      </td>
                      <td class="px-3 py-2 text-right text-slate">{% if inventory_cs_only %}C$ {{ "%.2f"|format(p.precio_venta1 or 0) }}{% else %}$ {{ "%.2f"|format(p.precio_venta1_usd or 0) }}{% endif %}</td>
                      <td class="px-3 py-2 text-right text-slate saldo-cell">0</td>
      <td class="px-3 py-2 text-right">
        <input class="qty-input w-16 rounded-lg border border-slate-200 px-2 py-1 text-right bg-white" type="number" step="1" min="1" value="1" />
      </td>
                      <td class="px-3 py-2 text-center">
                        <button
                          class="add-item inline-flex items-center justify-center w-8 h-8 rounded-lg border border-slate-200 bg-white text-ink hover:bg-slate-50 shadow-sm"
                          type="button"
                          data-product-id="{{ p.id }}"
                          data-code="{{ p.cod_producto }}"
                          data-name="{{ p.descripcion }}"
                          data-cost-usd="{% if p.tasa_cambio %}{{ "%.2f"|format((p.costo_producto or 0) / p.tasa_cambio) }}{% else %}0{% endif %}"
                          data-cost-cs="{{ "%.2f"|format(p.costo_producto or 0) }}"
                          data-price-usd="{{ "%.2f"|format(p.precio_venta1_usd or 0) }}"
                          data-price-cs="{{ "%.2f"|format(p.precio_venta1 or 0) }}"
                        >
                          <i class="bi bi-plus"></i>
                        </button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="mt-3 mb-2 d-flex align-items-center justify-content-between">
              <div class="odoo-modal-title odoo-accent">Productos cargados a la vista de ingreso</div>
                <span class="odoo-pill">Items en lista</span>
              </div>
              <div class="odoo-table-wrap overflow-x-auto max-h-44 overflow-y-auto">
                <table class="table table-sm align-middle mb-0 odoo-table text-base w-100">
                  <thead class="odoo-table-head text-xs uppercase tracking-[0.15em]">
                    <tr>
                      <th class="text-left px-3 py-2">Producto</th>
                      <th class="text-right px-3 py-2">Cantidad</th>
                      <th class="text-right px-3 py-2">Costo</th>
                      <th class="text-right px-3 py-2">Precio</th>
                      <th class="text-right px-3 py-2">Subtotal</th>
                      <th class="text-center px-3 py-2">Quitar</th>
                    </tr>
                  </thead>
                  <tbody id="items-table" class="ingreso-muted">
                    <tr id="empty-items">
                      <td colspan="6" class="text-center py-3 text-slate">Sin items agregados</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="mt-2 d-flex flex-wrap gap-3 justify-content-end fw-bold text-dark">
                <span>Bultos cargados: <span id="items-bultos-live">0.00</span></span>
                <span>Items cargados: <span id="items-count-live">0</span></span>
              </div>
            </div>
          </div>
          <div class="totals-bar d-flex flex-wrap gap-4 align-items-center justify-content-end border-top pt-3">
            <div>
              <div class="label">Total bultos</div>
              <div id="total-bultos" class="value">0.00</div>
            </div>
            <div>
              <div class="label">Total items</div>
              <div id="total-items" class="value">0</div>
            </div>
            {% if not inventory_cs_only %}
            <div>
              <div class="label">Total USD</div>
              <div id="total-usd" class="value">$ 0.00</div>
            </div>
            {% endif %}
            <div>
              <div class="label">Total C$</div>
              <div id="total-cs" class="value">C$ 0.00</div>
            </div>
            <div class="label">
              {% if rate_today %}
                Tasa: C$ {{ "%.4f"|format(rate_today.rate) }}
              {% else %}
                Sin tasa configurada
              {% endif %}
            </div>
          </div>
          <div class="mt-2 mb-1 d-flex flex-wrap gap-4 justify-content-end fw-bold text-dark">
            <span>Total bultos: <span id="summary-bultos">0.00</span></span>
            <span>Total items: <span id="summary-items">0</span></span>
          </div>

          <div class="flex items-center justify-between pt-2">
            <div class="text-sm text-slate">Campos obligatorios *</div>
            <div class="d-flex align-items-center gap-2">
              <button id="clear-draft" class="btn btn-outline-secondary btn-md d-inline-flex align-items-center gap-2" type="button">
                <i class="bi bi-trash3"></i>
                Limpiar borrador
              </button>
              <button id="submit-ingreso" class="btn btn-primary btn-md d-inline-flex align-items-center gap-2" type="submit">
                <i class="bi bi-check2-circle"></i>
                Registrar ingreso
              </button>
            </div>
          </div>
        </form>
      </div>

      <div id="tab-proveedor" class="ingreso-panel hidden">
        <div class="odoo-modal-section odoo-compact-card">
          <div class="odoo-modal-title mb-3">Nuevo proveedor</div>
          <form id="proveedor-create-form" class="space-y-3" method="post" action="/inventory/proveedor">
            <input type="hidden" name="redirect_to" value="/inventory/ingresos" />
            <input name="nombre" class="w-full odoo-input form-control" placeholder="Nombre del proveedor" required />
            <input name="tipo" class="w-full odoo-input form-control" placeholder="Tipo (Local/Importacion)" />
            <label class="flex items-center gap-2 text-sm text-slate">
              <input class="accent-brand" type="checkbox" name="activo" checked />
              Activo
            </label>
            <button class="w-full btn btn-primary btn-sm">
              Guardar proveedor
            </button>
        </form>
      </div>
      </div>
      <div id="tab-proveedor-edit" class="ingreso-panel hidden">
        <div class="odoo-modal-section odoo-compact-card">
          <div class="odoo-modal-title mb-3">Editar proveedor</div>
          <form id="proveedor-edit-form" class="space-y-3" method="post" action="/inventory/proveedor/0/update">
            <input type="hidden" name="redirect_to" value="/inventory/ingresos" />
            <label class="block text-sm font-semibold text-ink">
              Selecciona proveedor *
              <select id="edit-proveedor-select" class="mt-2 w-full odoo-input form-select select2 odoo-select2" required>
                <option value="">Selecciona</option>
                {% for proveedor in proveedores %}
                <option value="{{ proveedor.id }}" data-nombre="{{ proveedor.nombre }}" data-tipo="{{ proveedor.tipo or '' }}" data-activo="{{ 1 if proveedor.activo else 0 }}">{{ proveedor.nombre }}</option>
                {% endfor %}
              </select>
            </label>
            <label class="block text-sm font-semibold text-ink">
              Nombre *
              <input id="edit-proveedor-nombre" name="nombre" class="mt-2 w-full odoo-input form-control" required />
            </label>
            <label class="block text-sm font-semibold text-ink">
              Tipo
              <input id="edit-proveedor-tipo" name="tipo" class="mt-2 w-full odoo-input form-control" />
            </label>
            <label class="flex items-center gap-2 text-sm text-slate">
              <input id="edit-proveedor-activo" class="accent-brand" type="checkbox" name="activo" checked />
              Activo
            </label>
            <button class="w-full btn btn-primary btn-sm">
              Guardar cambios
            </button>
          </form>
        </div>
      </div>

      <div id="tab-producto" class="ingreso-panel hidden">
        <div class="odoo-modal-section odoo-compact-card">
          <div class="odoo-modal-title mb-3">Nuevo producto</div>
          <div class="text-muted small mb-2">Creacion rapida: Codigo, Descripcion, Precio y Costo son obligatorios.</div>
          <form id="ingreso-product-form" class="text-base" method="post" action="/inventory/product" target="ingresos-background-frame">
            <input type="hidden" name="redirect_to" value="/inventory/ingresos" />
            <div class="row g-3">
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Codigo *
                  <input id="new-product-code" name="cod_producto" class="mt-2 w-full odoo-input form-control" required />
                </label>
              </div>
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Descripcion *
                  <input id="new-product-desc" name="descripcion" class="mt-2 w-full odoo-input form-control" required />
                </label>
              </div>
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Linea
                  <select id="new-product-linea" name="linea_id" class="mt-2 w-full odoo-input form-select select2 odoo-select2">
                    <option value="">Selecciona</option>
                    {% for linea in lineas %}
                    <option value="{{ linea.id }}">{{ linea.linea }}</option>
                    {% endfor %}
                  </select>
                </label>
              </div>
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Segmento
                  <select id="new-product-segmento" name="segmento_id" class="mt-2 w-full odoo-input form-select select2 odoo-select2">
                    <option value="">Selecciona</option>
                    {% for seg in segmentos %}
                    <option value="{{ seg.id }}">{{ seg.segmento }}</option>
                    {% endfor %}
                  </select>
                </label>
              </div>
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Marca
                  <select id="new-product-marca" name="marca" class="mt-2 w-full odoo-input form-select">
                    <option value="Sin Marca" selected>Sin Marca</option>
                    {% for m in marcas %}
                    {% if (m.nombre or '') != 'Sin Marca' %}
                    <option value="{{ m.nombre }}">{{ m.nombre }}</option>
                    {% endif %}
                    {% endfor %}
                  </select>
                </label>
              </div>
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Costo ({% if inventory_cs_only %}C${% else %}USD{% endif %})
                  <input id="new-product-costo" name="costo_producto_usd" type="number" step="0.01" class="mt-2 w-full odoo-input form-control" required />
                </label>
              </div>
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  % ganancia (entero)
                  <input id="new-product-margin" type="number" min="0" step="1" class="mt-2 w-full odoo-input form-control" placeholder="Ej: 25" />
                </label>
              </div>
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Precio 1 ({% if inventory_cs_only %}C${% else %}USD{% endif %})
                  <input id="new-product-precio" name="precio_venta1_usd" type="number" step="0.01" class="mt-2 w-full odoo-input form-control" required />
                </label>
              </div>
            </div>
            <button id="create-product-btn" class="w-full btn btn-primary btn-sm mt-3" type="submit">
              Crear producto
            </button>
          </form>
        </div>
      </div>

      <div id="tab-producto-edit" class="ingreso-panel hidden">
        <div class="odoo-modal-section odoo-compact-card">
          <div class="odoo-modal-title mb-3">Editar producto</div>
          <form id="product-edit-form" class="space-y-3 text-base" method="post" action="/inventory/product/0/update" target="ingresos-background-frame">
            <input type="hidden" name="redirect_to" value="/inventory/ingresos" />
            <label class="block text-sm font-semibold text-ink">
              Buscar producto *
              <select id="edit-product-select" class="mt-2 w-full odoo-input form-select" required>
                <option value="">Selecciona</option>
                {% for p in productos %}
                <option
                  value="{{ p.id }}"
                  data-cod="{{ p.cod_producto }}"
                  data-desc="{{ p.descripcion }}"
                  data-linea="{{ p.linea_id or '' }}"
                  data-segmento="{{ p.segmento_id or '' }}"
                  data-precio1="{% if inventory_cs_only %}{{ "%.2f"|format(p.precio_venta1 or 0) }}{% else %}{{ "%.2f"|format(p.precio_venta1_usd or 0) }}{% endif %}"
                  data-precio2="{{ "%.2f"|format(p.precio_venta2_usd or 0) }}"
                  data-precio3="{{ "%.2f"|format(p.precio_venta3_usd or 0) }}"
                  data-costo="{% if inventory_cs_only %}{{ "%.2f"|format(p.costo_producto or 0) }}{% elif p.tasa_cambio %}{{ "%.2f"|format((p.costo_producto or 0) / p.tasa_cambio) }}{% else %}0.00{% endif %}"
                  data-activo="{{ 1 if p.activo else 0 }}"
                >
                  {{ p.cod_producto }} - {{ p.descripcion }}
                </option>
                {% endfor %}
              </select>
            </label>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Codigo
                  <input id="edit-codigo" class="mt-2 w-full odoo-input form-control bg-slate-50" disabled />
                </label>
              </div>
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Descripcion *
                  <input id="edit-descripcion" name="descripcion" class="mt-2 w-full odoo-input form-control" required />
                </label>
              </div>
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Linea
                  <select id="edit-linea" name="linea_id" class="mt-2 w-full odoo-input form-select select2 odoo-select2">
                    <option value="">Selecciona</option>
                    {% for linea in lineas %}
                    <option value="{{ linea.id }}">{{ linea.linea }}</option>
                    {% endfor %}
                  </select>
                </label>
              </div>
              <div class="col-md-6">
                <label class="block text-sm font-semibold text-ink">
                  Segmento
                  <select id="edit-segmento" name="segmento_id" class="mt-2 w-full odoo-input form-select select2 odoo-select2">
                    <option value="">Selecciona</option>
                    {% for seg in segmentos %}
                    <option value="{{ seg.id }}">{{ seg.segmento }}</option>
                    {% endfor %}
                  </select>
                </label>
              </div>
              <div class="col-md-4">
                <label class="block text-sm font-semibold text-ink">
                  Costo ({% if inventory_cs_only %}C${% else %}USD{% endif %})
                  <input id="edit-costo" name="costo_producto_usd" type="number" step="0.01" class="mt-2 w-full odoo-input form-control" />
                </label>
              </div>
              <div class="col-md-4">
                <label class="block text-sm font-semibold text-ink">
                  % ganancia (entero)
                  <input id="edit-product-margin" type="number" min="0" step="1" class="mt-2 w-full odoo-input form-control" placeholder="Ej: 25" />
                </label>
              </div>
              <div class="col-md-4">
                <label class="block text-sm font-semibold text-ink">
                  Precio 1 ({% if inventory_cs_only %}C${% else %}USD{% endif %})
                  <input id="edit-precio1" name="precio_venta1_usd" type="number" step="0.01" class="mt-2 w-full odoo-input form-control" />
                </label>
              </div>
              <div class="col-md-4">
                <label class="block text-sm font-semibold text-ink">
                  Precio 2 ({% if inventory_cs_only %}C${% else %}USD{% endif %})
                  <input id="edit-precio2" name="precio_venta2_usd" type="number" step="0.01" class="mt-2 w-full odoo-input form-control" />
                </label>
              </div>
              <div class="col-md-4">
                <label class="block text-sm font-semibold text-ink">
                  Precio 3 ({% if inventory_cs_only %}C${% else %}USD{% endif %})
                  <input id="edit-precio3" name="precio_venta3_usd" type="number" step="0.01" class="mt-2 w-full odoo-input form-control" />
                </label>
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <label class="flex items-center gap-2 text-sm font-semibold text-ink">
                  <input id="edit-activo" class="accent-brand" type="checkbox" name="activo" />
                  Activo
                </label>
              </div>
            </div>
            <button class="w-full btn btn-primary btn-sm">
              Guardar cambios
            </button>
          </form>
        </div>
      </div>

      <div id="tab-linea" class="ingreso-panel hidden">
        <div class="odoo-modal-section odoo-compact-card">
          <div class="odoo-modal-title mb-3">Nueva linea</div>
          <form class="space-y-3" method="post" action="/inventory/linea" target="ingresos-background-frame">
            <input type="hidden" name="redirect_to" value="/inventory/ingresos" />
            <div class="text-muted small">Codigo automatico</div>
            <input name="linea" class="w-full odoo-input form-control" placeholder="Linea" />
            <label class="flex items-center gap-2 text-sm text-slate">
              <input class="accent-brand" type="checkbox" name="activo" checked />
              Activo
            </label>
            <button class="w-full btn btn-primary btn-sm">
              Guardar linea
            </button>
          </form>
        </div>
      </div>

      <div id="tab-segmento" class="ingreso-panel hidden">
        <div class="odoo-modal-section odoo-compact-card">
          <div class="odoo-modal-title mb-3">Nuevo segmento</div>
          <form class="space-y-3" method="post" action="/inventory/segmento" target="ingresos-background-frame">
            <input type="hidden" name="redirect_to" value="/inventory/ingresos" />
            <input name="segmento" class="w-full odoo-input form-control" placeholder="Segmento" />
            <button class="w-full btn btn-primary btn-sm">
              Guardar segmento
            </button>
          </form>
        </div>
      </div>

      <div id="tab-import" class="ingreso-panel hidden">
        <div class="odoo-modal-section odoo-compact-card">
          <div class="odoo-modal-title mb-3">Importar productos</div>
          <p class="text-xs text-slate">
            CSV con columnas: cod_producto, descripcion, linea, segmento, precio_venta1_usd, precio_venta2_usd, precio_venta3_usd, costo_producto_usd, existencia, activo.
            {% if inventory_cs_only %}En este entorno esos campos se interpretan en C$.{% endif %}
          </p>
          <a class="mt-3 inline-flex items-center gap-2 text-sm font-semibold text-sky-800" href="/inventory/import/template">
            <i class="bi bi-download"></i>
            Descargar formato CSV
          </a>
          <form class="mt-3 space-y-3" method="post" action="/inventory/import" enctype="multipart/form-data" target="ingresos-background-frame">
            <input type="hidden" name="redirect_to" value="/inventory/ingresos" />
            <input name="file" type="file" accept=".csv" class="w-full odoo-input form-control bg-white text-sm" required />
            <button class="w-full btn btn-primary btn-sm d-inline-flex items-center justify-content-center gap-2">
              <i class="bi bi-upload"></i>
              Importar CSV
            </button>
          </form>
      </div>
    </div>
        </div>
      </div>
  </div>
</section>
<section id="ingreso-list-section" class="hidden">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
    <div class="odoo-section-title">Ingresos registrados</div>
    <div class="d-flex flex-wrap align-items-center gap-3 text-sm text-slate">
      <form class="d-flex flex-wrap align-items-center gap-2" method="get" action="/inventory/ingresos">
        <div class="input-group input-group-sm rounded-pill overflow-hidden border border-slate-200 bg-white">
          <span class="input-group-text bg-white border-0"><i class="bi bi-calendar-range text-brand"></i></span>
          <input name="start_date" type="date" class="form-control border-0" value="{{ start_date }}" />
          <span class="input-group-text bg-white border-0">a</span>
          <input name="end_date" type="date" class="form-control border-0" value="{{ end_date }}" />
        </div>
        <button class="btn btn-outline-secondary btn-sm" type="submit">
          <i class="bi bi-search"></i>
          Filtrar
        </button>
        <a class="btn btn-outline-secondary btn-sm" href="/inventory/ingresos">
          <i class="bi bi-eraser"></i>
          Ultimos 30 dias
        </a>
      </form>
      <span class="odoo-pill success">
        <i class="bi bi-list-check"></i>
        {{ ingresos|length }} registros
      </span>
    </div>
  </div>
  <div class="table-responsive">
    <table id="ingresos-table" class="table table-striped table-sm align-middle text-sm odoo-table">
      <thead class="text-xs uppercase tracking-[0.15em] text-slate bg-slate-50">
        <tr>
          <th class="text-left px-4 py-3">Fecha</th>
          <th class="text-left px-4 py-3">Tipo</th>
          <th class="text-left px-4 py-3">Bodega</th>
          <th class="text-left px-4 py-3">Proveedor</th>
          {% if not inventory_cs_only %}<th class="text-right px-4 py-3">Total USD</th>{% endif %}
          <th class="text-right px-4 py-3">Total C$</th>
          <th class="text-left px-4 py-3">Observacion</th>
          <th class="text-center px-4 py-3">Documento</th>
        </tr>
      </thead>
      <tbody>
        {% for ingreso in ingresos %}
        <tr class="border-b border-slate-100">
          <td class="px-4 py-3 text-slate">{{ ingreso.fecha }}</td>
          <td class="px-4 py-3 font-semibold text-ink">{{ ingreso.tipo.nombre if ingreso.tipo else "-" }}</td>
          <td class="px-4 py-3 text-slate">{{ ingreso.bodega.name if ingreso.bodega else "-" }}</td>
          <td class="px-4 py-3 text-slate">{{ ingreso.proveedor.nombre if ingreso.proveedor else "-" }}</td>
          {% if not inventory_cs_only %}<td class="px-4 py-3 text-right text-slate">$ {{ "%.2f"|format(ingreso.total_usd or 0) }}</td>{% endif %}
          <td class="px-4 py-3 text-right text-slate">C$ {{ "%.2f"|format(ingreso.total_cs or 0) }}</td>
          <td class="px-4 py-3 text-slate">{{ ingreso.observacion or "-" }}</td>
          <td class="px-4 py-3 text-center">
            <a class="btn btn-outline-secondary btn-sm" href="/inventory/ingresos/{{ ingreso.id }}/pdf" target="_blank" rel="noopener">
              <i class="bi bi-printer"></i>
              PDF
            </a>
          </td>
        </tr>
        {% endfor %}
        {% if ingresos|length == 0 %}
        {% endif %}
      </tbody>
    </table>
  </div>
  <div class="text-end text-slate text-sm mt-4">Version {{ version }}</div>
</section>
</div>
  </main>
</div>
<div class="modal fade" id="quick-product-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nuevo producto rapido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted small mb-3">Completa datos basicos y el producto se agrega al ingreso automaticamente.</div>
        <form id="quick-product-form" class="text-base" method="post" action="/inventory/product">
          <input type="hidden" name="redirect_to" value="/inventory/ingresos" />
          <div class="row g-3">
            <div class="col-md-6">
              <label class="block text-sm font-semibold text-ink">
                Codigo *
                <input id="quick-product-code" name="cod_producto" class="mt-2 w-full odoo-input form-control" required />
              </label>
            </div>
            <div class="col-md-6">
              <label class="block text-sm font-semibold text-ink">
                Descripcion *
                <input id="quick-product-desc" name="descripcion" class="mt-2 w-full odoo-input form-control" required />
              </label>
            </div>
            <div class="col-md-6">
              <label class="block text-sm font-semibold text-ink">
                Linea
                <select id="quick-product-linea" name="linea_id" class="mt-2 w-full odoo-input form-select">
                  <option value="">Selecciona</option>
                  {% for linea in lineas %}
                  <option value="{{ linea.id }}">{{ linea.linea }}</option>
                  {% endfor %}
                </select>
              </label>
              <div class="d-flex gap-2 mt-2">
                <button id="quick-toggle-linea" type="button" class="btn btn-sm btn-outline-secondary" aria-expanded="false">
                  + Nueva linea
                </button>
              </div>
              <div class="mt-2 d-none" id="quick-new-linea-wrap">
                <div id="quick-linea-form" class="border rounded-3 p-2 bg-light">
                  <div class="row g-2">
                    <div class="col-12">
                      <input id="quick-linea-name" class="form-control form-control-sm" placeholder="Nombre de linea" />
                    </div>
                  </div>
                  <div class="mt-2 text-end">
                    <button id="quick-linea-create-btn" class="btn btn-sm btn-primary" type="button">Guardar linea</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <label class="block text-sm font-semibold text-ink">
                Segmento
                <select id="quick-product-segmento" name="segmento_id" class="mt-2 w-full odoo-input form-select">
                  <option value="">Selecciona</option>
                  {% for seg in segmentos %}
                  <option value="{{ seg.id }}">{{ seg.segmento }}</option>
                  {% endfor %}
                </select>
              </label>
              <div class="d-flex gap-2 mt-2">
                <button id="quick-toggle-segmento" type="button" class="btn btn-sm btn-outline-secondary" aria-expanded="false">
                  + Nuevo segmento
                </button>
              </div>
              <div class="mt-2 d-none" id="quick-new-segmento-wrap">
                <div id="quick-segmento-form" class="border rounded-3 p-2 bg-light">
                  <div class="row g-2">
                    <div class="col-12">
                      <input id="quick-segmento-name" class="form-control form-control-sm" placeholder="Nombre de segmento" />
                    </div>
                  </div>
                  <div class="mt-2 text-end">
                    <button id="quick-segmento-create-btn" class="btn btn-sm btn-primary" type="button">Guardar segmento</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <label class="block text-sm font-semibold text-ink">
                Marca
                <select id="quick-product-marca" name="marca" class="mt-2 w-full odoo-input form-select">
                  <option value="Sin Marca" selected>Sin Marca</option>
                  {% for m in marcas %}
                  {% if (m.nombre or '') != 'Sin Marca' %}
                  <option value="{{ m.nombre }}">{{ m.nombre }}</option>
                  {% endif %}
                  {% endfor %}
                </select>
              </label>
              <div class="d-flex gap-2 mt-2">
                <button id="quick-toggle-marca" type="button" class="btn btn-sm btn-outline-secondary" aria-expanded="false">
                  + Nueva marca
                </button>
              </div>
              <div class="mt-2 d-none" id="quick-new-marca-wrap">
                <div id="quick-marca-form" class="border rounded-3 p-2 bg-light">
                  <div class="row g-2">
                    <div class="col-12">
                      <input id="quick-marca-name" class="form-control form-control-sm" placeholder="Nombre de marca" />
                    </div>
                  </div>
                  <div class="mt-2 text-end">
                    <button id="quick-marca-create-btn" class="btn btn-sm btn-primary" type="button">Guardar marca</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <label class="block text-sm font-semibold text-ink">
                Costo ({% if inventory_cs_only %}C${% else %}USD{% endif %}) *
                <input id="quick-product-costo" name="costo_producto_usd" type="number" step="0.01" class="mt-2 w-full odoo-input form-control" required />
              </label>
            </div>
            <div class="col-md-6">
              <label class="block text-sm font-semibold text-ink">
                % ganancia (entero)
                <input id="quick-product-margin" type="number" min="0" step="1" class="mt-2 w-full odoo-input form-control" placeholder="Ej: 25" />
              </label>
              <div class="text-muted small mt-1">Define el porcentaje para este producto.</div>
            </div>
            <div class="col-md-6">
              <label class="block text-sm font-semibold text-ink">
                Precio 1 ({% if inventory_cs_only %}C${% else %}USD{% endif %}) *
                <input id="quick-product-precio" name="precio_venta1_usd" type="number" step="0.01" class="mt-2 w-full odoo-input form-control" required />
              </label>
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="quick-create-product-btn" class="btn btn-primary" type="submit">Crear y agregar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<iframe name="ingresos-background-frame" class="hidden"></iframe>

<script>
  const layout = document.getElementById("layout");
  const toggles = document.querySelectorAll(".toggle-sidebar");
  if (layout && toggles.length) {
    toggles.forEach((toggle) => {
      toggle.addEventListener("click", () => {
        layout.classList.toggle("sidebar-collapsed");
      });
    });
  }

  const ingresoTabs = document.querySelectorAll(".ingreso-tab");
  const ingresoPanels = document.querySelectorAll(".ingreso-panel");
  const productList = document.getElementById("product-list");
  const productSearch = document.getElementById("product-search");
  const itemsTable = document.getElementById("items-table");
  const emptyItems = document.getElementById("empty-items");
  const itemsBultosLive = document.getElementById("items-bultos-live");
  const itemsCountLive = document.getElementById("items-count-live");
  const summaryBultos = document.getElementById("summary-bultos");
  const summaryItems = document.getElementById("summary-items");
  const totalBultos = document.getElementById("total-bultos");
  const totalItems = document.getElementById("total-items");
  const totalUsd = document.getElementById("total-usd");
  const totalCs = document.getElementById("total-cs");
  const monedaField = document.getElementById("field-moneda");
  const tipoField = document.getElementById("field-tipo");
  const proveedorField = document.getElementById("field-proveedor");
  const quickToggleProveedor = document.getElementById("quick-toggle-proveedor");
  const quickNewProveedorWrap = document.getElementById("quick-new-proveedor-wrap");
  const quickProveedorName = document.getElementById("quick-proveedor-name");
  const quickProveedorTipo = document.getElementById("quick-proveedor-tipo");
  const quickProveedorActivo = document.getElementById("quick-proveedor-activo");
  const quickProveedorCreateBtn = document.getElementById("quick-proveedor-create-btn");
  const allowDecimals = document.getElementById("allow-decimals");
  const fechaField = document.getElementById("field-fecha");
  const rateToday = {{ rate_today.rate if rate_today else 0 }};
  const inventoryCsOnly = {{ "true" if inventory_cs_only else "false" }};
  const defaultMoneda = inventoryCsOnly ? "CS" : "USD";
  const editSelect = document.getElementById("edit-product-select");
  const editForm = document.getElementById("product-edit-form");
  const editCodigo = document.getElementById("edit-codigo");
  const editDescripcion = document.getElementById("edit-descripcion");
  const editLinea = document.getElementById("edit-linea");
  const editSegmento = document.getElementById("edit-segmento");
  const editPrecio1 = document.getElementById("edit-precio1");
  const editPrecio2 = document.getElementById("edit-precio2");
  const editPrecio3 = document.getElementById("edit-precio3");
  const editProductMargin = document.getElementById("edit-product-margin");
  const editCosto = document.getElementById("edit-costo");
  const editActivo = document.getElementById("edit-activo");
  const editProveedorSelect = document.getElementById("edit-proveedor-select");
  const editProveedorForm = document.getElementById("proveedor-edit-form");
  const editProveedorNombre = document.getElementById("edit-proveedor-nombre");
  const editProveedorTipo = document.getElementById("edit-proveedor-tipo");
  const editProveedorActivo = document.getElementById("edit-proveedor-activo");
  const ingresoFormTab = document.getElementById("ingreso-form-tab");
  const ingresoListTab = document.getElementById("ingreso-list-tab");
  const ingresoFormSection = document.getElementById("ingreso-form-section");
  const ingresoListSection = document.getElementById("ingreso-list-section");
  const proveedorCreateForm = document.getElementById("proveedor-create-form");
  const ingresoProductForm = document.getElementById("ingreso-product-form");
  const createProductButton = document.getElementById("create-product-btn");
  const quickProductForm = document.getElementById("quick-product-form");
  const quickCreateProductButton = document.getElementById("quick-create-product-btn");
  const quickProductModalEl = document.getElementById("quick-product-modal");
  const quickProductCode = document.getElementById("quick-product-code");
  const quickProductDesc = document.getElementById("quick-product-desc");
  const quickProductLinea = document.getElementById("quick-product-linea");
  const quickProductSegmento = document.getElementById("quick-product-segmento");
  const quickProductMarca = document.getElementById("quick-product-marca");
  const quickToggleLinea = document.getElementById("quick-toggle-linea");
  const quickToggleSegmento = document.getElementById("quick-toggle-segmento");
  const quickToggleMarca = document.getElementById("quick-toggle-marca");
  const quickNewLineaWrap = document.getElementById("quick-new-linea-wrap");
  const quickNewSegmentoWrap = document.getElementById("quick-new-segmento-wrap");
  const quickNewMarcaWrap = document.getElementById("quick-new-marca-wrap");
  const quickLineaForm = document.getElementById("quick-linea-form");
  const quickLineaName = document.getElementById("quick-linea-name");
  const quickLineaCreateBtn = document.getElementById("quick-linea-create-btn");
  const quickSegmentoForm = document.getElementById("quick-segmento-form");
  const quickSegmentoName = document.getElementById("quick-segmento-name");
  const quickSegmentoCreateBtn = document.getElementById("quick-segmento-create-btn");
  const quickMarcaForm = document.getElementById("quick-marca-form");
  const quickMarcaName = document.getElementById("quick-marca-name");
  const quickMarcaCreateBtn = document.getElementById("quick-marca-create-btn");
  const quickProductPrecio = document.getElementById("quick-product-precio");
  const quickProductMargin = document.getElementById("quick-product-margin");
  const quickProductCosto = document.getElementById("quick-product-costo");
  const newProductCode = document.getElementById("new-product-code");
  const newProductDesc = document.getElementById("new-product-desc");
  const newProductLinea = document.getElementById("new-product-linea");
  const newProductSegmento = document.getElementById("new-product-segmento");
  const newProductMarca = document.getElementById("new-product-marca");
  const newProductPrecio = document.getElementById("new-product-precio");
  const newProductMargin = document.getElementById("new-product-margin");
  const newProductCosto = document.getElementById("new-product-costo");
  if (quickProductModalEl) {
    quickProductModalEl.addEventListener("shown.bs.modal", () => {
      if (quickProductCode) {
        quickProductCode.focus();
        quickProductCode.select();
      }
    });
  }

  const toggleInlinePanel = (buttonEl, panelEl) => {
    if (!buttonEl || !panelEl) return;
    buttonEl.addEventListener("click", () => {
      const isHidden = panelEl.classList.contains("d-none");
      panelEl.classList.toggle("d-none", !isHidden);
      buttonEl.setAttribute("aria-expanded", isHidden ? "true" : "false");
    });
  };
  toggleInlinePanel(quickToggleProveedor, quickNewProveedorWrap);
  toggleInlinePanel(quickToggleLinea, quickNewLineaWrap);
  toggleInlinePanel(quickToggleSegmento, quickNewSegmentoWrap);
  toggleInlinePanel(quickToggleMarca, quickNewMarcaWrap);

  const resolveMarginPercent = (marginInput) => {
    const manualRaw = (marginInput?.value || "").trim();
    if (!manualRaw) {
      return 0;
    }
    const manualInt = parseInt(manualRaw, 10);
    return Number.isFinite(manualInt) && manualInt > 0 ? manualInt : 0;
  };

  const calculateAutoPrice = (costValue, marginInput) => {
    const cost = parseFloat(costValue || 0);
    const marginPct = resolveMarginPercent(marginInput);
    if (marginPct <= 0 || !Number.isFinite(cost) || cost <= 0) {
      return null;
    }
    const price = cost * (1 + (marginPct / 100));
    return price.toFixed(2);
  };

  const bindAutoPriceFromCost = (costInput, priceInput, marginInput = null) => {
    if (!costInput || !priceInput) return;
    const apply = () => {
      const computed = calculateAutoPrice(costInput.value, marginInput);
      if (computed !== null) {
        priceInput.value = computed;
      }
    };
    costInput.addEventListener("input", apply);
    costInput.addEventListener("change", apply);
    if (marginInput) {
      marginInput.addEventListener("input", () => {
        marginInput.value = (marginInput.value || "").replace(/\D+/g, "");
        apply();
      });
      marginInput.addEventListener("change", apply);
    }
  };

  bindAutoPriceFromCost(newProductCosto, newProductPrecio, newProductMargin);
  bindAutoPriceFromCost(quickProductCosto, quickProductPrecio, quickProductMargin);
  bindAutoPriceFromCost(editCosto, editPrecio1, editProductMargin);
  let handleAddItem = null;
  let loadEditProductFn = null;
  const ingresoForm = document.getElementById("ingreso-form");
  const STORAGE_KEY = "hp_ingreso_draft_v1";

  const setIngresoView = (view) => {
    const showForm = view === "form";
    if (ingresoFormSection) ingresoFormSection.classList.toggle("hidden", !showForm);
    if (ingresoListSection) ingresoListSection.classList.toggle("hidden", showForm);
    if (ingresoFormTab) ingresoFormTab.classList.toggle("active", showForm);
    if (ingresoListTab) ingresoListTab.classList.toggle("active", !showForm);
  };
  if (ingresoFormTab) {
    ingresoFormTab.addEventListener("click", () => setIngresoView("form"));
  }
  if (ingresoListTab) {
    ingresoListTab.addEventListener("click", () => setIngresoView("list"));
  }

  const setIngresoTab = (targetId) => {
    ingresoTabs.forEach((tab) => {
      const active = tab.dataset.target === targetId;
      tab.classList.toggle("btn-primary", active);
      tab.classList.toggle("btn-outline-secondary", !active);
    });
    ingresoPanels.forEach((panel) => {
      panel.classList.toggle("hidden", panel.id !== targetId);
    });
    if (targetId === "tab-producto-edit" && loadEditProductFn && editSelect?.value) {
      const option = editSelect.selectedOptions[0] || editSelect.options[editSelect.selectedIndex];
      loadEditProductFn(option);
    }
    if (targetId === "tab-producto") {
      window.setTimeout(() => {
        if (newProductCode) {
          newProductCode.focus();
          newProductCode.select();
        }
      }, 50);
    }
  };
  ingresoTabs.forEach((tab) => {
    tab.addEventListener("click", () => setIngresoTab(tab.dataset.target));
  });

  const updateTotals = () => {
    let sumBultos = 0;
    let countItems = 0;
    let sumUsd = 0;
    let sumCs = 0;
    itemsTable.querySelectorAll("tr[data-item-row]").forEach((row) => {
      countItems += 1;
      const qtyInput = row.querySelector(".row-qty");
      const qtyHidden = row.querySelector("input[name='item_cantidad']");
      const qtyValue = parseFloat(qtyInput?.value || qtyHidden?.value || 0);
      sumBultos += Number.isFinite(qtyValue) ? qtyValue : 0;
      sumUsd += parseFloat(row.dataset.subtotalUsd || 0);
      sumCs += parseFloat(row.dataset.subtotalCs || 0);
    });
    if (totalBultos) totalBultos.textContent = sumBultos.toFixed(2);
    if (totalItems) totalItems.textContent = `${countItems}`;
    if (itemsBultosLive) itemsBultosLive.textContent = sumBultos.toFixed(2);
    if (itemsCountLive) itemsCountLive.textContent = `${countItems}`;
    if (summaryBultos) summaryBultos.textContent = sumBultos.toFixed(2);
    if (summaryItems) summaryItems.textContent = `${countItems}`;
    if (totalUsd) totalUsd.textContent = `$ ${sumUsd.toFixed(2)}`;
    if (totalCs) totalCs.textContent = `C$ ${sumCs.toFixed(2)}`;
  };

  const focusSelect = (selectEl) => {
    if (!selectEl) return;
    if (window.$ && $.fn.select2) {
      $(selectEl).select2("open");
      return;
    }
    selectEl.focus();
  };

  const wireProductRow = (row) => {
    if (!handleAddItem) return;
    const addButton = row.querySelector(".add-item");
    if (addButton) {
      addButton.addEventListener("click", () => handleAddItem(addButton, "search"));
    }
    const qtyInput = row.querySelector(".qty-input");
    if (qtyInput) {
      qtyInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          if (addButton) {
            handleAddItem(addButton, "cost");
          }
        }
      });
    }
  };

  const appendProductToList = (payload, lineaId, segmentoId) => {
    if (!productList) return;
    const row = document.createElement("tr");
    row.className = "product-pick-row border-b border-slate-50";
    row.dataset.name = payload.descripcion || "";
    row.dataset.code = payload.cod_producto || "";
    row.dataset.saldos = "{}";
    row.innerHTML = `
      <td class="px-3 py-2 font-semibold text-ink">${payload.cod_producto || ""}</td>
      <td class="px-3 py-2 text-slate">${payload.descripcion || ""}</td>
      <td class="px-3 py-2 text-right text-slate">${inventoryCsOnly ? "C$" : "$"} ${parseFloat(inventoryCsOnly ? (payload.costo_cs || 0) : (payload.costo_usd || 0)).toFixed(2)}</td>
      <td class="px-3 py-2 text-right text-slate">${inventoryCsOnly ? "C$" : "$"} ${parseFloat(inventoryCsOnly ? (payload.precio_venta1 || 0) : (payload.precio_venta1_usd || 0)).toFixed(2)}</td>
      <td class="px-3 py-2 text-right text-slate saldo-cell">0</td>
      <td class="px-3 py-2 text-right">
        <input class="qty-input w-16 rounded-lg border border-slate-200 px-2 py-1 text-right bg-white" type="number" step="1" min="1" value="1" />
      </td>
      <td class="px-3 py-2 text-center">
        <button
          class="add-item inline-flex items-center justify-center w-8 h-8 rounded-lg border border-slate-200 bg-white text-ink hover:bg-slate-50 shadow-sm"
          type="button"
          data-product-id="${payload.id}"
          data-code="${payload.cod_producto || ""}"
          data-name="${payload.descripcion || ""}"
          data-cost-usd="${parseFloat(payload.costo_usd || 0).toFixed(2)}"
          data-cost-cs="${parseFloat(payload.costo_cs || 0).toFixed(2)}"
          data-price-usd="${parseFloat(payload.precio_venta1_usd || 0).toFixed(2)}"
          data-price-cs="${parseFloat(payload.precio_venta1 || 0).toFixed(2)}"
        >
          <i class="bi bi-plus"></i>
        </button>
      </td>
    `;
    productList.prepend(row);
    wireProductRow(row);
    if (typeof updateSaldoCells === "function") {
      updateSaldoCells();
    }
    return row;
  };

  const serializeItems = () => {
    return Array.from(itemsTable.querySelectorAll("tr[data-item-row]")).map((row) => {
      const qtyInput = row.querySelector(".row-qty");
      const costInput = row.querySelector(".row-cost");
      const priceInput = row.querySelector(".row-price");
      const productId = row.querySelector("input[name='item_producto_id']")?.value || "";
      const qtyHidden = row.querySelector("input[name='item_cantidad']")?.value || "";
      const nameCell = row.querySelectorAll("td")[0]?.textContent || "";
      return {
        productId,
        name: nameCell,
        qty: qtyInput ? qtyInput.value : qtyHidden,
        cost: costInput ? costInput.value : "0",
        price: priceInput ? priceInput.value : "0",
      };
    });
  };

  const saveDraft = () => {
    if (!ingresoForm) return;
    const bodegaField = ingresoForm.querySelector("select[name='bodega_id']");
    const obs = ingresoForm.querySelector("input[name='observacion']");
    const draft = {
      tipo: tipoField?.value || "",
      fecha: fechaField?.value || "",
      bodega: bodegaField?.value || "",
      proveedor: proveedorField?.value || "",
      moneda: monedaField?.value || defaultMoneda,
      observacion: obs?.value || "",
      allowDecimals: !!allowDecimals?.checked,
      items: serializeItems(),
    };
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(draft));
    } catch {}
  };

  const restoreDraft = () => {
    let raw = null;
    try {
      raw = localStorage.getItem(STORAGE_KEY);
    } catch {}
    if (!raw) return;
    let draft = null;
    try {
      draft = JSON.parse(raw);
    } catch {
      return;
    }
    if (!draft) return;
    if (tipoField) tipoField.value = draft.tipo || "";
    if (fechaField) fechaField.value = draft.fecha || "";
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    if (bodegaField) bodegaField.value = draft.bodega || "";
    if (proveedorField) proveedorField.value = draft.proveedor || "";
    if (monedaField) monedaField.value = inventoryCsOnly ? "CS" : (draft.moneda || defaultMoneda);
    const obs = ingresoForm?.querySelector("input[name='observacion']");
    if (obs) obs.value = draft.observacion || "";
    if (allowDecimals) allowDecimals.checked = !!draft.allowDecimals;
    if (window.$ && $.fn.select2) {
      $(".select2").trigger("change");
    }
    if (itemsTable) {
      itemsTable.innerHTML = `<tr id="empty-items"><td colspan="6" class="text-center py-3 text-slate">Sin items agregados</td></tr>`;
    }
    if (Array.isArray(draft.items)) {
      draft.items.forEach((item) => {
        if (!item.productId) return;
        const qty = parseFloat(item.qty || 0) || 1;
        const cost = parseFloat(item.cost || 0) || 0;
        const price = parseFloat(item.price || 0) || 0;
        const subtotal = cost * qty;
        const subtotalUsd = monedaField?.value === "USD" ? subtotal : (rateToday ? subtotal / rateToday : 0);
        const subtotalCs = monedaField?.value === "USD" ? subtotal * rateToday : subtotal;
        addItemRow({
          productId: item.productId,
          code: "",
          name: item.name || "",
          qtyLabel: formatQtyLabel(qty),
          qtyValue: allowDecimals && allowDecimals.checked ? qty.toFixed(2) : Math.trunc(qty).toFixed(2),
          qtyValueDisplay: allowDecimals && allowDecimals.checked ? qty.toFixed(2) : Math.trunc(qty).toString(),
          qtyStep: allowDecimals && allowDecimals.checked ? "0.01" : "1",
          costValue: cost.toFixed(2),
          priceValue: price.toFixed(2),
          subtotalLabel: monedaField?.value === "USD" ? `$ ${subtotal.toFixed(2)}` : `C$ ${subtotal.toFixed(2)}`,
          subtotalUsd,
          subtotalCs,
          focusTarget: "search",
        });
      });
      updateTotals();
    }
    if (typeof syncProveedorRequired === "function") {
      syncProveedorRequired();
    }
    if (typeof updateSaldoCells === "function") {
      updateSaldoCells();
    }
    if (typeof updateBodegaBanner === "function") {
      updateBodegaBanner();
    }
  };

  const syncProveedorRequired = () => {
    const option = tipoField.options[tipoField.selectedIndex];
    const label = (option?.textContent || "").toLowerCase();
    const requiere =
      (option && option.dataset.requiereProveedor === "1") ||
      label.includes("compra") ||
      label.includes("import");
    if (proveedorField) {
      proveedorField.required = requiere;
      proveedorField.disabled = false;
      proveedorField.removeAttribute("disabled");
      if (window.$ && $.fn.select2) {
        $(proveedorField).prop("disabled", false).trigger("change.select2");
      }
      if (!requiere) {
        proveedorField.value = "";
        if (window.$ && $.fn.select2) {
          $(proveedorField).val(null).trigger("change");
        }
      }
    }
  };
  if (tipoField) {
    tipoField.addEventListener("change", syncProveedorRequired);
    if (window.$ && $.fn.select2) {
      $(tipoField).on("select2:select", syncProveedorRequired);
    }
  }
  if (tipoField) {
    syncProveedorRequired();
  }

  const formatSaldoValue = (value) => {
    const numeric = Number(value);
    if (!Number.isFinite(numeric)) return "0";
    if (Number.isInteger(numeric)) {
      return String(numeric);
    }
    return numeric.toFixed(2);
  };

  const updateSaldoCells = () => {
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    if (!bodegaField) return;
    const bodegaId = bodegaField.value;
    if (!bodegaId) return;
    document.querySelectorAll(".product-pick-row").forEach((row) => {
      let saldo = 0;
      const raw = row.dataset.saldos;
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          saldo = parsed?.[bodegaId] ?? 0;
        } catch {}
      }
      const cell = row.querySelector(".saldo-cell");
      if (cell) {
        cell.textContent = formatSaldoValue(saldo);
      }
      const qtyInput = row.querySelector(".qty-input");
      if (qtyInput) {
        qtyInput.max = String(saldo || 0);
      }
      const addButton = row.querySelector(".add-item");
      if (addButton) {
        addButton.dataset.existencia = String(saldo || 0);
      }
    });
  };

  const wireSaldoRefresh = () => {
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    if (!bodegaField) return;
    bodegaField.addEventListener("change", updateSaldoCells);
    bodegaField.addEventListener("change", syncBodegaGate);
    if (window.$ && $.fn.select2) {
      $(bodegaField).on("select2:select", updateSaldoCells);
      $(bodegaField).on("select2:select", syncBodegaGate);
      $(bodegaField).on("select2:clear", syncBodegaGate);
      $(bodegaField).on("change.select2", syncBodegaGate);
    }
    updateBodegaBanner();
  };

  window.addEventListener("load", () => {
  if (fechaField && window.$ && $.fn.datepicker) {
    $(fechaField).datepicker({
      format: "yyyy-mm-dd",
      autoclose: true,
      todayHighlight: true,
      language: "es",
    });
    if (!fechaField.value) {
      const now = new Date();
      const formatted = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
      fechaField.value = formatted;
      $(fechaField).datepicker("update", formatted);
    }
  } else if (fechaField && !fechaField.value) {
    const now = new Date();
    fechaField.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
  }

  if (window.$ && $.fn.select2) {
    $(".select2").select2({
      width: "style",
      placeholder: "Selecciona",
      allowClear: true,
    });
    $("#edit-product-select").select2("destroy");
  }
  restoreDraft();
  if (editSelect && loadEditProductFn && editSelect.value) {
    const option = editSelect.selectedOptions[0] || editSelect.options[editSelect.selectedIndex];
    loadEditProductFn(option);
  }
  wireSaldoRefresh();
  updateSaldoCells();
  syncBodegaGate();
  if (productSearch) {
    filterProductRows(productSearch.value || "");
  }
  setIngresoView("form");

  if (window.DataTable) {
    const ingresosTable = new DataTable("#ingresos-table", {
      searching: true,
      paging: true,
      info: true,
      lengthChange: false,
      order: [[0, "desc"]],
      language: {
        search: "Buscar:",
        lengthMenu: "Mostrar _MENU_",
        info: "Mostrando _START_ a _END_ de _TOTAL_",
        infoEmpty: "Sin registros",
        zeroRecords: "Sin coincidencias",
        emptyTable: "Sin ingresos registrados",
        paginate: {
          next: "Siguiente",
          previous: "Anterior",
        },
      },
      dom: "Brtip",
      buttons: ["copy", "excel", "pdf", "print"],
    });
  }

  const errorBanner = document.querySelector("[data-error-banner]");
  if (errorBanner) {
    errorBanner.style.display = "none";
  }
  const successBanner = document.querySelector("[data-success-banner]");
  if (successBanner) {
    successBanner.style.display = "none";
  }
  {% if error %}
  if (typeof Swal !== "undefined") {
    Swal.fire({
      icon: "error",
      title: "Atencion",
      text: "{{ error }}",
      confirmButtonText: "Entendido",
    });
  }
  {% endif %}
  {% if success %}
  if (typeof Swal !== "undefined") {
    Swal.fire({
      icon: "success",
      title: "Producto creado",
      text: "{{ success }}",
      timer: 1800,
      showConfirmButton: false,
    });
  }
  {% endif %}
  {% if print_id %}
  window.open("/inventory/ingresos/{{ print_id }}/pdf", "_blank");
  {% endif %}
  });

  if (editSelect) {
    const applyEditData = (data) => {
      if (!data) return;
      if (editCodigo) {
        editCodigo.value = data.cod_producto || "";
      }
      if (editDescripcion) {
        editDescripcion.value = data.descripcion || "";
      }
      if (editLinea) {
        editLinea.value = data.linea_id ? String(data.linea_id) : "";
        if (window.$ && $.fn.select2) {
          $(editLinea).val(editLinea.value || null).trigger("change");
        }
      }
      if (editSegmento) {
        editSegmento.value = data.segmento_id ? String(data.segmento_id) : "";
        if (window.$ && $.fn.select2) {
          $(editSegmento).val(editSegmento.value || null).trigger("change");
        }
      }
      if (editPrecio1) {
        editPrecio1.value = inventoryCsOnly ? ((parseFloat(data.precio_venta1_usd || 0) * rateToday).toFixed(2)) : (data.precio_venta1_usd || "");
      }
      if (editPrecio2) {
        editPrecio2.value = inventoryCsOnly ? ((parseFloat(data.precio_venta2_usd || 0) * rateToday).toFixed(2)) : (data.precio_venta2_usd || "");
      }
      if (editPrecio3) {
        editPrecio3.value = inventoryCsOnly ? ((parseFloat(data.precio_venta3_usd || 0) * rateToday).toFixed(2)) : (data.precio_venta3_usd || "");
      }
      if (editCosto) {
        editCosto.value = inventoryCsOnly ? ((parseFloat(data.costo_usd || 0) * rateToday).toFixed(2)) : (data.costo_usd || "");
      }
      if (editActivo) {
        editActivo.checked = data.activo === true || data.activo === "1";
      }
    };

    const fetchEditProduct = (productId) => {
      if (!productId) return;
      if (editForm) {
        editForm.action = `/inventory/product/${productId}/update`;
      }
      fetch(`/inventory/product/${productId}/json`, { headers: { "Accept": "application/json" } })
        .then((res) => (res.ok ? res.json() : null))
        .then((payload) => {
          if (payload && payload.ok) {
            applyEditData(payload);
          }
        })
        .catch((err) => {
          if (typeof Swal !== "undefined") {
            Swal.fire({ icon: "error", title: "Error", text: err.message || "No se pudo cargar" });
          }
        });
    };
    const loadEditProduct = (option) => {
      if (!option || !option.value) {
        return;
      }
      applyEditData({
        cod_producto: option.dataset.cod || "",
        descripcion: option.dataset.desc || "",
        linea_id: option.dataset.linea || "",
        segmento_id: option.dataset.segmento || "",
        precio_venta1_usd: option.dataset.precio1 || "",
        precio_venta2_usd: option.dataset.precio2 || "",
        precio_venta3_usd: option.dataset.precio3 || "",
        costo_usd: option.dataset.costo || "",
        activo: option.dataset.activo || "",
      });
      fetchEditProduct(option.value);
    };
    loadEditProductFn = loadEditProduct;
    const triggerEditLoad = () => {
      const option = editSelect.selectedOptions[0] || editSelect.options[editSelect.selectedIndex];
      loadEditProduct(option);
    };
    editSelect.addEventListener("change", () => {
      triggerEditLoad();
    });
    if (window.$ && $.fn.select2) {
      $(editSelect).select2("destroy");
    }
  }

  if (editProveedorSelect) {
    editProveedorSelect.addEventListener("change", (event) => {
      const option = event.target.selectedOptions[0];
      if (!option || !option.value) {
        return;
      }
      if (editProveedorForm) {
        editProveedorForm.action = `/inventory/proveedor/${option.value}/update`;
      }
      if (editProveedorNombre) {
        editProveedorNombre.value = option.dataset.nombre || "";
      }
      if (editProveedorTipo) {
        editProveedorTipo.value = option.dataset.tipo || "";
      }
      if (editProveedorActivo) {
        editProveedorActivo.checked = option.dataset.activo === "1";
      }
    });
  }

  const handleProveedorResponse = async (response) => {
    const payload = await response.json().catch(() => null);
    if (!payload) {
      throw new Error("Respuesta invalida");
    }
    if (!payload.ok) {
      throw new Error(payload.message || "No se pudo guardar");
    }
    return payload;
  };

  const upsertProveedorOption = (selectEl, payload, selectCurrent = false) => {
    if (!selectEl || !payload || !payload.id) return;
    const value = String(payload.id);
    let option = selectEl.querySelector(`option[value='${value}']`);
    if (!option) {
      option = new Option(payload.nombre || "", value, false, false);
      selectEl.append(option);
    }
    option.textContent = payload.nombre || option.textContent;
    option.dataset.nombre = payload.nombre || "";
    option.dataset.tipo = payload.tipo || "";
    option.dataset.activo = payload.activo ? "1" : "0";
    if (selectCurrent) {
      selectEl.value = value;
      if (window.$ && $.fn.select2 && selectEl.classList.contains("select2")) {
        $(selectEl).val(value).trigger("change");
      }
    }
  };

  const handleCatalogResponse = async (response) => {
    const payload = await response.json().catch(() => null);
    if (!payload) {
      throw new Error("Respuesta invalida");
    }
    if (!response.ok || !payload.ok) {
      throw new Error(payload.message || payload.detail || "No se pudo guardar");
    }
    return payload;
  };

  if (proveedorCreateForm) {
    proveedorCreateForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      try {
        const response = await fetch(proveedorCreateForm.action, {
          method: "POST",
          headers: { "X-Requested-With": "fetch" },
          body: new FormData(proveedorCreateForm),
        });
        const payload = await handleProveedorResponse(response);
        upsertProveedorOption(editProveedorSelect, payload, false);
        upsertProveedorOption(proveedorField, payload, true);
        proveedorCreateForm.reset();
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "success", title: "Proveedor guardado", timer: 1500, showConfirmButton: false });
        }
      } catch (error) {
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "error", title: "Error", text: error.message || "No se pudo guardar" });
        }
      }
    });
  }

  if (editProveedorForm) {
    editProveedorForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      try {
        const response = await fetch(editProveedorForm.action, {
          method: "POST",
          headers: { "X-Requested-With": "fetch" },
          body: new FormData(editProveedorForm),
        });
        const payload = await handleProveedorResponse(response);
        if (editProveedorSelect) {
          const option = editProveedorSelect.querySelector(`option[value='${payload.id}']`);
          if (option) {
            option.textContent = payload.nombre;
            option.dataset.nombre = payload.nombre;
            option.dataset.tipo = payload.tipo || "";
            option.dataset.activo = payload.activo ? "1" : "0";
          }
        }
        if (proveedorField) {
          const option = proveedorField.querySelector(`option[value='${payload.id}']`);
          if (option) {
            option.textContent = payload.nombre;
          }
        }
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "success", title: "Proveedor actualizado", timer: 1500, showConfirmButton: false });
        }
      } catch (error) {
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "error", title: "Error", text: error.message || "No se pudo guardar" });
        }
      }
    });
  }

  const handleProductResponse = async (response) => {
    const contentType = response.headers.get("content-type") || "";
    if (contentType.includes("application/json")) {
      const payload = await response.json().catch(() => null);
      if (!payload) {
        throw new Error(`Respuesta invalida (${response.status})`);
      }
      if (!response.ok || !payload.ok) {
        throw new Error(payload.message || payload.detail || `No se pudo guardar (${response.status})`);
      }
      return payload;
    }
    if (response.status === 403) {
      throw new Error("No tienes permisos para crear productos desde ingresos.");
    }
    const text = await response.text().catch(() => "");
    throw new Error(text || `Respuesta invalida (${response.status})`);
  };

  if (ingresoProductForm) {
    const submitProductCreateForm = async (event, config) => {
      event.preventDefault();
      const submitButton = config.submitButton;
      const previousLabel = submitButton ? submitButton.innerHTML : "";
      try {
        const missing = [];
        const normalizedCode = (config.codeInput?.value || "").trim().toUpperCase();
        const normalizedDesc = (config.descInput?.value || "").trim();
        if (!normalizedCode) missing.push("Codigo");
        if (!normalizedDesc) missing.push("Descripcion");
        if (!config.precioInput?.value?.trim()) missing.push("Precio 1 ({% if inventory_cs_only %}C${% else %}USD{% endif %})");
        if (!config.costoInput?.value?.trim()) missing.push("Costo ({% if inventory_cs_only %}C${% else %}USD{% endif %})");
        if (missing.length) {
          if (typeof Swal !== "undefined") {
            Swal.fire({
              icon: "warning",
              title: "Completa los campos",
              text: `Faltan: ${missing.join(", ")}`,
            });
          }
          return;
        }
        if (config.codeInput) config.codeInput.value = normalizedCode;
        if (config.descInput) config.descInput.value = normalizedDesc;
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creando...';
        }
        const formData = new FormData(config.form);
        formData.set("cod_producto", normalizedCode);
        formData.set("descripcion", normalizedDesc);
        formData.set("marca", (config.marcaInput?.value || "").trim() || "Sin Marca");
        const response = await fetch(config.form.action, {
          method: "POST",
          headers: { "X-Requested-With": "fetch", "Accept": "application/json" },
          body: formData,
        });
        const payload = await handleProductResponse(response);
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "success", title: "Producto creado", text: payload.message || "Producto registrado", timer: 1800, showConfirmButton: false });
        }
        const createdRow = appendProductToList(payload, config.lineaInput?.value || "", config.segmentoInput?.value || "");
        if (editSelect) {
          const option = new Option(`${payload.cod_producto} - ${payload.descripcion}`, payload.id, false, false);
          option.dataset.cod = payload.cod_producto || "";
          option.dataset.desc = payload.descripcion || "";
          option.dataset.linea = config.lineaInput?.value || "";
          option.dataset.segmento = config.segmentoInput?.value || "";
          option.dataset.precio1 = parseFloat(inventoryCsOnly ? (payload.precio_venta1 || 0) : (payload.precio_venta1_usd || 0)).toFixed(2);
          option.dataset.precio2 = "0.00";
          option.dataset.precio3 = "0.00";
          option.dataset.costo = parseFloat(inventoryCsOnly ? (payload.costo_cs || 0) : (payload.costo_usd || 0)).toFixed(2);
          option.dataset.activo = "1";
          editSelect.append(option);
        }
        config.form.reset();
        if (window.$ && $.fn.select2 && config.form.id === "ingreso-product-form") {
          $(newProductLinea).val(null).trigger("change");
          $(newProductSegmento).val(null).trigger("change");
        }
        if (config.codeInput) {
          config.codeInput.focus();
          config.codeInput.select();
        }
        if (config.closeModal && quickProductModalEl && window.bootstrap?.Modal) {
          const instance = bootstrap.Modal.getOrCreateInstance(quickProductModalEl);
          instance.hide();
        }
        setIngresoTab("tab-ingreso");
        if (productSearch) {
          productSearch.value = (payload.cod_producto || "").toUpperCase();
          filterProductRows(productSearch.value);
          productSearch.focus();
        }
        const addBtn = createdRow?.querySelector(".add-item");
        if (addBtn && handleAddItem) {
          handleAddItem(addBtn, "search");
        }
      } catch (error) {
        console.error("Error creando producto", error);
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "error", title: "Error", text: error.message || "No se pudo guardar" });
        }
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML = previousLabel || "Crear producto";
        }
      }
    };

    ingresoProductForm.addEventListener("submit", (event) =>
      submitProductCreateForm(event, {
        form: ingresoProductForm,
        submitButton: createProductButton,
        codeInput: newProductCode,
        descInput: newProductDesc,
        lineaInput: newProductLinea,
        segmentoInput: newProductSegmento,
        marcaInput: newProductMarca,
        precioInput: newProductPrecio,
        costoInput: newProductCosto,
        closeModal: false,
      })
    );

    if (quickProductForm) {
      quickProductForm.addEventListener("submit", (event) =>
        submitProductCreateForm(event, {
          form: quickProductForm,
          submitButton: quickCreateProductButton,
          codeInput: quickProductCode,
          descInput: quickProductDesc,
          lineaInput: quickProductLinea,
          segmentoInput: quickProductSegmento,
          marcaInput: quickProductMarca,
          precioInput: quickProductPrecio,
          costoInput: quickProductCosto,
          closeModal: true,
        })
      );
    }
  }

  if (quickLineaForm) {
    quickLineaCreateBtn?.addEventListener("click", async () => {
      const previous = quickLineaCreateBtn ? quickLineaCreateBtn.innerHTML : "";
      try {
        const lineaName = (quickLineaName?.value || "").trim();
        if (!lineaName) {
          throw new Error("Nombre de linea requerido");
        }
        if (quickLineaCreateBtn) {
          quickLineaCreateBtn.disabled = true;
          quickLineaCreateBtn.innerHTML = "Guardando...";
        }
        const formData = new FormData();
        formData.set("linea", lineaName);
        formData.set("activo", "on");
        formData.set("redirect_to", "/inventory/ingresos");
        const response = await fetch("/inventory/linea", {
          method: "POST",
          headers: { "X-Requested-With": "fetch", "Accept": "application/json" },
          body: formData,
        });
        const payload = await handleCatalogResponse(response);
        const option = new Option(payload.linea, payload.id, true, true);
        if (quickProductLinea) {
          quickProductLinea.append(option);
          quickProductLinea.value = String(payload.id);
        }
        if (newProductLinea) {
          const optionMain = new Option(payload.linea, payload.id, false, false);
          newProductLinea.append(optionMain);
        }
        if (quickLineaName) quickLineaName.value = "";
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "success", title: "Linea creada", timer: 1200, showConfirmButton: false });
        }
      } catch (error) {
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "error", title: "Error", text: error.message || "No se pudo crear la linea" });
        }
      } finally {
        if (quickLineaCreateBtn) {
          quickLineaCreateBtn.disabled = false;
          quickLineaCreateBtn.innerHTML = previous || "Guardar linea";
        }
      }
    });
  }

  if (quickProveedorCreateBtn) {
    quickProveedorCreateBtn.addEventListener("click", async () => {
      const previous = quickProveedorCreateBtn.innerHTML;
      try {
        const nombre = (quickProveedorName?.value || "").trim();
        const tipo = (quickProveedorTipo?.value || "").trim();
        if (!nombre) {
          throw new Error("Nombre del proveedor requerido");
        }
        quickProveedorCreateBtn.disabled = true;
        quickProveedorCreateBtn.innerHTML = "Guardando...";
        const formData = new FormData();
        formData.set("nombre", nombre);
        formData.set("tipo", tipo);
        if (quickProveedorActivo?.checked) {
          formData.set("activo", "on");
        }
        formData.set("redirect_to", "/inventory/ingresos");
        const response = await fetch("/inventory/proveedor", {
          method: "POST",
          headers: { "X-Requested-With": "fetch", "Accept": "application/json" },
          body: formData,
        });
        const payload = await handleProveedorResponse(response);
        upsertProveedorOption(editProveedorSelect, payload, false);
        upsertProveedorOption(proveedorField, payload, true);
        if (quickProveedorName) quickProveedorName.value = "";
        if (quickProveedorTipo) quickProveedorTipo.value = "";
        if (quickProveedorActivo) quickProveedorActivo.checked = true;
        if (quickNewProveedorWrap) quickNewProveedorWrap.classList.add("d-none");
        if (quickToggleProveedor) quickToggleProveedor.setAttribute("aria-expanded", "false");
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "success", title: "Proveedor guardado", timer: 1400, showConfirmButton: false });
        }
      } catch (error) {
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "error", title: "Error", text: error.message || "No se pudo guardar" });
        }
      } finally {
        quickProveedorCreateBtn.disabled = false;
        quickProveedorCreateBtn.innerHTML = previous || "Guardar proveedor";
      }
    });
  }

  if (quickSegmentoForm) {
    quickSegmentoCreateBtn?.addEventListener("click", async () => {
      const previous = quickSegmentoCreateBtn ? quickSegmentoCreateBtn.innerHTML : "";
      try {
        const segmentoName = (quickSegmentoName?.value || "").trim();
        if (!segmentoName) {
          throw new Error("Nombre de segmento requerido");
        }
        if (quickSegmentoCreateBtn) {
          quickSegmentoCreateBtn.disabled = true;
          quickSegmentoCreateBtn.innerHTML = "Guardando...";
        }
        const formData = new FormData();
        formData.set("segmento", segmentoName);
        formData.set("redirect_to", "/inventory/ingresos");
        const response = await fetch("/inventory/segmento", {
          method: "POST",
          headers: { "X-Requested-With": "fetch", "Accept": "application/json" },
          body: formData,
        });
        const payload = await handleCatalogResponse(response);
        const option = new Option(payload.segmento, payload.id, true, true);
        if (quickProductSegmento) {
          quickProductSegmento.append(option);
          quickProductSegmento.value = String(payload.id);
        }
        if (newProductSegmento) {
          const optionMain = new Option(payload.segmento, payload.id, false, false);
          newProductSegmento.append(optionMain);
        }
        if (quickSegmentoName) quickSegmentoName.value = "";
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "success", title: "Segmento creado", timer: 1200, showConfirmButton: false });
        }
      } catch (error) {
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "error", title: "Error", text: error.message || "No se pudo crear el segmento" });
        }
      } finally {
        if (quickSegmentoCreateBtn) {
          quickSegmentoCreateBtn.disabled = false;
          quickSegmentoCreateBtn.innerHTML = previous || "Guardar segmento";
        }
      }
    });
  }

  if (quickMarcaForm) {
    quickMarcaCreateBtn?.addEventListener("click", async () => {
      const previous = quickMarcaCreateBtn ? quickMarcaCreateBtn.innerHTML : "";
      try {
        const marcaName = (quickMarcaName?.value || "").trim();
        if (!marcaName) {
          throw new Error("Nombre de marca requerido");
        }
        if (quickMarcaCreateBtn) {
          quickMarcaCreateBtn.disabled = true;
          quickMarcaCreateBtn.innerHTML = "Guardando...";
        }
        const formData = new FormData();
        formData.set("nombre", marcaName);
        formData.set("redirect_to", "/inventory/ingresos");
        const response = await fetch("/inventory/marca", {
          method: "POST",
          headers: { "X-Requested-With": "fetch", "Accept": "application/json" },
          body: formData,
        });
        const payload = await handleCatalogResponse(response);
        const option = new Option(payload.nombre, payload.nombre, true, true);
        if (quickProductMarca) {
          quickProductMarca.append(option);
          quickProductMarca.value = payload.nombre;
        }
        if (newProductMarca) {
          const optionMain = new Option(payload.nombre, payload.nombre, false, false);
          newProductMarca.append(optionMain);
        }
        if (quickMarcaName) quickMarcaName.value = "";
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "success", title: "Marca creada", timer: 1200, showConfirmButton: false });
        }
      } catch (error) {
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "error", title: "Error", text: error.message || "No se pudo crear la marca" });
        }
      } finally {
        if (quickMarcaCreateBtn) {
          quickMarcaCreateBtn.disabled = false;
          quickMarcaCreateBtn.innerHTML = previous || "Guardar marca";
        }
      }
    });
  }

  if (editForm) {
    editForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      try {
        const response = await fetch(editForm.action, {
          method: "POST",
          headers: { "X-Requested-With": "fetch", "Accept": "application/json" },
          body: new FormData(editForm),
        });
        const payload = await handleProductResponse(response);
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "success", title: "Producto actualizado", text: payload.message || "Actualizacion exitosa", timer: 1800, showConfirmButton: false });
        }
      } catch (error) {
        console.error("Error actualizando producto", error);
        if (typeof Swal !== "undefined") {
          Swal.fire({ icon: "error", title: "Error", text: error.message || "No se pudo guardar" });
        }
      }
    });
  }

  if (monedaField) {
    monedaField.addEventListener("change", () => {
      if (itemsTable) {
        itemsTable.innerHTML = `<tr id="empty-items"><td colspan="6" class="text-center py-3 text-slate">Sin items agregados</td></tr>`;
      }
      updateTotals();
    });
  }

  const filterProductRows = (value) => {
    const normalized = value.toLowerCase().trim();
    productList.querySelectorAll(".product-pick-row").forEach((row) => {
      if (!normalized) {
        row.style.display = "none";
        return;
      }
      const payload = `${row.dataset.code} ${row.dataset.name}`.toLowerCase();
      row.style.display = payload.includes(normalized) ? "" : "none";
    });
  };

  const updateBodegaBanner = () => {
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    const banner = document.getElementById("bodega-banner");
    if (!bodegaField || !banner) return;
    const selectedName = bodegaField.options[bodegaField.selectedIndex]?.text || "Central";
    banner.innerHTML = `<i class="bi bi-house-door"></i><span class="fw-semibold">Ingreso de mercaderia en Bodega ${selectedName}</span>`;
  };

  const syncBodegaGate = () => {
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    if (!productSearch || !bodegaField) return;
    const hasBodega = !!bodegaField.value;
    productSearch.disabled = !hasBodega;
    if (!hasBodega) {
      productSearch.value = "";
      filterProductRows("");
      updateBodegaBanner();
      return;
    }
    updateSaldoCells();
    updateBodegaBanner();
  };

  if (productSearch) {
    productSearch.addEventListener("input", (event) => {
      const value = event.target.value.toLowerCase().trim();
      updateSaldoCells();
      filterProductRows(value);
    });
    productSearch.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      event.preventDefault();
      const firstVisible = Array.from(productList.querySelectorAll(".product-pick-row"))
        .find((row) => row.style.display !== "none");
      if (!firstVisible) return;
      const qtyInput = firstVisible.querySelector(".qty-input");
      if (qtyInput) {
        qtyInput.focus();
        qtyInput.select();
      }
    });
  }

  const addItemRow = (payload) => {
    if (emptyItems) {
      emptyItems.remove();
    }
    const row = document.createElement("tr");
    row.dataset.itemRow = "1";
    row.dataset.subtotalUsd = payload.subtotalUsd.toFixed(2);
    row.dataset.subtotalCs = payload.subtotalCs.toFixed(2);
    row.innerHTML = `
      <td class="px-3 py-2">${payload.code} - ${payload.name}</td>
      <td class="px-3 py-2 text-right">
        <input class="row-qty w-20 rounded-lg border border-slate-200 px-2 py-1 text-right bg-white" type="number" step="${payload.qtyStep}" min="1" value="${payload.qtyValueDisplay}" />
      </td>
      <td class="px-3 py-2 text-right">
        <input class="row-cost w-24 rounded-lg border border-slate-200 px-2 py-1 text-right" type="number" step="0.01" min="0" value="${payload.costValue}" name="item_costo" />
      </td>
      <td class="px-3 py-2 text-right">
        <input class="row-price w-24 rounded-lg border border-slate-200 px-2 py-1 text-right" type="number" step="0.01" min="0" value="${payload.priceValue}" name="item_precio" />
      </td>
      <td class="px-3 py-2 text-right">${payload.subtotalLabel}</td>
      <td class="px-3 py-2 text-center">
        <button class="remove-item text-red-600" type="button"><i class="bi bi-x-circle"></i></button>
      </td>
      <input type="hidden" name="item_producto_id" value="${payload.productId}" />
      <input type="hidden" name="item_cantidad" value="${payload.qtyValue}" />
    `;
    itemsTable.appendChild(row);
    updateTotals();
    const focusTarget = payload.focusTarget || "qty";
    itemsTable.querySelectorAll(".row-active").forEach((el) => el.classList.remove("row-active"));
    row.classList.add("row-active");
    if (focusTarget === "search") {
      return;
    }
    if (focusTarget === "cost") {
      const costInput = row.querySelector(".row-cost");
      if (costInput) {
        costInput.focus();
        costInput.select();
      }
      return;
    }
    const qtyInput = row.querySelector(".row-qty");
    if (qtyInput) {
      qtyInput.focus();
      qtyInput.select();
    }
  };

  const parseQty = (value) => {
    const raw = parseFloat(value || 0);
    if (!allowDecimals || !allowDecimals.checked) {
      return Math.max(1, Math.round(raw));
    }
    return raw;
  };

  const formatQtyLabel = (qty) => {
    if (!allowDecimals || !allowDecimals.checked) {
      return Math.trunc(qty).toString();
    }
    return qty.toFixed(2);
  };

  if (allowDecimals) {
    allowDecimals.addEventListener("change", () => {
      productList.querySelectorAll(".qty-input").forEach((input) => {
        if (allowDecimals.checked) {
          input.step = "0.01";
        } else {
          input.step = "1";
          input.value = Math.max(1, Math.round(parseFloat(input.value || 1)));
        }
      });
      itemsTable.querySelectorAll(".row-qty").forEach((input) => {
        if (allowDecimals.checked) {
          input.step = "0.01";
        } else {
          input.step = "1";
          input.value = Math.max(1, Math.round(parseFloat(input.value || 1)));
        }
      });
    });
  }

  if (productList) {
    handleAddItem = (button, focusTarget) => {
      const row = button.closest("tr");
      const qtyInput = row.querySelector(".qty-input");
      const qty = parseQty(qtyInput.value);
      if (qty <= 0) return;

      const moneda = monedaField.value || defaultMoneda;
      const costUsd = parseFloat(button.dataset.costUsd || 0);
      const costCs = parseFloat(button.dataset.costCs || 0);
      const priceUsd = parseFloat(button.dataset.priceUsd || 0);
      const priceCs = parseFloat(button.dataset.priceCs || 0);
      const cost = moneda === "USD" ? costUsd : costCs;
      const price = moneda === "USD" ? priceUsd : priceCs;
      const subtotal = cost * qty;
      const subtotalUsd = moneda === "USD" ? subtotal : (rateToday ? subtotal / rateToday : 0);
      const subtotalCs = moneda === "USD" ? subtotal * rateToday : subtotal;

      addItemRow({
        productId: button.dataset.productId,
        code: button.dataset.code,
        name: button.dataset.name,
        qtyLabel: formatQtyLabel(qty),
        qtyValue: allowDecimals && allowDecimals.checked ? qty.toFixed(2) : Math.trunc(qty).toFixed(2),
        qtyValueDisplay: allowDecimals && allowDecimals.checked ? qty.toFixed(2) : Math.trunc(qty).toString(),
        qtyStep: allowDecimals && allowDecimals.checked ? "0.01" : "1",
        costValue: cost.toFixed(2),
        priceValue: price.toFixed(2),
        subtotalLabel: moneda === "USD" ? `$ ${subtotal.toFixed(2)}` : `C$ ${subtotal.toFixed(2)}`,
        subtotalUsd,
        subtotalCs,
        focusTarget: focusTarget || "qty",
      });
      if (productSearch && focusTarget === "search") {
        productSearch.value = "";
        productSearch.focus();
      }
      saveDraft();
    };

    productList.querySelectorAll(".add-item").forEach((button) => {
      button.addEventListener("click", (event) => {
        handleAddItem(event.currentTarget, "search");
      });
    });

    productList.querySelectorAll(".qty-input").forEach((input) => {
      input.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          const row = input.closest("tr");
          const button = row.querySelector(".add-item");
          if (button) {
            handleAddItem(button, "cost");
          }
        }
      });
    });
  }

  if (itemsTable) {
    itemsTable.addEventListener("click", (event) => {
      const button = event.target.closest(".remove-item");
      if (!button) return;
      const row = button.closest("tr");
      row.remove();
      if (itemsTable.querySelectorAll("tr[data-item-row]").length === 0) {
        itemsTable.innerHTML = `<tr id="empty-items"><td colspan="6" class="text-center py-3 text-slate">Sin items agregados</td></tr>`;
      }
      updateTotals();
      saveDraft();
    });
    itemsTable.addEventListener("focusin", (event) => {
      const row = event.target.closest("tr");
      if (!row || !row.dataset.itemRow) return;
      itemsTable.querySelectorAll(".row-active").forEach((el) => el.classList.remove("row-active"));
      row.classList.add("row-active");
    });
    itemsTable.addEventListener("input", (event) => {
      const row = event.target.closest("tr");
      if (!row) return;
      const qtyInput = row.querySelector(".row-qty");
      const costInput = row.querySelector(".row-cost");
      if (!qtyInput && !costInput) return;
      const qtyHidden = row.querySelector("input[name='item_cantidad']");
      const qty = parseFloat(qtyInput ? qtyInput.value : (qtyHidden ? qtyHidden.value : 0));
      const cost = parseFloat(costInput ? costInput.value : 0);
      if (qtyHidden && qtyInput) {
        qtyHidden.value = allowDecimals && allowDecimals.checked ? qty.toFixed(2) : Math.trunc(qty).toFixed(2);
      }
      const subtotal = cost * qty;
      const moneda = monedaField.value || defaultMoneda;
      row.dataset.subtotalUsd = moneda === "USD" ? subtotal.toFixed(2) : (rateToday ? (subtotal / rateToday).toFixed(2) : "0.00");
      row.dataset.subtotalCs = moneda === "USD" ? (subtotal * rateToday).toFixed(2) : subtotal.toFixed(2);
      const subtotalCell = row.querySelectorAll("td")[4];
      subtotalCell.textContent = moneda === "USD" ? `$ ${subtotal.toFixed(2)}` : `C$ ${subtotal.toFixed(2)}`;
      updateTotals();
      saveDraft();
    });
    itemsTable.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      const qtyInput = event.target.closest(".row-qty");
      const costInput = event.target.closest(".row-cost");
      const priceInput = event.target.closest(".row-price");
      if (qtyInput) {
        event.preventDefault();
        const row = qtyInput.closest("tr");
        const nextCost = row.querySelector(".row-cost");
        if (nextCost) {
          nextCost.focus();
          nextCost.select();
        }
        return;
      }
      if (costInput) {
        event.preventDefault();
        const row = costInput.closest("tr");
        const nextPrice = row.querySelector(".row-price");
        if (nextPrice) {
          nextPrice.focus();
          nextPrice.select();
        }
        return;
      }
      if (priceInput) {
        event.preventDefault();
        if (productSearch) {
          productSearch.value = "";
          productSearch.focus();
        }
      }
    });
  }

  if (ingresoForm) {
    ingresoForm.addEventListener("input", saveDraft);
    ingresoForm.addEventListener("change", saveDraft);
    ingresoForm.addEventListener("submit", () => {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch {}
    });
  }

  const validateIngresoRequired = () => {
    const missing = [];
    if (!tipoField?.value) missing.push("Tipo de ingreso");
    if (!fechaField?.value) missing.push("Fecha");
    const bodegaField = ingresoForm?.querySelector("select[name='bodega_id']");
    if (!bodegaField?.value) missing.push("Bodega");
    const option = tipoField?.options[tipoField.selectedIndex];
    const label = option ? (option.textContent || "").toLowerCase() : "";
    const requiere =
      (option && option.dataset.requiereProveedor === "1") ||
      label.includes("compra") ||
      label.includes("import");
    if (requiere && !proveedorField?.value) missing.push("Proveedor");
    if (missing.length) {
      const errorBanner = document.getElementById("ingreso-client-error");
      if (errorBanner) {
        errorBanner.textContent = `Faltan: ${missing.join(", ")}`;
        errorBanner.classList.remove("d-none");
      }
      if (typeof Swal !== "undefined") {
        Swal.fire({
          icon: "warning",
          title: "Campos obligatorios",
          text: `Faltan: ${missing.join(", ")}`,
        });
      } else {
        alert(`Faltan: ${missing.join(", ")}`);
      }
      return false;
    }
    const errorBanner = document.getElementById("ingreso-client-error");
    if (errorBanner) {
      errorBanner.classList.add("d-none");
      errorBanner.textContent = "";
    }
    return true;
  };

  if (ingresoForm) {
    ingresoForm.addEventListener("submit", (event) => {
      const itemsCount = itemsTable?.querySelectorAll("tr[data-item-row]").length || 0;
      if (!itemsCount) {
        event.preventDefault();
        const errorBanner = document.getElementById("ingreso-client-error");
        if (errorBanner) {
          errorBanner.textContent = "Agrega productos al ingreso antes de registrar.";
          errorBanner.classList.remove("d-none");
        }
        if (typeof Swal !== "undefined") {
          Swal.fire({
            icon: "warning",
            title: "Ingreso vacio",
            text: "Agrega productos al ingreso antes de registrar.",
          });
        } else {
          alert("Agrega productos al ingreso antes de registrar.");
        }
        return;
      }
      if (!validateIngresoRequired()) {
        event.preventDefault();
        return;
      }
    });
  }

  const submitIngresoButton = document.getElementById("submit-ingreso");
  if (submitIngresoButton && ingresoForm) {
    submitIngresoButton.addEventListener("click", (event) => {
      event.preventDefault();
      ingresoForm.requestSubmit();
    });
  }

  if (createProductButton && ingresoProductForm) {
    createProductButton.addEventListener("click", () => {
      ingresoProductForm.requestSubmit();
    });
  }

  if (newProductCode) {
    newProductCode.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      event.preventDefault();
      newProductDesc?.focus();
      newProductDesc?.select();
    });
  }

  if (newProductDesc) {
    newProductDesc.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      event.preventDefault();
      focusSelect(newProductLinea);
    });
  }

  if (newProductLinea) {
    newProductLinea.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      event.preventDefault();
      focusSelect(newProductSegmento);
    });
    if (window.$ && $.fn.select2) {
      $(newProductLinea).on("select2:select", () => focusSelect(newProductSegmento));
    }
  }

  if (newProductSegmento) {
    newProductSegmento.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      event.preventDefault();
      newProductPrecio?.focus();
      newProductPrecio?.select();
    });
    if (window.$ && $.fn.select2) {
      $(newProductSegmento).on("select2:select", () => {
        newProductPrecio?.focus();
        newProductPrecio?.select();
      });
    }
  }

  if (newProductPrecio) {
    newProductPrecio.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      event.preventDefault();
      newProductCosto?.focus();
      newProductCosto?.select();
    });
  }

  if (newProductCosto) {
    newProductCosto.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      event.preventDefault();
      ingresoProductForm?.requestSubmit();
    });
  }

  const clearDraftButton = document.getElementById("clear-draft");
  if (clearDraftButton) {
    clearDraftButton.addEventListener("click", () => {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch {}
      if (ingresoForm) {
        ingresoForm.reset();
        if (window.$ && $.fn.select2) {
          $(".select2").val(null).trigger("change");
        }
      }
      if (itemsTable) {
        itemsTable.innerHTML = `<tr id="empty-items"><td colspan="6" class="text-center py-3 text-slate">Sin items agregados</td></tr>`;
      }
      updateTotals();
      if (productSearch) {
        productSearch.value = "";
        productSearch.focus();
      }
    });
  }

  window.addEventListener("beforeunload", saveDraft);
</script>
{% endblock %}
